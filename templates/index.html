<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dust Free Products - Management Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ¨</text></svg">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #111827; color: #f3f4f6; }
        .bg-gray-900 { background-color: #111827; }
        .bg-gray-800 { background-color: #1f2937; }
        .bg-gray-700 { background-color: #374151; }
        .bg-gray-600 { background-color: #4b5563; }
        .border-gray-700 { border-color: #374151; }
        .border-gray-600 { border-color: #4b5563; }
        .text-gray-100 { color: #f3f4f6; }
        .text-gray-300 { color: #d1d5db; }
        .text-gray-400 { color: #9ca3af; }
        .text-gray-500 { color: #6b7280; }
        .chat-message { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .typing-indicator::after { content: '...'; animation: dots 1.5s infinite; }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        .gantt-bar { transition: all 0.3s ease; }
        .gantt-bar:hover { transform: scaleY(1.1); filter: brightness(1.2); }
        .category-customers { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .category-transport { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .category-suppliers { background: linear-gradient(90deg, #10b981, #34d399); }
        .category-taxation { background: linear-gradient(90deg, #8b5cf6, #a78bfa); }
        .category-legal { background: linear-gradient(90deg, #ef4444, #f87171); }
        .category-internal { background: linear-gradient(90deg, #6b7280, #9ca3af); }
        .category-other { background: linear-gradient(90deg, #64748b, #94a3b8); }
        .read-checkbox { cursor: pointer; transition: all 0.2s; }
        .read-checkbox:hover { transform: scale(1.2); }
        .email-read { opacity: 0.6; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <i class="fas fa-paint-roller text-2xl text-blue-500"></i>
                <h1 class="text-xl font-bold">DF - Management Dashboard</h1>
            </div>
            <div id="stats" class="flex items-center space-x-4 text-sm">
                <span class="text-gray-400"><i class="fas fa-clock mr-1"></i>UK: <span id="british-clock">--:--:--</span></span>
                <span class="text-gray-500 text-xs">RONâ†’EUR @ 4.97</span>
                <span class="text-gray-400"><i class="fas fa-envelope mr-2"></i><span id="total-emails">-</span> Emails</span>
                <span class="text-gray-400"><i class="fas fa-users mr-2"></i><span id="total-contacts">-</span> Contacts</span>
                <div class="flex items-center space-x-2">
                    <button onclick="startSync()" id="sync-btn" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-medium transition flex items-center space-x-2" title="Sync with IMAP server">
                        <i class="fas fa-sync-alt" id="sync-icon"></i>
                        <span id="sync-text">Sync</span>
                    </button>
                    <span id="last-sync-date" class="text-xs text-gray-500">Never synced</span>
                </div>
                <button onclick="showTab('search')" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-medium transition flex items-center space-x-2" title="Search emails">
                    <i class="fas fa-search"></i>
                    <span>Search</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div id="main-container" class="mx-auto px-6 py-6">
        <!-- Tab Navigation -->
        <div class="flex space-x-4 mb-6 flex-wrap gap-2 items-center">
            <button onclick="showTab('chat')" id="tab-chat" class="tab-btn px-4 py-2 rounded-lg bg-blue-600 text-white font-medium transition">
                <i class="fas fa-comments mr-2"></i>Ask Questions
            </button>
            <button onclick="showTab('invoices')" id="tab-invoices" class="tab-btn px-4 py-2 rounded-lg bg-gray-700 text-gray-300 font-medium transition hover:bg-gray-600">
                <i class="fas fa-file-invoice-dollar mr-2"></i>Supplier and Accounting
            </button>
            <button onclick="showTab('production')" id="tab-production" class="tab-btn px-4 py-2 rounded-lg bg-gray-700 text-gray-300 font-medium transition hover:bg-gray-600">
                <i class="fas fa-industry mr-2"></i>Production
            </button>
            <button onclick="showTab('calendar')" id="tab-calendar" class="tab-btn px-4 py-2 rounded-lg bg-gray-700 text-gray-300 font-medium transition hover:bg-gray-600">
                <i class="fas fa-calendar-alt mr-2"></i>Calendar
            </button>
            <div class="w-px h-8 bg-gray-600"></div>
            <button onclick="showTab('relationships')" id="tab-relationships" class="tab-btn px-4 py-2 rounded-lg bg-gray-700 text-gray-300 font-medium transition hover:bg-gray-600">
                <i class="fas fa-project-diagram mr-2"></i>Relationships
            </button>
            <button onclick="showTab('emails')" id="tab-emails" class="tab-btn px-4 py-2 rounded-lg bg-gray-700 text-gray-300 font-medium transition hover:bg-gray-600">
                <i class="fas fa-inbox mr-2"></i>Emails
            </button>
        </div>

        <!-- Chat Tab -->
        <div id="panel-chat" class="tab-panel">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Chat Area -->
                <div class="lg:col-span-2 bg-gray-800 rounded-xl border border-gray-700 flex flex-col h-[600px]">
                    <div class="p-4 border-b border-gray-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="font-semibold"><i class="fas fa-robot mr-2 text-blue-500"></i>Jimmy - AI Assistant</h2>
                                <p class="text-sm text-gray-400">Ask questions about emails, invoices, products, and all your data</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="toggleGreekMode()" id="greek-mode-btn" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs" title="Toggle Greek language">
                                    ðŸ‡¬ðŸ‡· Î•Î»Î»Î·Î½Î¹ÎºÎ¬
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Messages -->
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                        <div class="chat-message bg-gray-700 rounded-lg p-4">
                            <div class="flex items-start space-x-3">
                                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                                    <i class="fas fa-robot text-sm"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-blue-400">Jimmy</p>
                                    <p class="text-gray-300 mt-1">Hello! I'm Jimmy, your AI assistant. I can search through all your data - emails, invoices, products, production runs, and more. Try asking:</p>
                                    <ul class="text-gray-400 text-sm mt-2 space-y-1">
                                        <li>â€¢ What orders need urgent attention?</li>
                                        <li>â€¢ Who are the main contacts at JTAPE?</li>
                                        <li>â€¢ What is the status of the Australia shipment?</li>
                                        <li>â€¢ What issues are pending with DTC?</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Input -->
                    <div class="p-4 border-t border-gray-700">
                        <form id="chat-form" class="flex space-x-3">
                            <input type="text" id="question-input" 
                                class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500"
                                placeholder="Ask a question about your emails...">
                            <button type="submit" id="send-btn" 
                                class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-medium transition">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Suggested Questions -->
                <div class="bg-gray-800 rounded-xl border border-gray-700 p-4 h-fit">
                    <h3 id="quick-questions-title" class="font-semibold mb-4"><i class="fas fa-lightbulb mr-2 text-yellow-500"></i>Quick Questions</h3>
                    <div id="quick-questions-container" class="space-y-2">
                        <button onclick="askQuickQuestion('urgent')" 
                            class="w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition quick-q" data-key="urgent">
                            <i class="fas fa-exclamation-triangle mr-2 text-red-400"></i><span>Urgent issues</span>
                        </button>
                        <button onclick="askQuickQuestion('pending')" 
                            class="w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition quick-q" data-key="pending">
                            <i class="fas fa-clipboard-list mr-2 text-green-400"></i><span>Pending orders</span>
                        </button>
                        <button onclick="askQuickQuestion('shipments')" 
                            class="w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition quick-q" data-key="shipments">
                            <i class="fas fa-shipping-fast mr-2 text-blue-400"></i><span>Active shipments</span>
                        </button>
                        <button onclick="askQuickQuestion('payments')" 
                            class="w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition quick-q" data-key="payments">
                            <i class="fas fa-dollar-sign mr-2 text-yellow-400"></i><span>Payment status</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- All Emails Tab -->
        <div id="panel-emails" class="tab-panel hidden">
            <div class="bg-gray-800 rounded-xl border border-gray-700">
                <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                    <div>
                        <h2 class="font-semibold"><i class="fas fa-inbox mr-2 text-blue-500"></i>All Emails <span id="email-count" class="text-gray-400 font-normal text-sm ml-2"></span></h2>
                        <p class="text-sm text-gray-400">All emails sorted by date received. Click checkbox to mark as read.</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <select id="email-folder-filter" onchange="filterEmailList()" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm text-gray-300 focus:outline-none focus:border-blue-500">
                            <option value="all">All Emails</option>
                            <option value="inbox">Inbox Only</option>
                            <option value="sent">Sent Only</option>
                        </select>
                        <label class="flex items-center space-x-2 text-sm text-gray-400">
                            <input type="checkbox" id="hide-read" onchange="filterEmailList()" class="rounded">
                            <span>Hide read</span>
                        </label>
                        <input type="text" id="email-filter" 
                            class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-sm placeholder-gray-400 focus:outline-none focus:border-blue-500"
                            placeholder="Filter emails..." onkeyup="filterEmailList()">
                    </div>
                </div>
                
                <div id="emails-list" class="divide-y divide-gray-700 max-h-[600px] overflow-y-auto">
                    <div class="p-8 text-center text-gray-400">
                        <i class="fas fa-spinner fa-spin text-2xl"></i>
                        <p class="mt-2">Loading emails...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Tab -->
        <div id="panel-calendar" class="tab-panel hidden">
            <div class="bg-gray-800 rounded-xl border border-gray-700">
                <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                    <div>
                        <h2 class="font-semibold"><i class="fas fa-calendar-alt mr-2 text-blue-500"></i>Google Calendar</h2>
                        <p class="text-sm text-gray-400">Tasks and events from your calendar</p>
                    </div>
                    <button onclick="refreshCalendar()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
                <div class="p-4">
                    <div id="calendar-auth-section" class="text-center py-8">
                        <i class="fas fa-calendar-check text-4xl text-gray-500 mb-4"></i>
                        <p class="text-gray-400 mb-4">Connect your Google Calendar to view tasks and events</p>
                        <button onclick="connectGoogleCalendar()" class="px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-medium">
                            <i class="fab fa-google mr-2"></i>Connect Google Calendar
                        </button>
                    </div>
                    <div id="calendar-content" class="hidden">
                        <div class="flex justify-end mb-4">
                            <button onclick="disconnectCalendar()" class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm">
                                <i class="fas fa-unlink mr-1"></i>Disconnect
                            </button>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Tasks Panel -->
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h3 class="font-semibold mb-4"><i class="fas fa-tasks mr-2 text-yellow-500"></i>Dust Free Tasks</h3>
                                <div id="calendar-tasks" class="space-y-2 max-h-[500px] overflow-y-auto">
                                    <p class="text-gray-500 text-sm">Loading tasks...</p>
                                </div>
                            </div>
                            <!-- Monthly Calendar View -->
                            <div class="lg:col-span-2 bg-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-4">
                                    <button onclick="changeCalendarMonth(-1)" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <h3 class="font-semibold text-lg" id="calendar-month-title">
                                        <i class="fas fa-calendar-alt mr-2 text-blue-500"></i>December 2025
                                    </h3>
                                    <button onclick="changeCalendarMonth(1)" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                                <!-- Calendar Grid -->
                                <div class="grid grid-cols-7 gap-1 text-center text-xs mb-2">
                                    <div class="font-semibold text-gray-400 py-2">Sun</div>
                                    <div class="font-semibold text-gray-400 py-2">Mon</div>
                                    <div class="font-semibold text-gray-400 py-2">Tue</div>
                                    <div class="font-semibold text-gray-400 py-2">Wed</div>
                                    <div class="font-semibold text-gray-400 py-2">Thu</div>
                                    <div class="font-semibold text-gray-400 py-2">Fri</div>
                                    <div class="font-semibold text-gray-400 py-2">Sat</div>
                                </div>
                                <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                                    <!-- Calendar days will be rendered here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Relationship Chart Tab -->
        <div id="panel-relationships" class="tab-panel hidden">
            <!-- Sub-tabs for Timeline vs Organization view -->
            <div class="flex space-x-2 mb-4">
                <button onclick="showRelationshipView('timeline')" id="rel-tab-timeline" class="rel-tab-btn px-4 py-2 rounded-lg bg-purple-600 text-white font-medium text-sm">
                    <i class="fas fa-chart-gantt mr-2"></i>Timeline View
                </button>
                <button onclick="showRelationshipView('org')" id="rel-tab-org" class="rel-tab-btn px-4 py-2 rounded-lg bg-gray-700 text-gray-300 font-medium text-sm hover:bg-gray-600">
                    <i class="fas fa-sitemap mr-2"></i>Organization Map
                </button>
                <button onclick="showRelationshipView('manage')" id="rel-tab-manage" class="rel-tab-btn px-4 py-2 rounded-lg bg-gray-700 text-gray-300 font-medium text-sm hover:bg-gray-600">
                    <i class="fas fa-cog mr-2"></i>Manage Organizations
                </button>
            </div>

            <!-- Timeline View -->
            <div id="rel-view-timeline" class="bg-gray-800 rounded-xl border border-gray-700">
                <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                    <div>
                        <h2 class="font-semibold"><i class="fas fa-project-diagram mr-2 text-purple-500"></i>Entity Timeline</h2>
                        <p class="text-sm text-gray-400">Scroll horizontally to see the full timeline up to today</p>
                    </div>
                    <button onclick="scrollToToday()" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-sm">
                        <i class="fas fa-calendar-day mr-1"></i>Jump to Today
                    </button>
                </div>
                
                <!-- Legend -->
                <div class="p-4 border-b border-gray-700 flex flex-wrap gap-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-4 h-4 rounded category-customers"></div>
                        <span class="text-sm">Customers</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-4 h-4 rounded category-transport"></div>
                        <span class="text-sm">Transport/Logistics</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-4 h-4 rounded category-suppliers"></div>
                        <span class="text-sm">Suppliers</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-4 h-4 rounded category-taxation"></div>
                        <span class="text-sm">Taxation/Finance</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-4 h-4 rounded category-legal"></div>
                        <span class="text-sm">Legal</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-4 h-4 rounded category-other"></div>
                        <span class="text-sm">Other</span>
                    </div>
                </div>
                
                <div id="gantt-chart" class="p-4 overflow-x-auto" style="max-height: 600px; overflow-y: auto;">
                    <div class="p-8 text-center text-gray-400">
                        <i class="fas fa-spinner fa-spin text-2xl"></i>
                        <p class="mt-2">Loading relationship data...</p>
                    </div>
                </div>
            </div>

            <!-- Organization Map View -->
            <div id="rel-view-org" class="hidden bg-gray-800 rounded-xl border border-gray-700">
                <div class="p-4 border-b border-gray-700">
                    <h2 class="font-semibold"><i class="fas fa-sitemap mr-2 text-purple-500"></i>Organization Map</h2>
                    <p class="text-sm text-gray-400">All organizations grouped by their relationship to DFW Professional</p>
                </div>
                
                <div id="org-map" class="p-6">
                    <div class="p-8 text-center text-gray-400">
                        <i class="fas fa-spinner fa-spin text-2xl"></i>
                        <p class="mt-2">Loading organization data...</p>
                    </div>
                </div>
            </div>

            <!-- Manage Organizations View -->
            <div id="rel-view-manage" class="hidden bg-gray-800 rounded-xl border border-gray-700">
                <div class="p-4 border-b border-gray-700">
                    <h2 class="font-semibold"><i class="fas fa-cog mr-2 text-purple-500"></i>Manage Organizations</h2>
                    <p class="text-sm text-gray-400">Edit organization details, categories, and view associated files</p>
                </div>
                
                <div class="p-4">
                    <input type="text" id="org-search" 
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 mb-4"
                        placeholder="Search organizations..." oninput="filterOrganizations()">
                </div>
                
                <div id="org-manage-list" class="p-4 space-y-3 max-h-[600px] overflow-y-auto">
                    <div class="p-8 text-center text-gray-400">
                        <i class="fas fa-spinner fa-spin text-2xl"></i>
                        <p class="mt-2">Loading organizations...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Invoices Tab -->
        <div id="panel-invoices" class="tab-panel hidden">
            <div class="bg-gray-800 rounded-xl border border-gray-700">
                <!-- Summary Cards - Shows totals for currently selected tab -->
                <div class="p-4 border-b border-gray-700">
                    <h2 class="font-semibold mb-4"><i class="fas fa-file-invoice-dollar mr-2 text-green-500"></i>Invoice Dashboard</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4" id="invoice-summary">
                        <div class="bg-gray-700 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold text-green-400" id="inv-pdf-count">-</div>
                            <div class="text-sm text-gray-400">Attachments</div>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold text-blue-400" id="inv-total-eur">-</div>
                            <div class="text-sm text-gray-400">Total (EUR)</div>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold text-yellow-400" id="inv-year-total">-</div>
                            <div class="text-sm text-gray-400">Year <span id="current-year">2025</span> Total</div>
                        </div>
                    </div>
                </div>
                
                <!-- Invoice Sub-tabs -->
                <div class="p-4 border-b border-gray-700 flex flex-wrap gap-2 items-center">
                    <!-- Primary: My Invoices and Pro Forma -->
                    <button onclick="showInvoiceSubTab('dfw')" id="inv-subtab-dfw" class="inv-subtab px-4 py-2 rounded-lg bg-green-600 text-white font-medium transition">
                        <i class="fas fa-file-invoice mr-2"></i>My Invoices
                    </button>
                    <button onclick="showInvoiceSubTab('proforma')" id="inv-subtab-proforma" class="inv-subtab px-4 py-2 rounded-lg bg-gray-700 text-gray-300 font-medium transition hover:bg-gray-600">
                        <i class="fas fa-file-alt mr-2"></i>Pro Forma
                    </button>
                    <button onclick="showInvoiceSubTab('all')" id="inv-subtab-all" class="inv-subtab px-4 py-2 rounded-lg bg-gray-700 text-gray-300 font-medium transition hover:bg-gray-600">
                        <i class="fas fa-paperclip mr-2"></i>All Attachments
                    </button>
                    <!-- Spacer 1 -->
                    <div class="w-px h-8 bg-gray-600 mx-2"></div>
                    <!-- Supplier and Accounting -->
                    <button onclick="showInvoiceSubTab('supplier')" id="inv-subtab-supplier" class="inv-subtab px-4 py-2 rounded-lg bg-gray-700 text-gray-300 font-medium transition hover:bg-gray-600">
                        <i class="fas fa-truck-loading mr-2"></i>Supplier
                    </button>
                    <button onclick="showInvoiceSubTab('contrast')" id="inv-subtab-contrast" class="inv-subtab px-4 py-2 rounded-lg bg-gray-700 text-gray-300 font-medium transition hover:bg-gray-600">
                        <i class="fas fa-calculator mr-2"></i>Accounting
                    </button>
                    <!-- Spacer 2 -->
                    <div class="w-px h-8 bg-gray-600 mx-2"></div>
                    <!-- Client tabs (auto-generated from production) -->
                    <button onclick="showInvoiceSubTab('jtape')" id="inv-subtab-jtape" class="inv-subtab px-4 py-2 rounded-lg bg-gray-700 text-gray-300 font-medium transition hover:bg-gray-600">
                        <i class="fas fa-tape mr-2"></i>JTape
                    </button>
                    <button onclick="showInvoiceSubTab('amba')" id="inv-subtab-amba" class="inv-subtab px-4 py-2 rounded-lg bg-gray-700 text-gray-300 font-medium transition hover:bg-gray-600">
                        <i class="fas fa-box mr-2"></i>Amba/BAXT
                    </button>
                    <!-- Dynamic client tabs will be inserted here by JS -->
                    <span id="dynamic-client-tabs"></span>
                </div>
                
                <!-- All Invoices Panel -->
                <div id="inv-panel-all" class="inv-subpanel">
                    <!-- Filter and Search -->
                    <div class="p-4 border-b border-gray-700 flex flex-wrap gap-3 items-center">
                        <input type="text" id="invoice-search" 
                            class="flex-1 min-w-[200px] bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-green-500"
                            placeholder="Search invoices..." oninput="filterInvoices()">
                        <select id="invoice-tab-filter" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" onchange="filterInvoices()">
                            <option value="all">All Tabs</option>
                            <option value="unassigned">Unassigned</option>
                            <option value="dfw">My Invoices</option>
                            <option value="jtape">JTape</option>
                            <option value="amba">Amba/BAXT</option>
                            <option value="supplier">Supplier</option>
                            <option value="contrast">Contrast</option>
                            <option value="proforma">Pro Forma</option>
                        </select>
                        <button onclick="openInvoiceRules()" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-medium flex items-center gap-2">
                            <i class="fas fa-info-circle"></i>
                            <span>Tab Rules</span>
                        </button>
                    </div>
                    
                    <!-- Invoice Table -->
                    <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-700 text-gray-300 sticky top-0">
                                <tr>
                                    <th class="px-2 py-3 text-left">Date</th>
                                    <th class="px-2 py-3 text-left">Invoice #</th>
                                    <th class="px-2 py-3 text-right">Amount</th>
                                    <th class="px-2 py-3 text-left">Sender</th>
                                    <th class="px-2 py-3 text-left">File</th>
                                    <th class="px-2 py-3 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="invoice-table-body" class="divide-y divide-gray-700">
                                <tr>
                                    <td colspan="6" class="px-4 py-8 text-center text-gray-400">
                                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                        <p>Loading invoices...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination info -->
                    <div class="p-4 border-t border-gray-700 text-sm text-gray-400" id="invoice-pagination">
                        Showing all attachments
                    </div>
                </div>
                
                <!-- My Invoices Panel (DFW Professional SRL) -->
                <div id="inv-panel-dfw" class="inv-subpanel hidden">
                    <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                        <p class="text-gray-400 text-sm"><i class="fas fa-info-circle mr-2"></i>Invoices issued by DFW PROFESSIONAL SRL - both "INVOICE No" and "FACTURA" formats</p>
                        <div class="flex gap-2">
                            <button onclick="loadDfwInvoices()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-sm" title="Refresh invoices">
                                <i class="fas fa-sync-alt mr-1"></i>Refresh
                            </button>
                            <a href="/invoice" target="_blank" class="px-4 py-1.5 bg-green-600 hover:bg-green-700 rounded text-sm font-medium inline-flex items-center gap-2">
                                <i class="fas fa-plus"></i>Create New Invoice
                            </a>
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-700 text-gray-300 sticky top-0">
                                <tr>
                                    <th class="px-4 py-3 text-left">Invoice No</th>
                                    <th class="px-4 py-3 text-left">Date</th>
                                    <th class="px-4 py-3 text-right">Amount</th>
                                    <th class="px-4 py-3 text-left">Customer</th>
                                    <th class="px-4 py-3 text-left">File</th>
                                    <th class="px-4 py-3 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="dfw-invoice-table" class="divide-y divide-gray-700">
                                <tr>
                                    <td colspan="6" class="px-4 py-8 text-center text-gray-400">
                                        <i class="fas fa-spinner fa-spin text-2xl"></i>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t border-gray-700 text-sm text-gray-400" id="dfw-invoice-count">-</div>
                </div>
                
                <!-- JTape Invoices Panel -->
                <div id="inv-panel-jtape" class="inv-subpanel hidden">
                    <div class="p-4 border-b border-gray-700">
                        <p class="text-gray-400 text-sm"><i class="fas fa-info-circle mr-2"></i>Invoices related to JTape Limited</p>
                    </div>
                    <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-700 text-gray-300 sticky top-0">
                                <tr>
                                    <th class="px-2 py-3 text-left">Date</th>
                                    <th class="px-2 py-3 text-left">Invoice #</th>
                                    <th class="px-2 py-3 text-right">Amount</th>
                                    <th class="px-2 py-3 text-left">Sender</th>
                                    <th class="px-2 py-3 text-left">File</th>
                                    <th class="px-2 py-3 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="jtape-invoice-table" class="divide-y divide-gray-700">
                                <tr>
                                    <td colspan="6" class="px-4 py-8 text-center text-gray-400">
                                        <i class="fas fa-spinner fa-spin text-2xl"></i>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t border-gray-700 text-sm text-gray-400" id="jtape-invoice-count">-</div>
                </div>
                
                <!-- Amba Group Invoices Panel -->
                <div id="inv-panel-amba" class="inv-subpanel hidden">
                    <div class="p-4 border-b border-gray-700">
                        <p class="text-gray-400 text-sm"><i class="fas fa-info-circle mr-2"></i>Invoices related to Amba Group</p>
                    </div>
                    <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-700 text-gray-300 sticky top-0">
                                <tr>
                                    <th class="px-2 py-3 text-left">Date</th>
                                    <th class="px-2 py-3 text-left">Invoice #</th>
                                    <th class="px-2 py-3 text-right">Amount</th>
                                    <th class="px-2 py-3 text-left">Sender</th>
                                    <th class="px-2 py-3 text-left">File</th>
                                    <th class="px-2 py-3 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="amba-invoice-table" class="divide-y divide-gray-700">
                                <tr>
                                    <td colspan="6" class="px-4 py-8 text-center text-gray-400">
                                        <i class="fas fa-spinner fa-spin text-2xl"></i>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t border-gray-700 text-sm text-gray-400" id="amba-invoice-count">-</div>
                </div>
                
                <!-- Supplier Invoices Panel -->
                <div id="inv-panel-supplier" class="inv-subpanel hidden">
                    <div class="p-4 border-b border-gray-700">
                        <p class="text-gray-400 text-sm"><i class="fas fa-info-circle mr-2"></i>Invoices from Rotopak IKE (Supplier)</p>
                    </div>
                    <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-700 text-gray-300 sticky top-0">
                                <tr>
                                    <th class="px-2 py-3 text-left">Date</th>
                                    <th class="px-2 py-3 text-left">Invoice #</th>
                                    <th class="px-2 py-3 text-right">Amount</th>
                                    <th class="px-2 py-3 text-left">Sender</th>
                                    <th class="px-2 py-3 text-left">File</th>
                                    <th class="px-2 py-3 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="supplier-invoice-table" class="divide-y divide-gray-700">
                                <tr>
                                    <td colspan="6" class="px-4 py-8 text-center text-gray-400">
                                        <i class="fas fa-spinner fa-spin text-2xl"></i>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t border-gray-700 text-sm text-gray-400" id="supplier-invoice-count">-</div>
                </div>
                
                <!-- Contrast Accountancy Invoices Panel -->
                <div id="inv-panel-contrast" class="inv-subpanel hidden">
                    <div class="p-4 border-b border-gray-700">
                        <p class="text-gray-400 text-sm"><i class="fas fa-info-circle mr-2"></i>FACTURA FISCALÄ‚ from Contrast Accountancy SRL (Accounting invoices)</p>
                    </div>
                    <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-700 text-gray-300 sticky top-0">
                                <tr>
                                    <th class="px-2 py-3 text-left">Date</th>
                                    <th class="px-2 py-3 text-left">Invoice #</th>
                                    <th class="px-2 py-3 text-right">Amount</th>
                                    <th class="px-2 py-3 text-left">Sender</th>
                                    <th class="px-2 py-3 text-left">File</th>
                                    <th class="px-2 py-3 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="contrast-invoice-table" class="divide-y divide-gray-700">
                                <tr>
                                    <td colspan="6" class="px-4 py-8 text-center text-gray-400">
                                        <i class="fas fa-spinner fa-spin text-2xl"></i>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t border-gray-700 text-sm text-gray-400" id="contrast-invoice-count">-</div>
                </div>
                
                <!-- Pro Forma Invoices Panel -->
                <div id="inv-panel-proforma" class="inv-subpanel hidden">
                    <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                        <p class="text-gray-400 text-sm"><i class="fas fa-info-circle mr-2"></i>Pro Forma Invoices (Quotes)</p>
                        <div class="flex gap-2">
                            <button onclick="loadSavedProformas()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-sm" title="Load saved pro formas">
                                <i class="fas fa-sync-alt mr-1"></i>Refresh
                            </button>
                            <a href="/proforma" target="_blank" class="px-4 py-1.5 bg-green-600 hover:bg-green-700 rounded text-sm font-medium inline-flex items-center gap-2">
                                <i class="fas fa-plus"></i>Create New Pro Forma
                            </a>
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-700 text-gray-300 sticky top-0">
                                <tr>
                                    <th class="px-4 py-3 text-left">Date</th>
                                    <th class="px-4 py-3 text-left">Proforma #</th>
                                    <th class="px-4 py-3 text-left">Filename</th>
                                    <th class="px-4 py-3 text-right">Amount</th>
                                    <th class="px-4 py-3 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="proforma-invoice-table" class="divide-y divide-gray-700">
                                <tr>
                                    <td colspan="5" class="px-4 py-8 text-center text-gray-400">
                                        <i class="fas fa-spinner fa-spin text-2xl"></i>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t border-gray-700 text-sm text-gray-400" id="proforma-invoice-count">-</div>
                </div>
                
                <!-- Dynamic Client Panels Container (auto-generated from production clients) -->
                <div id="dynamic-client-panels"></div>
            </div>
        </div>

        <!-- Production Tab -->
        <div id="panel-production" class="tab-panel hidden">
            <!-- Order Timeline (full width) -->
            <div class="bg-gray-800 rounded-xl border border-gray-700 mb-6">
                <div class="p-4 border-b border-gray-700">
                    <h2 class="font-semibold"><i class="fas fa-calendar-alt mr-2 text-blue-500"></i>Order Timeline (ETA)</h2>
                    <p class="text-xs text-gray-500 mt-1">Active orders by expected delivery month (excludes completed/failed)</p>
                </div>
                
                <div id="order-timeline-container" class="p-4 overflow-x-auto">
                    <div id="timeline-months" class="flex gap-2 min-w-max">
                        <div class="p-4 text-center text-gray-400">
                            <i class="fas fa-spinner fa-spin"></i> Loading timeline...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Production Runs Table -->
            <div class="bg-gray-800 rounded-xl border border-gray-700">
                <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                    <h2 class="font-semibold"><i class="fas fa-cogs mr-2 text-green-500"></i>Production Runs</h2>
                    <div class="flex gap-2">
                        <button onclick="loadProductsAndClients().then(() => openManageProductsModal())" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-medium text-sm" title="Manage Products">
                            <i class="fas fa-box mr-1"></i>Products
                        </button>
                        <button onclick="loadProductsAndClients().then(() => openManageClientsModal())" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium text-sm" title="Manage Clients">
                            <i class="fas fa-users mr-1"></i>Clients
                        </button>
                        <button onclick="openAddProductionRun()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-medium text-sm">
                            <i class="fas fa-plus mr-1"></i>New Run
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-xs">
                        <thead class="bg-gray-700 text-gray-300">
                            <tr>
                                <th class="px-2 py-2 text-left">Client</th>
                                <th class="px-2 py-2 text-left">Order Ref</th>
                                <th class="px-2 py-2 text-left">Product</th>
                                <th class="px-2 py-2 text-center">Qty</th>
                                <th class="px-2 py-2 text-right" title="Client price per roll">Price</th>
                                <th class="px-2 py-2 text-right" title="Our cost per roll">Cost</th>
                                <th class="px-2 py-2 text-left">ETA</th>
                                <th class="px-2 py-2 text-left">Ordered</th>
                                <th class="px-2 py-2 text-center" title="Downpayment Paid">DP</th>
                                <th class="px-2 py-2 text-left">Prod Start</th>
                                <th class="px-2 py-2 text-left">Prod End</th>
                                <th class="px-2 py-2 text-left">Warehouse</th>
                                <th class="px-2 py-2 text-center" title="Paid Off">Paid</th>
                                <th class="px-2 py-2 text-left">Delivered</th>
                                <th class="px-2 py-2 text-left">Status</th>
                                <th class="px-2 py-2 text-left">Notes</th>
                                <th class="px-2 py-2 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="production-runs-table" class="divide-y divide-gray-700">
                            <tr>
                                <td colspan="16" class="px-4 py-8 text-center text-gray-400">
                                    <i class="fas fa-box-open text-2xl mb-2"></i>
                                    <p>No production runs recorded yet</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Production Feedback Section (below runs) -->
            <div class="mt-6 bg-gray-800 rounded-xl border border-gray-700">
                <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                    <h2 class="font-semibold"><i class="fas fa-clipboard-check mr-2 text-orange-500"></i>Production Feedback</h2>
                    <button onclick="openAddFeedback()" class="px-3 py-1 bg-orange-600 hover:bg-orange-700 rounded-lg font-medium text-xs">
                        <i class="fas fa-plus mr-1"></i>Add Feedback
                    </button>
                </div>
                
                <div id="production-feedback-list" class="divide-y divide-gray-700 max-h-[250px] overflow-y-auto">
                    <div class="p-6 text-center text-gray-400">
                        <i class="fas fa-clipboard text-3xl mb-2"></i>
                        <p class="text-sm">No feedback yet</p>
                    </div>
                </div>
            </div>
            
            <!-- Production Files Section -->
            <div class="mt-6 bg-gray-800 rounded-xl border border-gray-700">
                <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                    <h2 class="font-semibold"><i class="fas fa-folder-open mr-2 text-purple-500"></i>Production Files</h2>
                    <button onclick="openUploadProductionFile()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-medium text-sm">
                        <i class="fas fa-upload mr-1"></i>Upload File
                    </button>
                </div>
                
                <div class="p-4">
                    <div class="flex flex-wrap gap-2 mb-4">
                        <select id="production-files-client" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-sm" onchange="loadProductionFiles()">
                            <option value="">All Clients</option>
                        </select>
                    </div>
                    
                    <div id="production-files-list" class="max-h-[300px] overflow-y-auto">
                        <div class="p-4 text-center text-gray-400">
                            <i class="fas fa-folder text-3xl mb-2"></i>
                            <p class="text-sm">No production files yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Tab -->
        <div id="panel-search" class="tab-panel hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Main Search -->
                <div class="lg:col-span-2 bg-gray-800 rounded-xl border border-gray-700">
                    <div class="p-4 border-b border-gray-700">
                        <h2 class="font-semibold mb-4"><i class="fas fa-search mr-2 text-purple-500"></i>Search Emails</h2>
                        
                        <!-- Search Type Toggle -->
                        <div class="flex gap-2 mb-3">
                            <button onclick="setSearchType('keyword')" id="search-type-keyword" class="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium">
                                <i class="fas fa-font mr-1"></i>Keyword
                            </button>
                            <button onclick="setSearchType('semantic')" id="search-type-semantic" class="px-4 py-2 bg-gray-700 text-gray-300 rounded-lg text-sm font-medium hover:bg-gray-600">
                                <i class="fas fa-brain mr-1"></i>Semantic (AI)
                            </button>
                        </div>
                        
                        <div class="flex space-x-3">
                            <input type="text" id="search-input" 
                                class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500"
                                placeholder="Search emails by subject, sender, or content...">
                            <button onclick="searchEmails()" 
                                class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-medium transition">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                        
                        <p class="text-xs text-gray-500 mt-2" id="search-hint">Exact keyword matching</p>
                    </div>
                    
                    <div id="search-results" class="divide-y divide-gray-700 max-h-[500px] overflow-y-auto">
                        <div class="p-8 text-center text-gray-400">
                            <i class="fas fa-search text-4xl mb-3"></i>
                            <p>Enter a search term to find emails</p>
                        </div>
                    </div>
                </div>
                
                <!-- ChromaDB Status Panel -->
                <div class="bg-gray-800 rounded-xl border border-gray-700 h-fit">
                    <div class="p-4 border-b border-gray-700">
                        <h3 class="font-semibold flex items-center gap-2">
                            <i class="fas fa-database text-green-400"></i>
                            Vector Database
                        </h3>
                    </div>
                    <div class="p-4 space-y-4">
                        <div class="bg-gray-700 rounded-lg p-3">
                            <div class="text-xs text-gray-400 mb-1">Status</div>
                            <div id="chromadb-status" class="text-sm font-medium text-yellow-400">
                                <i class="fas fa-spinner fa-spin mr-1"></i>Loading...
                            </div>
                        </div>
                        
                        <div class="bg-gray-700 rounded-lg p-3">
                            <div class="text-xs text-gray-400 mb-1">Emails Indexed</div>
                            <div id="chromadb-email-count" class="text-2xl font-bold text-blue-400">-</div>
                        </div>
                        
                        <button onclick="indexEmails()" id="index-btn" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-medium transition">
                            <i class="fas fa-sync-alt mr-2"></i>Index Emails
                        </button>
                        
                        <div class="text-xs text-gray-500 leading-relaxed">
                            <strong>Semantic Search</strong> uses AI to understand meaning, not just keywords. It finds similar content even if different words are used.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden File Upload Inputs -->
    <input type="file" id="feedback-file-input" accept="image/*" class="hidden" onchange="uploadFeedbackFile(event)">
    <input type="file" id="production-file-input" accept="*/*" class="hidden" onchange="uploadProductionFile(event)">
    <input type="file" id="org-file-input" accept="*/*" class="hidden" onchange="uploadOrgFile(event)">
    
    <!-- Production File Upload Modal -->
    <div id="production-upload-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeProductionUploadModal()"></div>
        <div class="relative max-w-md mx-auto my-20 bg-gray-900 border border-gray-700 rounded-2xl shadow-2xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-white"><i class="fas fa-upload mr-2 text-purple-400"></i>Upload Production File</h3>
                <button onclick="closeProductionUploadModal()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Client</label>
                    <select id="upload-client-select" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                        <option value="">Select client...</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Description (optional)</label>
                    <input type="text" id="upload-file-desc" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" placeholder="File description...">
                </div>
                
                <button onclick="triggerProductionFileUpload()" class="w-full px-4 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-medium">
                    <i class="fas fa-file-upload mr-2"></i>Select File to Upload
                </button>
            </div>
        </div>
    </div>
    
    <!-- Org File Upload Modal (z-[60] to appear above org-files-modal) -->
    <div id="org-upload-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeOrgUploadModal()"></div>
        <div class="relative max-w-md mx-auto my-20 bg-gray-900 border border-gray-700 rounded-2xl shadow-2xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-white"><i class="fas fa-upload mr-2 text-blue-400"></i>Upload Organization File</h3>
                <button onclick="closeOrgUploadModal()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <input type="hidden" id="upload-org-domain">
            <p id="upload-org-name" class="text-gray-300 mb-4"></p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Description (optional)</label>
                    <input type="text" id="upload-org-file-desc" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" placeholder="File description...">
                </div>
                
                <button onclick="triggerOrgFileUpload()" class="w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium">
                    <i class="fas fa-file-upload mr-2"></i>Select File to Upload
                </button>
            </div>
        </div>
    </div>

    <!-- Add Production Run Modal -->
    <div id="add-run-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeAddRunModal()"></div>
        <div class="relative max-w-2xl mx-auto my-4 bg-gray-900 border border-gray-700 rounded-2xl shadow-2xl flex flex-col" style="max-height: calc(100vh - 2rem);">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-800">
                <h3 class="text-lg font-semibold"><i class="fas fa-plus-circle mr-2 text-green-500"></i>Add Production Run</h3>
                <button onclick="closeAddRunModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-4">
                <!-- Client Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Client</label>
                    <div class="flex gap-2">
                        <select id="run-client-select" class="flex-1 bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white" onchange="updateRunPriceFromSelection()">
                            <option value="">-- Select Client --</option>
                        </select>
                        <button onclick="openManageClientsModal()" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg" title="Manage Clients">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                    <input type="text" id="run-client-manual" class="mt-2 w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white" placeholder="Or type client name manually...">
                </div>
                
                <!-- Product Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Product</label>
                    <div class="flex gap-2">
                        <select id="run-product-select" class="flex-1 bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white" onchange="updateRunPriceFromSelection()">
                            <option value="">-- Select Product --</option>
                        </select>
                        <button onclick="openManageProductsModal()" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg" title="Manage Products">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                    <input type="text" id="run-product-manual" class="mt-2 w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white" placeholder="Or type product name manually...">
                </div>
                
                <!-- Price Per Roll -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Price Per Roll (â‚¬) <span class="text-gray-500 text-xs">(client price)</span></label>
                    <input type="number" id="run-price-per-roll" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white" placeholder="Auto-filled from client pricing" step="0.01">
                    <p class="text-xs text-gray-500 mt-1" id="price-source-hint">Select client and product to auto-fill</p>
                </div>
                
                <!-- Cost Per Roll (our cost) -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Cost Per Roll (â‚¬) <span class="text-gray-500 text-xs">(our cost)</span></label>
                    <input type="number" id="run-cost-per-roll" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white" placeholder="Enter our cost per roll" step="0.01">
                </div>
                
                <!-- Order Reference -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Order Reference</label>
                    <select id="run-orderref-select" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white mb-2">
                        <option value="">-- Select from Pro Forma Invoices --</option>
                    </select>
                    <input type="text" id="run-orderref-manual" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white" placeholder="Or type order reference manually...">
                </div>
                
                <!-- Quantity -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Quantity</label>
                    <input type="number" id="run-quantity" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white" placeholder="Enter quantity">
                </div>
                
                <!-- ETA Month -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">ETA Month (Expected Delivery)</label>
                    <input type="month" id="run-eta-month" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white">
                </div>
                
                <!-- Date Ordered -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Date Ordered</label>
                    <input type="date" id="run-date-ordered" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white">
                </div>
                
                <!-- Notes -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Notes</label>
                    <textarea id="run-notes" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white" rows="2" placeholder="Optional notes..."></textarea>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-800 flex justify-end gap-3">
                <button onclick="closeAddRunModal()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg">Cancel</button>
                <button onclick="submitProductionRun()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-medium">
                    <i class="fas fa-save mr-2"></i>Save Run
                </button>
            </div>
        </div>
    </div>

    <!-- Add Feedback Modal -->
    <div id="add-feedback-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeFeedbackModal()"></div>
        <div class="relative max-w-xl mx-auto my-10 bg-gray-900 border border-gray-700 rounded-2xl shadow-2xl">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-800">
                <h3 class="text-lg font-semibold"><i class="fas fa-clipboard-check mr-2 text-orange-500"></i>Add Production Feedback</h3>
                <button onclick="closeFeedbackModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Title *</label>
                    <input type="text" id="feedback-title" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white" placeholder="Feedback title...">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Description</label>
                    <textarea id="feedback-description" rows="3" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white" placeholder="Describe the feedback..."></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Date</label>
                        <input type="date" id="feedback-date" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Status</label>
                        <select id="feedback-status" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white">
                            <option value="pending">Pending</option>
                            <option value="resolved">Resolved</option>
                            <option value="issue">Issue</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Upload Files</label>
                    <input type="file" id="feedback-files" multiple class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm file:mr-4 file:py-1 file:px-3 file:rounded file:border-0 file:bg-orange-600 file:text-white file:cursor-pointer">
                    <p class="text-xs text-gray-500 mt-1">You can select multiple files</p>
                </div>
                <div id="feedback-file-preview" class="space-y-1"></div>
            </div>
            <div class="px-6 py-4 border-t border-gray-800 flex justify-end gap-3">
                <button onclick="closeFeedbackModal()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg font-medium">Cancel</button>
                <button onclick="submitFeedback()" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 rounded-lg font-medium">
                    <i class="fas fa-save mr-2"></i>Save Feedback
                </button>
            </div>
        </div>
    </div>

    <!-- Manage Products Modal -->
    <div id="manage-products-modal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeManageProductsModal()"></div>
        <div class="relative max-w-3xl mx-auto my-10 bg-gray-900 border border-gray-700 rounded-2xl shadow-2xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold"><i class="fas fa-box mr-2 text-purple-500"></i>Manage Products</h3>
                <button onclick="closeManageProductsModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="mb-4 space-y-2">
                <div class="flex gap-2">
                    <input type="text" id="new-product-name" class="flex-1 bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white" placeholder="Product name...">
                    <input type="text" id="new-product-description" class="flex-1 bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm" placeholder="Description (for invoices)...">
                    <button onclick="addNewProduct()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg"><i class="fas fa-plus"></i></button>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="new-product-notes" class="flex-1 bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm" placeholder="Notes...">
                </div>
            </div>
            <div id="products-list" class="max-h-60 overflow-y-auto space-y-2 mb-4">
                <p class="text-gray-500 text-sm">Loading products...</p>
            </div>
            
            <!-- Client-Specific Pricing Section -->
            <div class="border-t border-gray-700 pt-4 mt-4">
                <h4 class="font-semibold mb-3"><i class="fas fa-tags mr-2 text-yellow-500"></i>Client-Specific Pricing</h4>
                <div class="flex gap-2 mb-3">
                    <select id="client-price-client" class="flex-1 bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm">
                        <option value="">Select Client...</option>
                    </select>
                    <select id="client-price-product" class="flex-1 bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm">
                        <option value="">Select Product...</option>
                    </select>
                    <input type="number" id="client-price-value" class="w-24 bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white" placeholder="Price â‚¬" step="0.01">
                    <button onclick="addClientPrice()" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg"><i class="fas fa-plus"></i></button>
                </div>
                <div id="client-prices-list" class="max-h-40 overflow-y-auto space-y-1">
                    <p class="text-gray-500 text-sm">No client-specific prices set</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Clients Modal -->
    <div id="manage-clients-modal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeManageClientsModal()"></div>
        <div class="relative max-w-md mx-auto my-20 bg-gray-900 border border-gray-700 rounded-2xl shadow-2xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold"><i class="fas fa-users mr-2 text-blue-500"></i>Manage Clients</h3>
                <button onclick="closeManageClientsModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="mb-4">
                <div class="flex gap-2">
                    <input type="text" id="new-client-name" class="flex-1 bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white" placeholder="New client name...">
                    <select id="new-client-country" class="w-24 bg-gray-800 border border-gray-600 rounded-lg px-2 py-2 text-white text-sm">
                        <option value="">Country</option>
                        <option value="UK">UK</option>
                        <option value="CH">CH</option>
                        <option value="AU">AU</option>
                        <option value="US">US</option>
                        <option value="DE">DE</option>
                        <option value="GR">GR</option>
                        <option value="RO">RO</option>
                        <option value="IT">IT</option>
                        <option value="FR">FR</option>
                    </select>
                    <button onclick="addNewClient()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div id="clients-list" class="max-h-60 overflow-y-auto space-y-2">
                <p class="text-gray-500 text-sm">Loading clients...</p>
            </div>
        </div>
    </div>

    <!-- Email Modal -->
    <div id="email-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 overflow-y-auto" onclick="closeModalOnBackdrop(event)">
        <div class="min-h-screen px-4 py-8 flex items-start justify-center">
            <div class="bg-gray-800 rounded-xl border border-gray-700 max-w-4xl w-full" onclick="event.stopPropagation()">
                <div class="p-4 border-b border-gray-700 flex items-center justify-between sticky top-0 bg-gray-800 rounded-t-xl z-10">
                    <div class="flex items-center gap-3">
                        <button onclick="navigateEmail(-1)" class="text-gray-400 hover:text-white px-2 py-1" title="Previous email (â†)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button onclick="navigateEmail(1)" class="text-gray-400 hover:text-white px-2 py-1" title="Next email (â†’)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <h3 class="font-semibold truncate" id="modal-subject">Email Details</h3>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="toggleCurrentEmailRead()" id="modal-read-btn" class="px-3 py-1 rounded bg-gray-700 hover:bg-gray-600 text-sm" title="Toggle read (R)">
                            <i class="far fa-circle mr-1"></i><span>Mark Read</span>
                        </button>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-white flex-shrink-0 px-2">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div id="modal-content" class="p-6">
                </div>
            </div>
        </div>
    </div>

    <!-- Organization Edit Modal -->
    <div id="org-edit-modal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeOrgEditModal()"></div>
        <div class="relative max-w-lg mx-auto my-20 bg-gray-900 border border-gray-700 rounded-2xl shadow-2xl">
            <div class="flex items-center justify-between p-4 border-b border-gray-700">
                <h3 class="font-semibold" id="org-edit-title">
                    <i class="fas fa-building mr-2 text-blue-500"></i>Edit Organization
                </h3>
                <button onclick="closeOrgEditModal()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                <input type="hidden" id="org-edit-domain">
                <div>
                    <label class="text-xs text-gray-500 uppercase mb-1 block">Domain</label>
                    <p id="org-edit-domain-display" class="text-gray-400 font-mono"></p>
                </div>
                <div>
                    <label class="text-xs text-gray-500 uppercase mb-1 block">Display Name</label>
                    <input type="text" id="org-edit-name" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white" placeholder="Organization display name...">
                </div>
                <div>
                    <label class="text-xs text-gray-500 uppercase mb-1 block">Category / Type</label>
                    <select id="org-edit-category" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white">
                        <option value="customers">Customers</option>
                        <option value="transport">Transport</option>
                        <option value="suppliers">Suppliers</option>
                        <option value="taxation">Taxation</option>
                        <option value="legal">Legal</option>
                        <option value="internal">Internal</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-gray-500 uppercase mb-1 block">Related Organization</label>
                    <select id="org-edit-related" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white">
                        <option value="">None</option>
                    </select>
                    <div id="org-related-tags" class="flex flex-wrap gap-1 mt-2"></div>
                </div>
                <div>
                    <label class="text-xs text-gray-500 uppercase mb-1 block">Contacts</label>
                    <div id="org-contacts-list" class="max-h-32 overflow-y-auto space-y-1 mb-2">
                    </div>
                </div>
                <div>
                    <label class="text-xs text-gray-500 uppercase mb-1 block">Assigned Emails</label>
                    <div id="org-assigned-emails" class="max-h-24 overflow-y-auto space-y-1 mb-2">
                    </div>
                    <div class="relative">
                        <input type="text" id="org-email-search" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm" placeholder="Search and add email..." oninput="filterOrgEmailDropdown()">
                        <div id="org-email-dropdown" class="absolute z-10 w-full mt-1 bg-gray-800 border border-gray-600 rounded-lg max-h-32 overflow-y-auto hidden">
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-2 pt-4 border-t border-gray-700">
                    <button onclick="closeOrgEditModal()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg">Cancel</button>
                    <button onclick="saveOrgChanges()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Item Detail Modal -->
    <div id="calendar-detail-modal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeCalendarDetailModal()"></div>
        <div class="relative max-w-lg mx-auto my-20 bg-gray-900 border border-gray-700 rounded-2xl shadow-2xl">
            <div class="flex items-center justify-between p-4 border-b border-gray-700">
                <h3 class="font-semibold" id="calendar-detail-title">
                    <i class="fas fa-calendar mr-2 text-blue-500"></i>Details
                </h3>
                <button onclick="closeCalendarDetailModal()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="calendar-detail-content" class="p-6">
            </div>
        </div>
    </div>

    <script>
        let entitiesData = [];
        let allEmailsData = [];
        let currentEmailId = null;
        let currentEmailIndex = -1;
        let relationshipData = {};
        let invoicesData = { parsed_invoices: [], email_invoices: [], summary: {} };
        let organizationNames = {};
        let emailAssignments = {};
        let allOrganizations = [];
        let organizationRelationships = {};
        let availableEmails = [];

        // Load initial data
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadEntities();
            loadAllEmails();
            loadRelationships();
            loadInvoices();
            loadSyncStatus();
            loadProductsAndClients(); // Load clients for dynamic invoice tabs
            loadOrganizationData();
        });
        
        async function loadOrganizationData() {
            try {
                const [namesRes, assignmentsRes, orgsRes, relRes] = await Promise.all([
                    fetch('/api/organization/names'),
                    fetch('/api/organization/email_assignments'),
                    fetch('/api/organization/list'),
                    fetch('/api/organization/relationships')
                ]);
                organizationNames = await namesRes.json();
                emailAssignments = await assignmentsRes.json();
                allOrganizations = await orgsRes.json();
                organizationRelationships = await relRes.json();
            } catch (error) {
                console.error('Error loading organization data:', error);
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                document.getElementById('total-emails').textContent = data.total_emails;
                document.getElementById('total-contacts').textContent = data.unique_contacts;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadSyncStatus() {
            try {
                const response = await fetch('/api/sync/status');
                const status = await response.json();
                updateLastSyncDate(status.last_sync);
            } catch (error) {
                console.error('Error loading sync status:', error);
            }
        }

        function updateLastSyncDate(lastSync) {
            const dateElement = document.getElementById('last-sync-date');
            if (!lastSync) {
                dateElement.textContent = 'Never synced';
                dateElement.classList.add('text-red-500');
                dateElement.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>Never synced';
                return;
            }
            
            const date = new Date(lastSync);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            let timeAgo;
            if (diffMins < 1) {
                timeAgo = 'Just now';
            } else if (diffMins < 60) {
                timeAgo = `${diffMins}m ago`;
            } else if (diffHours < 24) {
                timeAgo = `${diffHours}h ago`;
            } else if (diffDays < 7) {
                timeAgo = `${diffDays}d ago`;
            } else {
                timeAgo = formatDateOnly(lastSync);
            }
            
            // Show warning if over 1 week old
            if (diffDays >= 7) {
                dateElement.classList.remove('text-gray-500');
                dateElement.classList.add('text-red-500');
                dateElement.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i>Last: ${timeAgo}`;
                dateElement.title = `Last sync was ${diffDays} days ago - consider syncing!\n${date.toLocaleString()}`;
            } else {
                dateElement.classList.remove('text-red-500');
                dateElement.classList.add('text-gray-500');
                dateElement.textContent = `Last: ${timeAgo}`;
                dateElement.title = date.toLocaleString();
            }
        }

        async function startSync() {
            const syncBtn = document.getElementById('sync-btn');
            const syncIcon = document.getElementById('sync-icon');
            const syncText = document.getElementById('sync-text');
            
            try {
                // Disable button and show spinning icon
                syncBtn.disabled = true;
                syncIcon.classList.add('fa-spin');
                syncText.textContent = 'Syncing...';
                
                const response = await fetch('/api/sync/start', { method: 'POST' });
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Sync failed');
                }
                
                // Poll for sync status
                const pollInterval = setInterval(async () => {
                    const statusResponse = await fetch('/api/sync/status');
                    const status = await statusResponse.json();
                    
                    syncText.textContent = status.message;
                    
                    if (!status.running) {
                        clearInterval(pollInterval);
                        syncIcon.classList.remove('fa-spin');
                        syncBtn.disabled = false;
                        syncText.textContent = 'Sync';
                        
                        // Reload data after successful sync
                        if (status.message.includes('successfully')) {
                            await loadStats();
                            await loadAllEmails();
                            await loadEntities();
                            updateLastSyncDate(status.last_sync);
                            alert('Sync completed! New emails and attachments have been downloaded.');
                        } else {
                            alert(status.message);
                        }
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Sync error:', error);
                syncIcon.classList.remove('fa-spin');
                syncBtn.disabled = false;
                syncText.textContent = 'Sync';
                alert('Sync failed: ' + error.message);
            }
        }

        async function loadEntities() {
            try {
                const response = await fetch('/api/entities');
                entitiesData = await response.json();
                renderEntities(entitiesData);
            } catch (error) {
                console.error('Error loading entities:', error);
            }
        }

        function renderEntities(entities) {
            const container = document.getElementById('entities-list');
            
            // Check if container exists before trying to render
            if (!container) {
                console.log('Entities container not found, skipping render');
                return;
            }
            
            if (!entities || entities.length === 0) {
                container.innerHTML = '<div class="p-8 text-center text-gray-400">No entities found</div>';
                return;
            }

            container.innerHTML = entities.map(entity => `
                <div class="p-4 hover:bg-gray-700/50 transition">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold">
                                    ${entity.name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h4 class="font-medium">${escapeHtml(entity.name)}</h4>
                                    <p class="text-sm text-gray-400">${escapeHtml(entity.email)}</p>
                                </div>
                            </div>
                            ${entity.orders.length > 0 ? `
                                <div class="mt-3 ml-13">
                                    <p class="text-xs text-gray-500 mb-2">Orders:</p>
                                    <div class="flex flex-wrap gap-2">
                                        ${entity.orders.slice(0, 5).map(order => `
                                            <div class="bg-gray-700 rounded-lg px-3 py-2 text-sm">
                                                <span class="font-mono text-blue-400">#${order.number}</span>
                                                <div class="flex gap-1 mt-1">
                                                    ${order.statuses.map(status => `
                                                        <span class="${getStatusClass(status)}">${status}</span>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        `).join('')}
                                        ${entity.orders.length > 5 ? `<span class="text-gray-500 text-sm self-center">+${entity.orders.length - 5} more</span>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="text-right text-sm">
                            <div class="text-gray-400">${entity.email_count} emails</div>
                            <div class="text-gray-500 text-xs mt-1">${entity.last_contact ? new Date(entity.last_contact).toLocaleDateString() : ''}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getStatusClass(status) {
            const classes = {
                'pending': 'bg-yellow-900 text-yellow-300 px-2 py-0.5 rounded text-xs',
                'shipped': 'bg-green-900 text-green-300 px-2 py-0.5 rounded text-xs',
                'cancelled': 'bg-red-900 text-red-300 px-2 py-0.5 rounded text-xs',
                'problem': 'bg-red-900 text-red-300 px-2 py-0.5 rounded text-xs',
                'confirmed': 'bg-blue-900 text-blue-300 px-2 py-0.5 rounded text-xs',
                'payment': 'bg-purple-900 text-purple-300 px-2 py-0.5 rounded text-xs',
                'unknown': 'bg-gray-600 text-gray-300 px-2 py-0.5 rounded text-xs'
            };
            return classes[status] || classes['unknown'];
        }

        function filterEntities() {
            const query = document.getElementById('entity-search').value.toLowerCase();
            const filtered = entitiesData.filter(e => 
                e.name.toLowerCase().includes(query) || 
                e.email.toLowerCase().includes(query) ||
                e.orders.some(o => o.number.includes(query))
            );
            renderEntities(filtered);
        }

        // Date formatting for Greek time (UTC+2) with time
        function formatGreekDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            // Convert to Greek time (UTC+2)
            const greekDate = new Date(date.getTime() + (2 * 60 * 60 * 1000));
            
            const day = greekDate.getUTCDate();
            const suffix = (day === 1 || day === 21 || day === 31) ? 'st' : 
                          (day === 2 || day === 22) ? 'nd' : 
                          (day === 3 || day === 23) ? 'rd' : 'th';
            
            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
            const month = months[greekDate.getUTCMonth()];
            const year = greekDate.getUTCFullYear();
            const hours = greekDate.getUTCHours().toString().padStart(2, '0');
            const minutes = greekDate.getUTCMinutes().toString().padStart(2, '0');
            
            return `${day}${suffix} ${month} ${year}, ${hours}:${minutes}`;
        }
        
        // Date formatting without time for invoices
        function formatDateOnly(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            
            const day = date.getDate();
            const suffix = (day === 1 || day === 21 || day === 31) ? 'st' : 
                          (day === 2 || day === 22) ? 'nd' : 
                          (day === 3 || day === 23) ? 'rd' : 'th';
            
            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            
            return `${day}${suffix} ${month} ${year}`;
        }
        
        // British time clock
        function updateBritishClock() {
            const now = new Date();
            const britishTime = now.toLocaleString('en-GB', { 
                timeZone: 'Europe/London',
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            const clockEl = document.getElementById('british-clock');
            if (clockEl) clockEl.textContent = britishTime;
        }
        
        // Start British clock
        setInterval(updateBritishClock, 1000);

        // All Emails functionality
        async function loadAllEmails() {
            try {
                const response = await fetch('/api/emails');
                allEmailsData = await response.json();
                renderEmailList(allEmailsData);
                // Update email count
                const countEl = document.getElementById('email-count');
                if (countEl) countEl.textContent = `(${allEmailsData.length})`;
                // Start clock
                updateBritishClock();
            } catch (error) {
                console.error('Error loading emails:', error);
            }
        }

        function renderEmailList(emails) {
            const container = document.getElementById('emails-list');
            
            if (emails.length === 0) {
                container.innerHTML = '<div class="p-8 text-center text-gray-400">No emails found</div>';
                return;
            }

            container.innerHTML = emails.map(email => {
                const isSent = (email.from_address || '').toLowerCase().includes('sales@dfwprofessional.eu');
                return `
                <div class="p-4 hover:bg-gray-700/50 transition flex items-center space-x-4 ${email.is_read ? 'email-read' : ''}" id="email-row-${email.id}">
                    <div class="read-checkbox" onclick="toggleReadStatus(${email.id}, event)">
                        ${email.is_read 
                            ? '<i class="fas fa-check-circle text-green-500 text-xl"></i>' 
                            : '<i class="far fa-circle text-gray-500 text-xl"></i>'}
                    </div>
                    <div class="flex-1 cursor-pointer" onclick="showEmail(${email.id})">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <h4 class="font-medium ${email.is_read ? 'text-gray-400' : 'text-white'}">${escapeHtml(email.subject || 'No subject')}</h4>
                                    ${isSent ? '<span class="px-2 py-0.5 bg-blue-600 text-white text-xs rounded">SENT</span>' : ''}
                                </div>
                                <p class="text-sm text-gray-400">${isSent ? '<i class="fas fa-paper-plane mr-1 text-blue-400"></i>To: ' + escapeHtml(email.to_address || '') : escapeHtml(email.from_address)}</p>
                            </div>
                            <span class="text-xs text-gray-500 ml-4">${formatGreekDate(email.date_received)}</span>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        async function toggleReadStatus(emailId, event) {
            event.stopPropagation();
            try {
                const response = await fetch(`/api/emails/${emailId}/read`, { method: 'POST' });
                const data = await response.json();
                
                // Update local data
                const email = allEmailsData.find(e => e.id === emailId);
                if (email) {
                    email.is_read = data.is_read;
                }
                
                // Update UI
                const row = document.getElementById(`email-row-${emailId}`);
                const checkbox = row.querySelector('.read-checkbox');
                const title = row.querySelector('h4');
                
                if (data.is_read) {
                    row.classList.add('email-read');
                    checkbox.innerHTML = '<i class="fas fa-check-circle text-green-500 text-xl"></i>';
                    title.classList.remove('text-white');
                    title.classList.add('text-gray-400');
                } else {
                    row.classList.remove('email-read');
                    checkbox.innerHTML = '<i class="far fa-circle text-gray-500 text-xl"></i>';
                    title.classList.remove('text-gray-400');
                    title.classList.add('text-white');
                }
            } catch (error) {
                console.error('Error toggling read status:', error);
            }
        }

        function filterEmailList() {
            const query = document.getElementById('email-filter').value.toLowerCase();
            const hideRead = document.getElementById('hide-read').checked;
            const folderFilter = document.getElementById('email-folder-filter').value;
            
            const filtered = allEmailsData.filter(e => {
                const matchesQuery = !query || 
                    (e.subject || '').toLowerCase().includes(query) || 
                    (e.from_address || '').toLowerCase().includes(query) ||
                    (e.to_address || '').toLowerCase().includes(query);
                const matchesRead = !hideRead || !e.is_read;
                
                // Check folder filter - identify sent by from_address being sales@dfwprofessional.eu
                const isSent = (e.from_address || '').toLowerCase().includes('sales@dfwprofessional.eu');
                let matchesFolder = true;
                if (folderFilter === 'inbox') {
                    matchesFolder = !isSent;
                } else if (folderFilter === 'sent') {
                    matchesFolder = isSent;
                }
                
                return matchesQuery && matchesRead && matchesFolder;
            });
            
            renderEmailList(filtered);
        }

        // Relationship Chart functionality
        async function loadRelationships() {
            try {
                const response = await fetch('/api/entity-relationships');
                relationshipData = await response.json();
                renderGanttChart(relationshipData);
            } catch (error) {
                console.error('Error loading relationships:', error);
            }
        }

        function renderGanttChart(data) {
            const container = document.getElementById('gantt-chart');
            
            // Find date range - extend to today
            let minDate = new Date();
            let maxDate = new Date(); // Today
            
            Object.values(data).forEach(entities => {
                entities.forEach(entity => {
                    if (entity.first_contact) {
                        const d = new Date(entity.first_contact);
                        if (d < minDate) minDate = d;
                    }
                });
            });
            
            const totalDays = Math.max(1, (maxDate - minDate) / (1000 * 60 * 60 * 24));
            const chartWidth = Math.max(1200, totalDays * 3);
            
            // Generate months for header
            const months = [];
            let currentMonth = new Date(minDate);
            currentMonth.setDate(1);
            while (currentMonth <= maxDate) {
                months.push(new Date(currentMonth));
                currentMonth.setMonth(currentMonth.getMonth() + 1);
            }
            
            let html = `<div id="gantt-inner" style="min-width: ${chartWidth}px;">`;
            
            // Month header (sticky) - Entity column is sticky left
            html += '<div class="flex border-b border-gray-700 mb-4 sticky top-0 bg-gray-800 z-20 py-2">';
            html += '<div class="w-64 flex-shrink-0 font-medium text-sm sticky left-0 bg-gray-800 z-30 pr-4">Entity</div>';
            html += '<div class="flex-1 flex">';
            months.forEach((month, idx) => {
                const isCurrentMonth = month.getMonth() === new Date().getMonth() && month.getFullYear() === new Date().getFullYear();
                html += `<div class="text-xs ${isCurrentMonth ? 'text-purple-400 font-bold' : 'text-gray-500'} border-l border-gray-700 px-2 flex-shrink-0" style="width: 80px;">${month.toLocaleDateString('en-US', { month: 'short', year: '2-digit' })}</div>`;
            });
            html += '</div></div>';
            
            // Today marker position
            const todayPercent = ((new Date() - minDate) / (1000 * 60 * 60 * 24)) / totalDays * 100;
            
            // Categories
            const categoryLabels = {
                customers: { label: 'Customers', icon: 'fa-users' },
                transport: { label: 'Transport & Logistics', icon: 'fa-truck' },
                suppliers: { label: 'Suppliers', icon: 'fa-industry' },
                taxation: { label: 'Taxation & Finance', icon: 'fa-calculator' },
                legal: { label: 'Legal', icon: 'fa-gavel' },
                internal: { label: 'Internal', icon: 'fa-building' },
                other: { label: 'Other', icon: 'fa-ellipsis-h' }
            };
            
            Object.entries(data).forEach(([category, entities]) => {
                if (entities.length === 0) return;
                
                const catInfo = categoryLabels[category] || { label: category, icon: 'fa-circle' };
                const initialShow = 10;
                const hasMore = entities.length > initialShow;
                
                html += `<div class="mb-6">`;
                html += `<h3 class="font-semibold mb-3 flex items-center cursor-pointer" onclick="toggleCategory('${category}')">
                    <i class="fas fa-chevron-down mr-2 text-gray-400 transition-transform" id="chevron-${category}"></i>
                    <i class="fas ${catInfo.icon} mr-2 text-gray-400"></i>${catInfo.label} (${entities.length})
                </h3>`;
                
                html += `<div id="category-${category}">`;
                
                entities.forEach((entity, idx) => {
                    const startDate = new Date(entity.first_contact || minDate);
                    const endDate = new Date(entity.last_contact || maxDate);
                    
                    const startPercent = Math.max(0, ((startDate - minDate) / (1000 * 60 * 60 * 24)) / totalDays * 100);
                    const widthPercent = Math.max(1, ((endDate - startDate) / (1000 * 60 * 60 * 24)) / totalDays * 100);
                    
                    const hiddenClass = idx >= initialShow ? 'hidden extra-entity-' + category : '';
                    
                    html += `<div class="flex items-center mb-2 group ${hiddenClass}">`;
                    html += `<div class="w-64 flex-shrink-0 pr-4 truncate text-sm sticky left-0 bg-gray-800 z-10" title="${escapeHtml(entity.email)}">
                        <span class="font-medium">${escapeHtml(entity.name)}</span>
                        <span class="text-gray-500 text-xs ml-2">(${entity.email_count})</span>
                    </div>`;
                    html += `<div class="flex-1 h-6 bg-gray-700 rounded relative">`;
                    // Today line
                    html += `<div class="absolute h-full w-0.5 bg-red-500 z-10" style="left: ${todayPercent}%;" title="Today"></div>`;
                    html += `<div class="gantt-bar absolute h-full rounded category-${category}" 
                        style="left: ${startPercent}%; width: ${widthPercent}%;"
                        title="${entity.name}&#10;Emails: ${entity.email_count}&#10;First: ${startDate.toLocaleDateString()}&#10;Last: ${endDate.toLocaleDateString()}">
                    </div>`;
                    html += `</div></div>`;
                });
                
                if (hasMore) {
                    html += `<button onclick="toggleMoreEntities('${category}', ${entities.length - initialShow})" 
                        id="toggle-btn-${category}"
                        class="ml-64 text-sm text-purple-400 hover:text-purple-300 mt-2">
                        <i class="fas fa-plus-circle mr-1"></i>Show ${entities.length - initialShow} more
                    </button>`;
                }
                
                html += `</div></div>`;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // Scroll to end (today) after render
            setTimeout(() => {
                container.scrollLeft = container.scrollWidth;
            }, 100);
        }

        function scrollToToday() {
            const container = document.getElementById('gantt-chart');
            container.scrollLeft = container.scrollWidth;
        }

        function toggleMoreEntities(category, count) {
            const extras = document.querySelectorAll('.extra-entity-' + category);
            const btn = document.getElementById('toggle-btn-' + category);
            const isHidden = extras[0]?.classList.contains('hidden');
            
            extras.forEach(el => {
                el.classList.toggle('hidden', !isHidden);
            });
            
            if (isHidden) {
                btn.innerHTML = '<i class="fas fa-minus-circle mr-1"></i>Show less';
            } else {
                btn.innerHTML = `<i class="fas fa-plus-circle mr-1"></i>Show ${count} more`;
            }
        }

        function toggleCategory(category) {
            const content = document.getElementById('category-' + category);
            const chevron = document.getElementById('chevron-' + category);
            
            content.classList.toggle('hidden');
            chevron.style.transform = content.classList.contains('hidden') ? 'rotate(-90deg)' : '';
        }

        function showRelationshipView(view) {
            // Toggle views
            document.getElementById('rel-view-timeline').classList.toggle('hidden', view !== 'timeline');
            document.getElementById('rel-view-org').classList.toggle('hidden', view !== 'org');
            document.getElementById('rel-view-manage').classList.toggle('hidden', view !== 'manage');
            
            // Reset all tabs
            document.querySelectorAll('.rel-tab-btn').forEach(btn => {
                btn.classList.remove('bg-purple-600', 'text-white');
                btn.classList.add('bg-gray-700', 'text-gray-300');
            });
            
            // Highlight selected tab
            document.getElementById('rel-tab-' + view).classList.remove('bg-gray-700', 'text-gray-300');
            document.getElementById('rel-tab-' + view).classList.add('bg-purple-600', 'text-white');
            
            // Render org map if needed
            if (view === 'org' && relationshipData) {
                renderOrgMap(relationshipData);
            }
            
            // Render manage view if needed
            if (view === 'manage' && relationshipData) {
                renderOrgManagement(relationshipData);
            }
        }

        function renderOrgMap(data) {
            const container = document.getElementById('org-map');
            
            // Group by organization (domain)
            const organizations = {};
            
            Object.entries(data).forEach(([category, entities]) => {
                entities.forEach(entity => {
                    const domain = entity.domain || 'unknown';
                    const orgName = domain.split('.')[0].toUpperCase();
                    
                    if (!organizations[domain]) {
                        organizations[domain] = {
                            name: orgName,
                            domain: domain,
                            category: category,
                            contacts: [],
                            totalEmails: 0,
                            firstContact: entity.first_contact,
                            lastContact: entity.last_contact
                        };
                    }
                    
                    organizations[domain].contacts.push(entity);
                    organizations[domain].totalEmails += entity.email_count;
                    
                    if (entity.first_contact && entity.first_contact < organizations[domain].firstContact) {
                        organizations[domain].firstContact = entity.first_contact;
                    }
                    if (entity.last_contact && entity.last_contact > organizations[domain].lastContact) {
                        organizations[domain].lastContact = entity.last_contact;
                    }
                });
            });
            
            // Group organizations by category
            const categoryOrgs = {
                customers: [],
                transport: [],
                suppliers: [],
                taxation: [],
                legal: [],
                internal: [],
                other: []
            };
            
            Object.values(organizations).forEach(org => {
                if (categoryOrgs[org.category]) {
                    categoryOrgs[org.category].push(org);
                } else {
                    categoryOrgs.other.push(org);
                }
            });
            
            // Sort by email count
            Object.keys(categoryOrgs).forEach(cat => {
                categoryOrgs[cat].sort((a, b) => b.totalEmails - a.totalEmails);
            });
            
            const categoryInfo = {
                customers: { label: 'Customers', icon: 'fa-users', color: 'blue' },
                transport: { label: 'Transport & Logistics', icon: 'fa-truck', color: 'yellow' },
                suppliers: { label: 'Suppliers', icon: 'fa-industry', color: 'green' },
                taxation: { label: 'Taxation & Finance', icon: 'fa-calculator', color: 'purple' },
                legal: { label: 'Legal', icon: 'fa-gavel', color: 'red' },
                internal: { label: 'Internal', icon: 'fa-building', color: 'gray' },
                other: { label: 'Other', icon: 'fa-ellipsis-h', color: 'gray' }
            };
            
            let html = '<div class="relative">';
            
            // Center - DFW Professional
            html += `
                <div class="flex justify-center mb-8">
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl p-6 text-center shadow-lg">
                        <i class="fas fa-building text-3xl mb-2"></i>
                        <h3 class="text-xl font-bold">DFW Professional</h3>
                        <p class="text-sm text-blue-200">Central Hub</p>
                    </div>
                </div>
            `;
            
            // Categories in a grid
            html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">';
            
            Object.entries(categoryOrgs).forEach(([category, orgs]) => {
                if (orgs.length === 0) return;
                
                const info = categoryInfo[category];
                const colorClasses = {
                    blue: 'border-blue-500 bg-blue-900/30',
                    yellow: 'border-yellow-500 bg-yellow-900/30',
                    green: 'border-green-500 bg-green-900/30',
                    purple: 'border-purple-500 bg-purple-900/30',
                    red: 'border-red-500 bg-red-900/30',
                    gray: 'border-gray-500 bg-gray-900/30'
                };
                
                html += `
                    <div class="border-2 ${colorClasses[info.color]} rounded-xl p-4">
                        <h4 class="font-semibold mb-4 flex items-center">
                            <i class="fas ${info.icon} mr-2"></i>${info.label}
                            <span class="ml-auto text-sm text-gray-400">${orgs.length} orgs</span>
                        </h4>
                        <div class="space-y-3 max-h-80 overflow-y-auto">
                `;
                
                orgs.forEach(org => {
                    const lastContactDate = org.lastContact ? new Date(org.lastContact).toLocaleDateString() : 'N/A';
                    html += `
                        <div class="bg-gray-800 rounded-lg p-3 hover:bg-gray-700 transition">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h5 class="font-medium">${escapeHtml(org.name)}</h5>
                                    <p class="text-xs text-gray-500">${escapeHtml(org.domain)}</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-medium">${org.totalEmails}</div>
                                    <div class="text-xs text-gray-500">emails</div>
                                </div>
                            </div>
                            <div class="mt-2 flex flex-wrap gap-1">
                                ${org.contacts.slice(0, 3).map(c => `
                                    <span class="text-xs bg-gray-700 px-2 py-0.5 rounded">${escapeHtml(c.name.split(' ')[0])}</span>
                                `).join('')}
                                ${org.contacts.length > 3 ? `<span class="text-xs text-gray-500">+${org.contacts.length - 3}</span>` : ''}
                            </div>
                            <div class="mt-2 text-xs text-gray-500">
                                Last contact: ${lastContactDate}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });
            
            html += '</div></div>';
            container.innerHTML = html;
        }

        function renderOrgManagement(data) {
            const container = document.getElementById('org-manage-list');
            
            // Group by organization (domain)
            const organizations = {};
            
            Object.entries(data).forEach(([category, entities]) => {
                entities.forEach(entity => {
                    const domain = entity.domain || 'unknown';
                    // Use custom name if available, otherwise default to domain-based name
                    const orgName = organizationNames[domain] || domain.split('.')[0].toUpperCase();
                    
                    if (!organizations[domain]) {
                        organizations[domain] = {
                            name: orgName,
                            domain: domain,
                            category: category,
                            contacts: [],
                            totalEmails: 0,
                            firstContact: entity.first_contact,
                            lastContact: entity.last_contact
                        };
                    }
                    
                    organizations[domain].contacts.push(entity);
                    organizations[domain].totalEmails += entity.email_count;
                });
            });
            
            allOrganizations = Object.values(organizations).sort((a, b) => b.totalEmails - a.totalEmails);
            renderOrganizationList(allOrganizations);
        }

        function renderOrganizationList(orgs) {
            const container = document.getElementById('org-manage-list');
            
            if (orgs.length === 0) {
                container.innerHTML = '<div class="p-8 text-center text-gray-400">No organizations found</div>';
                return;
            }
            
            const categoryColors = {
                customers: 'blue',
                transport: 'yellow',
                suppliers: 'green',
                taxation: 'purple',
                legal: 'red',
                internal: 'gray',
                other: 'gray'
            };
            
            let html = orgs.map(org => {
                const color = categoryColors[org.category] || 'gray';
                const lastContactDate = org.lastContact ? new Date(org.lastContact).toLocaleDateString() : 'N/A';
                const firstContactDate = org.firstContact ? new Date(org.firstContact).toLocaleDateString() : 'N/A';
                // Use custom name if available
                const displayName = organizationNames[org.domain] || org.name;
                
                return `
                    <div class="bg-gray-700 rounded-lg p-4 border border-gray-600">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold flex items-center gap-2">
                                    ${escapeHtml(displayName)}
                                    <span class="px-2 py-1 text-xs rounded bg-${color}-600 text-white">${org.category}</span>
                                </h3>
                                <p class="text-sm text-gray-400">${escapeHtml(org.domain)}</p>
                            </div>
                            <button onclick="editOrganization('${org.domain}')" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-sm">
                                <i class="fas fa-edit mr-1"></i>Edit
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4 mb-3 text-sm">
                            <div>
                                <div class="text-gray-500">Total Emails</div>
                                <div class="font-semibold text-${color}-400">${org.totalEmails}</div>
                            </div>
                            <div>
                                <div class="text-gray-500">First Contact</div>
                                <div class="font-medium">${firstContactDate}</div>
                            </div>
                            <div>
                                <div class="text-gray-500">Last Contact</div>
                                <div class="font-medium">${lastContactDate}</div>
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <div class="text-xs text-gray-500 mb-1">Contacts (${org.contacts.length}):</div>
                            <div class="flex flex-wrap gap-1">
                                ${org.contacts.slice(0, 5).map(c => `
                                    <span class="text-xs bg-gray-600 px-2 py-0.5 rounded">${escapeHtml(c.name)}</span>
                                `).join('')}
                                ${org.contacts.length > 5 ? `<span class="text-xs text-gray-500">+${org.contacts.length - 5} more</span>` : ''}
                            </div>
                        </div>
                        
                        <button onclick="viewOrgFiles('${org.domain}')" class="w-full mt-2 px-3 py-2 bg-gray-600 hover:bg-gray-500 rounded text-sm">
                            <i class="fas fa-folder-open mr-1"></i>View Associated Files
                        </button>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        function filterOrganizations() {
            const searchTerm = document.getElementById('org-search').value.toLowerCase();
            
            const filtered = allOrganizations.filter(org => {
                return org.name.toLowerCase().includes(searchTerm) || 
                       org.domain.toLowerCase().includes(searchTerm) ||
                       org.contacts.some(c => c.name.toLowerCase().includes(searchTerm));
            });
            
            renderOrganizationList(filtered);
        }

        async function editOrganization(domain) {
            const org = allOrganizations.find(o => o.domain === domain);
            if (!org) {
                // Try to find in relationship data
                let foundOrg = null;
                for (const [cat, entities] of Object.entries(relationshipData)) {
                    const entity = entities.find(e => e.domain === domain);
                    if (entity) {
                        foundOrg = { domain, name: entity.company || domain.split('.')[0].toUpperCase(), category: cat };
                        break;
                    }
                }
                if (!foundOrg) return;
                openOrgEditModal(foundOrg.domain, foundOrg.name, foundOrg.category);
            } else {
                openOrgEditModal(org.domain, org.display_name || org.name, org.category);
            }
        }
        
        function openOrgEditModal(domain, displayName, category) {
            document.getElementById('org-edit-domain').value = domain;
            document.getElementById('org-edit-domain-display').textContent = domain;
            document.getElementById('org-edit-name').value = organizationNames[domain] || displayName || domain.split('.')[0].toUpperCase();
            
            // Set category dropdown
            const categorySelect = document.getElementById('org-edit-category');
            if (categorySelect) {
                categorySelect.value = category || 'other';
            }
            
            // Populate related organization dropdown
            populateRelatedOrgDropdown(domain);
            
            // Load contacts for this organization
            loadOrgContacts(domain);
            
            // Load assigned emails for this organization
            loadOrgAssignedEmails(domain);
            
            // Build available emails list for search
            buildAvailableEmailsList(domain);
            
            // Clear email search
            document.getElementById('org-email-search').value = '';
            document.getElementById('org-email-dropdown').classList.add('hidden');
            
            document.getElementById('org-edit-modal').classList.remove('hidden');
        }
        
        function loadOrgContacts(domain) {
            const container = document.getElementById('org-contacts-list');
            
            // Find contacts from relationship data for this domain
            let contacts = [];
            Object.entries(relationshipData).forEach(([cat, entities]) => {
                entities.forEach(entity => {
                    if (entity.domain === domain) {
                        contacts.push({
                            name: entity.name || entity.company || 'Unknown',
                            email: entity.email,
                            emailCount: entity.email_count || 0
                        });
                    }
                });
            });
            
            if (contacts.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No contacts found</p>';
                return;
            }
            
            container.innerHTML = contacts.map(contact => `
                <div class="flex items-center justify-between bg-gray-800 rounded px-2 py-1">
                    <div class="flex-1 min-w-0">
                        <span class="text-sm font-medium truncate block">${escapeHtml(contact.name)}</span>
                        <span class="text-xs text-gray-400 truncate block">${escapeHtml(contact.email)} (${contact.emailCount} emails)</span>
                    </div>
                    <button onclick="removeOrgContact('${escapeHtml(contact.email)}')" class="text-red-400 hover:text-red-300 ml-2 flex-shrink-0" title="Remove contact from organization">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }
        
        async function removeOrgContact(email) {
            if (!confirm(`Remove contact ${email} from this organization? This will reassign the email to its original domain.`)) {
                return;
            }
            
            try {
                // Remove the email assignment (set to empty to revert to default)
                const response = await fetch('/api/organization/assign_email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email_address: email, organization_domain: '' })
                });
                
                if (response.ok) {
                    delete emailAssignments[email];
                    const domain = document.getElementById('org-edit-domain').value;
                    loadOrgContacts(domain);
                    loadOrgAssignedEmails(domain);
                    buildAvailableEmailsList(domain);
                }
            } catch (error) {
                console.error('Error removing contact:', error);
            }
        }
        
        function populateRelatedOrgDropdown(currentDomain) {
            const select = document.getElementById('org-edit-related');
            const currentRelated = organizationRelationships[currentDomain] || '';
            
            // Get all organizations from relationship data
            const allDomains = new Set();
            Object.entries(relationshipData).forEach(([cat, entities]) => {
                entities.forEach(e => {
                    if (e.domain && e.domain !== currentDomain) {
                        allDomains.add(e.domain);
                    }
                });
            });
            
            const sortedDomains = Array.from(allDomains).sort();
            
            select.innerHTML = '<option value="">None</option>' +
                sortedDomains.map(d => {
                    const name = organizationNames[d] || d.split('.')[0].toUpperCase();
                    const selected = d === currentRelated ? 'selected' : '';
                    return `<option value="${d}" ${selected}>${name} (${d})</option>`;
                }).join('');
            
            // Show related tags
            updateRelatedTags(currentDomain);
        }
        
        function updateRelatedTags(domain) {
            const container = document.getElementById('org-related-tags');
            const relatedTo = organizationRelationships[domain];
            
            // Find orgs that are related TO this domain
            const relatedFrom = Object.entries(organizationRelationships)
                .filter(([d, rel]) => rel === domain && d !== domain)
                .map(([d]) => d);
            
            let html = '';
            if (relatedTo) {
                const name = organizationNames[relatedTo] || relatedTo.split('.')[0].toUpperCase();
                html += `<span class="px-2 py-1 bg-blue-600 rounded text-xs"><i class="fas fa-arrow-right mr-1"></i>Related to: ${name}</span>`;
            }
            relatedFrom.forEach(d => {
                const name = organizationNames[d] || d.split('.')[0].toUpperCase();
                html += `<span class="px-2 py-1 bg-green-600 rounded text-xs"><i class="fas fa-arrow-left mr-1"></i>${name} relates here</span>`;
            });
            
            container.innerHTML = html || '<span class="text-gray-500 text-xs">No relationships</span>';
        }
        
        function buildAvailableEmailsList(currentDomain) {
            const allEmails = new Set();
            entitiesData.forEach(e => {
                if (e.email) allEmails.add(e.email.toLowerCase());
            });
            
            availableEmails = Array.from(allEmails).filter(email => {
                const assignedTo = emailAssignments[email];
                return !assignedTo || assignedTo === currentDomain;
            }).sort();
        }
        
        function filterOrgEmailDropdown() {
            const search = document.getElementById('org-email-search').value.toLowerCase();
            const dropdown = document.getElementById('org-email-dropdown');
            const domain = document.getElementById('org-edit-domain').value;
            
            if (!search) {
                dropdown.classList.add('hidden');
                return;
            }
            
            const filtered = availableEmails.filter(email => 
                email.includes(search) && emailAssignments[email] !== domain
            ).slice(0, 10);
            
            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="px-3 py-2 text-gray-500 text-sm">No matching emails</div>';
            } else {
                dropdown.innerHTML = filtered.map(email => `
                    <div class="px-3 py-2 hover:bg-gray-700 cursor-pointer text-sm" onclick="addEmailFromSearch('${email}')">
                        ${escapeHtml(email)}
                    </div>
                `).join('');
            }
            dropdown.classList.remove('hidden');
        }
        
        async function addEmailFromSearch(email) {
            const domain = document.getElementById('org-edit-domain').value;
            
            try {
                const response = await fetch('/api/organization/assign_email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email_address: email, organization_domain: domain })
                });
                
                if (response.ok) {
                    emailAssignments[email] = domain;
                    loadOrgAssignedEmails(domain);
                    buildAvailableEmailsList(domain);
                    document.getElementById('org-email-search').value = '';
                    document.getElementById('org-email-dropdown').classList.add('hidden');
                }
            } catch (error) {
                console.error('Error assigning email:', error);
            }
        }
        
        function closeOrgEditModal() {
            document.getElementById('org-edit-modal').classList.add('hidden');
        }
        
        function loadOrgAssignedEmails(domain) {
            const container = document.getElementById('org-assigned-emails');
            const assignedEmails = Object.entries(emailAssignments)
                .filter(([email, orgDomain]) => orgDomain === domain)
                .map(([email]) => email);
            
            if (assignedEmails.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No emails manually assigned</p>';
                return;
            }
            
            container.innerHTML = assignedEmails.map(email => `
                <div class="flex items-center justify-between bg-gray-800 rounded px-2 py-1">
                    <span class="text-sm truncate">${escapeHtml(email)}</span>
                    <button onclick="removeEmailAssignment('${email}')" class="text-red-400 hover:text-red-300 ml-2">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }
        
        function populateEmailDropdown(currentDomain) {
            const select = document.getElementById('org-add-email-select');
            
            // Get all unique emails from entities
            const allEmails = new Set();
            entitiesData.forEach(e => {
                if (e.email) allEmails.add(e.email.toLowerCase());
            });
            
            // Filter out already assigned emails (to this org)
            const availableEmails = Array.from(allEmails).filter(email => {
                const assignedTo = emailAssignments[email];
                return !assignedTo || assignedTo === currentDomain;
            }).sort();
            
            select.innerHTML = '<option value="">Select email to assign...</option>' +
                availableEmails.map(email => `<option value="${email}">${email}</option>`).join('');
        }
        
        async function assignEmailToCurrentOrg() {
            const domain = document.getElementById('org-edit-domain').value;
            const email = document.getElementById('org-add-email-select').value;
            
            if (!email) return;
            
            try {
                const response = await fetch('/api/organization/assign_email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email_address: email, organization_domain: domain })
                });
                
                if (response.ok) {
                    emailAssignments[email] = domain;
                    loadOrgAssignedEmails(domain);
                    populateEmailDropdown(domain);
                    document.getElementById('org-add-email-select').value = '';
                }
            } catch (error) {
                console.error('Error assigning email:', error);
            }
        }
        
        async function removeEmailAssignment(email) {
            const domain = document.getElementById('org-edit-domain').value;
            
            try {
                const response = await fetch('/api/organization/assign_email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email_address: email, organization_domain: '' })
                });
                
                if (response.ok) {
                    delete emailAssignments[email];
                    loadOrgAssignedEmails(domain);
                    populateEmailDropdown(domain);
                }
            } catch (error) {
                console.error('Error removing email assignment:', error);
            }
        }
        
        async function saveOrgChanges() {
            const domain = document.getElementById('org-edit-domain').value;
            const displayName = document.getElementById('org-edit-name').value.trim();
            const category = document.getElementById('org-edit-category').value;
            const relatedDomain = document.getElementById('org-edit-related').value;
            
            try {
                // Save display name
                await fetch('/api/organization/rename', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain, display_name: displayName })
                });
                
                // Save category
                await fetch('/api/entity/update_category', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain, category })
                });
                
                // Save related organization
                await fetch('/api/organization/set_related', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain, related_domain: relatedDomain })
                });
                
                if (displayName) {
                    organizationNames[domain] = displayName;
                } else {
                    delete organizationNames[domain];
                }
                
                if (relatedDomain) {
                    organizationRelationships[domain] = relatedDomain;
                } else {
                    delete organizationRelationships[domain];
                }
                
                // Reload data and close modal
                await loadOrganizationData();
                await loadRelationships();
                closeOrgEditModal();
                
                // Re-render if on management view
                if (!document.getElementById('rel-view-manage')?.classList.contains('hidden')) {
                    renderOrgManagement(relationshipData);
                }
            } catch (error) {
                console.error('Error saving organization:', error);
                alert('Failed to save changes');
            }
        }

        let currentOrgDomain = null;

        async function viewOrgFiles(domain) {
            currentOrgDomain = domain;
            const modal = document.getElementById('org-files-modal');
            const orgName = allOrganizations.find(o => o.domain === domain)?.name || domain;
            
            document.getElementById('org-files-title').textContent = `Files for ${orgName}`;
            document.getElementById('org-files-list').innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
            
            modal.classList.remove('hidden');
            
            await loadOrgFiles(domain);
        }
        
        async function loadOrgFiles(domain) {
            try {
                // Load from new API
                const response = await fetch(`/api/organization/files/${encodeURIComponent(domain)}`);
                const files = await response.json();
                
                // Also try old API for linked attachments
                let linkedFiles = [];
                try {
                    const oldResponse = await fetch(`/api/organization/${domain}/files`);
                    const oldData = await oldResponse.json();
                    if (oldData.files) linkedFiles = oldData.files;
                } catch (e) {}
                
                const allFiles = [...files, ...linkedFiles];
                
                if (allFiles.length > 0) {
                    document.getElementById('org-files-list').innerHTML = allFiles.map(file => {
                        const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(file.filename);
                        return `
                        <div class="bg-gray-700 rounded-lg p-3 flex items-center gap-3">
                            ${isImage && file.path ? 
                                `<img src="${file.path}" class="w-16 h-16 object-cover rounded cursor-pointer" onclick="window.open('${file.path}', '_blank')">` :
                                `<div class="w-16 h-16 bg-gray-800 rounded flex items-center justify-center"><i class="fas fa-file text-2xl text-gray-500"></i></div>`
                            }
                            <div class="flex-1">
                                <a href="${file.path || '#'}" target="_blank" class="font-medium text-white hover:text-blue-400">${escapeHtml(file.filename)}</a>
                                ${file.description ? `<div class="text-xs text-gray-400 mt-1">${escapeHtml(file.description)}</div>` : ''}
                                ${file.notes ? `<div class="text-xs text-gray-400 mt-1">${escapeHtml(file.notes)}</div>` : ''}
                                <div class="text-xs text-gray-500 mt-1">${file.created_at ? new Date(file.created_at).toLocaleDateString() : ''}</div>
                            </div>
                            ${file.id ? `<button onclick="deleteOrgFile(${file.id}, '${domain}')" class="px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs"><i class="fas fa-times"></i></button>` : ''}
                        </div>
                        `;
                    }).join('');
                } else {
                    document.getElementById('org-files-list').innerHTML = '<div class="text-center py-8 text-gray-400">No files attached yet. Click Upload to add files.</div>';
                }
            } catch (error) {
                console.error('Error loading files:', error);
                document.getElementById('org-files-list').innerHTML = '<div class="text-center py-4 text-red-400">Error loading files</div>';
            }
        }
        
        async function deleteOrgFile(fileId, domain) {
            if (!confirm('Delete this file?')) return;
            try {
                await fetch(`/api/organization/files/delete/${fileId}`, { method: 'DELETE' });
                loadOrgFiles(domain);
            } catch (error) {
                console.error('Error deleting file:', error);
            }
        }

        function closeOrgFilesModal() {
            document.getElementById('org-files-modal').classList.add('hidden');
            currentOrgDomain = null;
        }

        async function linkAttachmentToOrg() {
            const attachmentId = prompt('Enter attachment ID to link:');
            if (!attachmentId || !currentOrgDomain) return;
            
            try {
                const response = await fetch(`/api/organization/${currentOrgDomain}/link_attachment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ attachment_id: parseInt(attachmentId) })
                });
                
                const result = await response.json();
                if (result.success) {
                    viewOrgFiles(currentOrgDomain);
                } else {
                    alert('Failed to link attachment: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function removeOrgFile(fileId) {
            if (!confirm('Remove this file from organization?')) return;
            
            try {
                const response = await fetch(`/api/organization/${currentOrgDomain}/files/${fileId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    viewOrgFiles(currentOrgDomain);
                } else {
                    alert('Failed to remove file');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function linkToOrganization(attachmentId) {
            if (!allOrganizations || allOrganizations.length === 0) {
                alert('No organizations found. Please load the Relationship Chart first.');
                return;
            }
            
            // Create a simple list of organizations
            const orgList = allOrganizations.map((org, idx) => `${idx + 1}. ${org.name} (${org.domain})`).join('\\n');
            const selected = prompt(`Link attachment to organization:\\n\\n${orgList}\\n\\nEnter organization number (1-${allOrganizations.length}):`)
            
            if (!selected) return;
            
            const orgIndex = parseInt(selected) - 1;
            if (orgIndex < 0 || orgIndex >= allOrganizations.length) {
                alert('Invalid organization number');
                return;
            }
            
            const org = allOrganizations[orgIndex];
            
            try {
                const response = await fetch(`/api/organization/${org.domain}/link_attachment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ attachment_id: attachmentId })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert(`Attachment linked to ${org.name}`);
                } else {
                    alert('Failed to link: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Chat functionality
        document.getElementById('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('question-input');
            const question = input.value.trim();
            if (!question) return;
            
            input.value = '';
            await askQuestion(question);
        });

        let greekMode = false;
        
        const quickQuestions = {
            urgent: {
                en: { label: 'Urgent issues', question: 'What are the most urgent issues that need attention?' },
                gr: { label: 'Î•Ï€ÎµÎ¯Î³Î¿Î½Ï„Î± Î¸Î­Î¼Î±Ï„Î±', question: 'Î Î¿Î¹Î± ÎµÎ¯Î½Î±Î¹ Ï„Î± Ï€Î¹Î¿ ÎµÏ€ÎµÎ¯Î³Î¿Î½Ï„Î± Î¸Î­Î¼Î±Ï„Î± Ï€Î¿Ï… Ï‡ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ Ï€ÏÎ¿ÏƒÎ¿Ï‡Î®;' }
            },
            pending: {
                en: { label: 'Pending orders', question: 'List all pending orders and their statuses' },
                gr: { label: 'Î•ÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯ÎµÏ‚', question: 'Î”ÎµÎ¯Î¾Îµ Î¼Î¿Ï… ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ ÎµÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯ÎµÏ‚ ÎºÎ±Î¹ Ï„Î·Î½ ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ® Ï„Î¿Ï…Ï‚' }
            },
            shipments: {
                en: { label: 'Active shipments', question: 'What shipments are currently in progress?' },
                gr: { label: 'Î•Î½ÎµÏÎ³Î­Ï‚ Î±Ï€Î¿ÏƒÏ„Î¿Î»Î­Ï‚', question: 'Î Î¿Î¹ÎµÏ‚ Î±Ï€Î¿ÏƒÏ„Î¿Î»Î­Ï‚ Î²ÏÎ¯ÏƒÎºÎ¿Î½Ï„Î±Î¹ ÏƒÎµ ÎµÎ¾Î­Î»Î¹Î¾Î·;' }
            },
            payments: {
                en: { label: 'Payment status', question: 'What invoices or payments are pending?' },
                gr: { label: 'ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Ï€Î»Î·ÏÏ‰Î¼ÏŽÎ½', question: 'Î Î¿Î¹Î± Ï„Î¹Î¼Î¿Î»ÏŒÎ³Î¹Î± Î® Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚ ÎµÎºÎºÏÎµÎ¼Î¿ÏÎ½;' }
            }
        };
        
        function askQuickQuestion(key) {
            const lang = greekMode ? 'gr' : 'en';
            const q = quickQuestions[key][lang].question;
            askQuestion(q);
        }
        
        function updateQuickQuestionsLanguage() {
            const lang = greekMode ? 'gr' : 'en';
            document.getElementById('quick-questions-title').innerHTML = 
                `<i class="fas fa-lightbulb mr-2 text-yellow-500"></i>${greekMode ? 'Î“ÏÎ®Î³Î¿ÏÎµÏ‚ Î•ÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚' : 'Quick Questions'}`;
            
            document.querySelectorAll('.quick-q').forEach(btn => {
                const key = btn.dataset.key;
                if (quickQuestions[key]) {
                    btn.querySelector('span').textContent = quickQuestions[key][lang].label;
                }
            });
        }
        
        function toggleGreekMode() {
            greekMode = !greekMode;
            const btn = document.getElementById('greek-mode-btn');
            if (greekMode) {
                btn.classList.remove('bg-gray-700');
                btn.classList.add('bg-blue-600');
                btn.innerHTML = 'ðŸ‡¬ðŸ‡· Î•Î½ÎµÏÎ³ÏŒ';
                document.getElementById('question-input').placeholder = 'Î¡Ï‰Ï„Î®ÏƒÏ„Îµ ÏƒÏ„Î± Î•Î»Î»Î·Î½Î¹ÎºÎ¬...';
            } else {
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-gray-700');
                btn.innerHTML = 'ðŸ‡¬ðŸ‡· Î•Î»Î»Î·Î½Î¹ÎºÎ¬';
                document.getElementById('question-input').placeholder = 'Ask a question about your data...';
            }
            updateQuickQuestionsLanguage();
        }
        
        async function askQuestion(question) {
            const messagesDiv = document.getElementById('chat-messages');
            const sendBtn = document.getElementById('send-btn');
            
            // Add user message
            messagesDiv.innerHTML += `
                <div class="chat-message flex justify-end">
                    <div class="bg-blue-600 rounded-lg p-4 max-w-[80%]">
                        <p class="text-sm font-medium text-blue-200">You</p>
                        <p class="text-white mt-1">${escapeHtml(question)}</p>
                    </div>
                </div>
            `;
            
            // Add typing indicator
            const typingId = 'typing-' + Date.now();
            messagesDiv.innerHTML += `
                <div id="${typingId}" class="chat-message bg-gray-700 rounded-lg p-4">
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-robot text-sm"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-blue-400">Jimmy</p>
                            <p class="text-gray-400 mt-1 typing-indicator">${greekMode ? 'Î£ÎºÎ­Ï†Ï„Î¿Î¼Î±Î¹' : 'Thinking'}</p>
                        </div>
                    </div>
                </div>
            `;
            
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            sendBtn.disabled = true;
            
            try {
                const response = await fetch('/api/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question, greek_mode: greekMode })
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                document.getElementById(typingId).remove();
                
                // Add AI response
                messagesDiv.innerHTML += `
                    <div class="chat-message bg-gray-700 rounded-lg p-4">
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                                <i class="fas fa-robot text-sm"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-blue-400">Jimmy</p>
                                <div class="text-gray-300 mt-1">${renderMarkdown(data.answer)}</div>
                                ${data.related_emails && data.related_emails.length > 0 ? `
                                    <div class="mt-3 pt-3 border-t border-gray-600">
                                        <p class="text-xs text-gray-500 mb-2">${greekMode ? 'Î£Ï‡ÎµÏ„Î¹ÎºÎ¬ emails:' : 'Related emails:'}</p>
                                        ${data.related_emails.map(email => `
                                            <button onclick="showEmail(${email.id})" class="block w-full text-left text-sm text-blue-400 hover:text-blue-300 py-1">
                                                <i class="fas fa-envelope mr-2"></i>${escapeHtml(email.subject || 'No subject')}
                                            </button>
                                        `).join('')}
                                    </div>
                                ` : ''}
                                ${data.related_data && data.related_data.length > 0 ? `
                                    <div class="mt-3 pt-3 border-t border-gray-600">
                                        <p class="text-xs text-gray-500 mb-2">${greekMode ? 'Î£Ï‡ÎµÏ„Î¹ÎºÎ¬ Î´ÎµÎ´Î¿Î¼Î­Î½Î±:' : 'Related data:'}</p>
                                        ${data.related_data.map(item => `
                                            <div class="text-sm text-gray-400 py-1">
                                                <i class="fas fa-${item.type === 'product' ? 'box' : item.type === 'invoice' ? 'file-invoice' : item.type === 'proforma' ? 'file-alt' : 'database'} mr-2 text-purple-400"></i>
                                                ${escapeHtml(item.title || item.name || 'Unknown')}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById(typingId).remove();
                messagesDiv.innerHTML += `
                    <div class="chat-message bg-red-900/50 rounded-lg p-4">
                        <p class="text-red-400"><i class="fas fa-exclamation-circle mr-2"></i>Error: ${error.message}</p>
                    </div>
                `;
            }
            
            sendBtn.disabled = false;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        let currentSearchType = 'keyword';

        function setSearchType(type) {
            currentSearchType = type;
            
            // Update button styles
            document.getElementById('search-type-keyword').className = 
                type === 'keyword' ? 'px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium' : 
                'px-4 py-2 bg-gray-700 text-gray-300 rounded-lg text-sm font-medium hover:bg-gray-600';
            document.getElementById('search-type-semantic').className = 
                type === 'semantic' ? 'px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium' : 
                'px-4 py-2 bg-gray-700 text-gray-300 rounded-lg text-sm font-medium hover:bg-gray-600';
            
            // Update hint text
            const hint = document.getElementById('search-hint');
            if (type === 'semantic') {
                hint.textContent = 'AI-powered semantic search - finds similar meaning, not just keywords';
            } else {
                hint.textContent = 'Exact keyword matching';
            }
        }

        async function loadChromaDBStatus() {
            try {
                const response = await fetch('/api/chromadb/status');
                const status = await response.json();
                
                const statusEl = document.getElementById('chromadb-status');
                const countEl = document.getElementById('chromadb-email-count');
                
                if (status.initialized) {
                    statusEl.innerHTML = '<i class="fas fa-check-circle mr-1"></i>Ready';
                    statusEl.className = 'text-sm font-medium text-green-400';
                    countEl.textContent = status.emails_indexed || 0;
                } else {
                    statusEl.innerHTML = '<i class="fas fa-times-circle mr-1"></i>Not Initialized';
                    statusEl.className = 'text-sm font-medium text-red-400';
                    countEl.textContent = '-';
                }
            } catch (error) {
                console.error('Error loading ChromaDB status:', error);
            }
        }

        async function indexEmails() {
            const btn = document.getElementById('index-btn');
            const originalText = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Indexing...';
                
                const response = await fetch('/api/chromadb/index_emails', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    alert(`Successfully indexed ${result.indexed_count} emails!`);
                    loadChromaDBStatus();
                } else {
                    alert('Indexing failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error indexing emails:', error);
                alert('Error indexing emails: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function searchEmails() {
            const query = document.getElementById('search-input').value.trim();
            if (!query) return;
            
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '<div class="p-8 text-center"><i class="fas fa-spinner fa-spin text-2xl"></i></div>';
            
            try {
                if (currentSearchType === 'semantic') {
                    // Semantic search using ChromaDB
                    const response = await fetch('/api/chromadb/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: query, limit: 20, collection: 'emails' })
                    });
                    const data = await response.json();
                    
                    if (!data.results || data.results.length === 0) {
                        resultsDiv.innerHTML = '<div class="p-8 text-center text-gray-400">No results found. Try indexing emails first.</div>';
                        return;
                    }
                    
                    resultsDiv.innerHTML = data.results.map(result => {
                        const similarity = Math.round(result.similarity_score * 100);
                        return `
                            <div class="p-4 hover:bg-gray-700/50 cursor-pointer transition" onclick="showEmail(${result.metadata.email_id})">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <h4 class="font-medium">${escapeHtml(result.metadata.subject || 'No subject')}</h4>
                                            <span class="text-xs px-2 py-0.5 bg-green-600 rounded">${similarity}% match</span>
                                        </div>
                                        <p class="text-sm text-gray-400">${escapeHtml(result.metadata.from_address)}</p>
                                        <p class="text-xs text-gray-500 mt-1 line-clamp-2">${escapeHtml(result.document.substring(0, 150))}...</p>
                                    </div>
                                    <span class="text-xs text-gray-500 ml-2">${result.metadata.date ? new Date(result.metadata.date).toLocaleDateString() : ''}</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    // Keyword search (existing)
                    const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                    const results = await response.json();
                    
                    if (results.length === 0) {
                        resultsDiv.innerHTML = '<div class="p-8 text-center text-gray-400">No results found</div>';
                        return;
                    }
                    
                    resultsDiv.innerHTML = results.map(email => `
                        <div class="p-4 hover:bg-gray-700/50 cursor-pointer transition" onclick="showEmail(${email.id})">
                            <div class="flex items-start justify-between">
                                <div>
                                    <h4 class="font-medium">${escapeHtml(email.subject || 'No subject')}</h4>
                                    <p class="text-sm text-gray-400">${escapeHtml(email.from_address)}</p>
                                </div>
                                <span class="text-xs text-gray-500">${email.date_received ? new Date(email.date_received).toLocaleDateString() : ''}</span>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="p-8 text-center text-red-400">Error: ${error.message}</div>`;
            }
        }

        async function showEmail(id) {
            const modal = document.getElementById('email-modal');
            const content = document.getElementById('modal-content');
            
            // Track current email for navigation
            currentEmailId = id;
            currentEmailIndex = allEmailsData.findIndex(e => e.id === id);
            
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            content.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl"></i></div>';
            
            try {
                const response = await fetch(`/api/email/${id}`);
                const email = await response.json();
                
                document.getElementById('modal-subject').textContent = email.subject || 'No subject';
                
                // Format the email body for better readability
                let bodyContent = email.body_text || 'No content';
                
                // Remove/sanitize links and attachments references
                bodyContent = bodyContent
                    .replace(/https?:\/\/[^\s<>"{}|\\^`\[\]]+/gi, '[link removed]')
                    .replace(/www\.[^\s<>"{}|\\^`\[\]]+/gi, '[link removed]')
                    .replace(/\[cid:[^\]]+\]/gi, '[image]')
                    .replace(/<[^>]+>/g, '') // Remove any HTML tags
                    .replace(/Content-Type:.*?(?=\n\n|\r\n\r\n)/gs, '[attachment]')
                    .replace(/Content-Disposition:.*?attachment.*?(?=\n\n|\r\n\r\n)/gs, '[attachment]')
                    .replace(/------=_Part.*?(?=------=_Part|$)/gs, '\n[attachment section]\n');
                
                // Clean up excessive whitespace
                bodyContent = bodyContent
                    .replace(/\n{4,}/g, '\n\n\n')
                    .replace(/[ \t]{2,}/g, ' ')
                    .trim();
                
                // Format date nicely
                const dateStr = email.date_received ? new Date(email.date_received).toLocaleString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'Unknown date';
                
                content.innerHTML = `
                    <div class="space-y-4">
                        <!-- Email Header -->
                        <div class="bg-gray-700 rounded-lg p-4 space-y-2">
                            <div class="flex items-start">
                                <span class="text-gray-500 w-16 flex-shrink-0">From:</span>
                                <span class="text-gray-200 font-medium">${escapeHtml(email.from_address)}</span>
                            </div>
                            <div class="flex items-start">
                                <span class="text-gray-500 w-16 flex-shrink-0">To:</span>
                                <span class="text-gray-300">${escapeHtml(email.to_address || 'Unknown')}</span>
                            </div>
                            <div class="flex items-start">
                                <span class="text-gray-500 w-16 flex-shrink-0">Date:</span>
                                <span class="text-gray-300">${dateStr}</span>
                            </div>
                            <div class="flex items-start">
                                <span class="text-gray-500 w-16 flex-shrink-0">Subject:</span>
                                <span class="text-gray-200 font-medium">${escapeHtml(email.subject || 'No subject')}</span>
                            </div>
                        </div>
                        
                        <!-- Email Body -->
                        <div class="bg-gray-900 rounded-lg p-4">
                            <div class="text-gray-300 text-sm leading-relaxed whitespace-pre-wrap font-mono" style="word-break: break-word;">${escapeHtml(bodyContent)}</div>
                        </div>
                    </div>
                `;
                
                // Update read button based on email status
                const emailData = allEmailsData.find(e => e.id === id);
                if (emailData) {
                    updateModalReadButton(emailData.is_read);
                }
            } catch (error) {
                content.innerHTML = `<div class="text-red-400 p-4">Error loading email: ${error.message}</div>`;
            }
        }

        function closeModalOnBackdrop(event) {
            if (event.target === event.currentTarget) {
                closeModal();
            }
        }

        function closeModal() {
            const modal = document.getElementById('email-modal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
            currentEmailId = null;
            currentEmailIndex = -1;
        }
        
        // Navigate to previous/next email
        function navigateEmail(direction) {
            if (allEmailsData.length === 0) return;
            
            let newIndex = currentEmailIndex + direction;
            if (newIndex < 0) newIndex = allEmailsData.length - 1;
            if (newIndex >= allEmailsData.length) newIndex = 0;
            
            const email = allEmailsData[newIndex];
            if (email) {
                showEmail(email.id);
            }
        }
        
        // Toggle read status for current email in modal
        async function toggleCurrentEmailRead() {
            if (!currentEmailId) return;
            
            try {
                const response = await fetch(`/api/emails/${currentEmailId}/read`, { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    // Update button appearance
                    updateModalReadButton(result.is_read);
                    // Update email list
                    filterEmailList();
                }
            } catch (error) {
                console.error('Error toggling read status:', error);
            }
        }
        
        function updateModalReadButton(isRead) {
            const btn = document.getElementById('modal-read-btn');
            if (btn) {
                btn.innerHTML = isRead 
                    ? '<i class="fas fa-check-circle mr-1 text-green-500"></i><span>Read</span>'
                    : '<i class="far fa-circle mr-1"></i><span>Mark Read</span>';
            }
        }
        
        // Keyboard navigation for email modal
        document.addEventListener('keydown', (e) => {
            const modal = document.getElementById('email-modal');
            if (modal.classList.contains('hidden')) return;
            
            // Don't handle if typing in an input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.key) {
                case 'ArrowLeft':
                    e.preventDefault();
                    navigateEmail(-1);
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    navigateEmail(1);
                    break;
                case 'r':
                case 'R':
                    e.preventDefault();
                    toggleCurrentEmailRead();
                    break;
                case 'Escape':
                    closeModal();
                    break;
            }
        });

        function showTab(tabName) {
            // Hide all panels
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
            // Reset all tabs
            document.querySelectorAll('.tab-btn').forEach(t => {
                t.classList.remove('bg-blue-600', 'text-white');
                t.classList.add('bg-gray-700', 'text-gray-300');
            });
            
            // Show selected panel
            document.getElementById('panel-' + tabName).classList.remove('hidden');
            // Highlight selected tab
            const activeTab = document.getElementById('tab-' + tabName);
            activeTab.classList.remove('bg-gray-700', 'text-gray-300');
            activeTab.classList.add('bg-blue-600', 'text-white');
            
            // Load ChromaDB status when search tab is opened
            if (tabName === 'search') {
                loadChromaDBStatus();
            }
            
            // Load production data when production tab is opened
            if (tabName === 'production') {
                loadProductionData();
            }
            
            // Load calendar data when calendar tab is opened
            if (tabName === 'calendar') {
                loadCalendarData();
            }
        }
        
        // Calendar functions
        async function connectGoogleCalendar() {
            // Redirect to OAuth flow
            window.location.href = '/api/calendar/auth';
        }
        
        async function disconnectCalendar() {
            try {
                await fetch('/api/calendar/disconnect', { method: 'POST' });
                updateCalendarUI(false);
            } catch (error) {
                console.error('Error disconnecting calendar:', error);
            }
        }
        
        async function checkCalendarStatus() {
            try {
                const response = await fetch('/api/calendar/status');
                const data = await response.json();
                updateCalendarUI(data.connected);
                return data.connected;
            } catch (error) {
                console.error('Error checking calendar status:', error);
                return false;
            }
        }
        
        function updateCalendarUI(connected) {
            const authSection = document.getElementById('calendar-auth-section');
            const contentSection = document.getElementById('calendar-content');
            
            if (connected) {
                authSection.classList.add('hidden');
                contentSection.classList.remove('hidden');
            } else {
                authSection.classList.remove('hidden');
                contentSection.classList.add('hidden');
            }
        }
        
        async function loadCalendarData() {
            const connected = await checkCalendarStatus();
            if (!connected) return;
            
            // Load tasks
            const tasksResponse = await fetch('/api/calendar/tasks');
            const tasksData = await tasksResponse.json();
            renderCalendarTasks(tasksData.tasks || []);
            
            // Load events for calendar grid
            await loadCalendarEvents();
        }
        
        // Store tasks and events for detail view
        let calendarTasks = [];
        
        function renderCalendarTasks(tasks) {
            const container = document.getElementById('calendar-tasks');
            calendarTasks = tasks || [];
            
            if (!tasks || tasks.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No tasks found</p>';
                return;
            }
            
            container.innerHTML = tasks.map((task, index) => {
                const dueDate = task.due ? new Date(task.due).toLocaleDateString() : '';
                return `
                    <div class="bg-gray-800 rounded-lg p-3 border-l-4 border-yellow-500 cursor-pointer hover:bg-gray-700 transition" onclick="showTaskDetail(${index})">
                        <div class="flex items-start gap-2">
                            <i class="fas fa-square text-gray-600 mt-1"></i>
                            <div class="flex-1">
                                <p class="font-medium text-sm">${escapeHtml(task.title)}</p>
                                ${task.notes ? `<p class="text-xs text-gray-400 mt-1">${escapeHtml(task.notes.substring(0, 100))}</p>` : ''}
                                <div class="flex items-center gap-2 mt-2 text-xs text-gray-500">
                                    ${dueDate ? `<span><i class="fas fa-clock mr-1"></i>${dueDate}</span>` : ''}
                                    <span class="px-2 py-0.5 bg-gray-700 rounded">${escapeHtml(task.list)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function showTaskDetail(index) {
            const task = calendarTasks[index];
            if (!task) return;
            
            const dueDate = task.due ? new Date(task.due).toLocaleDateString('en-US', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            }) : 'No due date';
            
            document.getElementById('calendar-detail-title').innerHTML = 
                '<i class="fas fa-tasks mr-2 text-yellow-500"></i>Task Details';
            
            document.getElementById('calendar-detail-content').innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-500 uppercase">Title</label>
                        <p class="text-lg font-medium">${escapeHtml(task.title)}</p>
                    </div>
                    ${task.notes ? `
                    <div>
                        <label class="text-xs text-gray-500 uppercase">Notes</label>
                        <p class="text-gray-300 whitespace-pre-wrap">${escapeHtml(task.notes)}</p>
                    </div>
                    ` : ''}
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-gray-500 uppercase">Due Date</label>
                            <p class="text-gray-300"><i class="fas fa-calendar mr-2 text-yellow-500"></i>${dueDate}</p>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 uppercase">Status</label>
                            <p class="text-gray-300"><i class="fas fa-circle mr-2 ${task.status === 'completed' ? 'text-green-500' : 'text-orange-500'}"></i>${task.status === 'completed' ? 'Completed' : 'Pending'}</p>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 uppercase">List</label>
                        <p class="text-gray-300"><i class="fas fa-list mr-2 text-blue-500"></i>${escapeHtml(task.list)}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('calendar-detail-modal').classList.remove('hidden');
        }
        
        function showEventDetail(eventId) {
            const event = calendarEvents.find(e => e.id === eventId);
            if (!event) return;
            
            const startDate = event.start ? new Date(event.start) : null;
            const endDate = event.end ? new Date(event.end) : null;
            
            const dateStr = startDate ? startDate.toLocaleDateString('en-US', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            }) : 'No date';
            
            const timeStr = startDate && event.start.includes('T') 
                ? startDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
                : 'All day';
            
            const endTimeStr = endDate && event.end && event.end.includes('T')
                ? endDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
                : '';
            
            document.getElementById('calendar-detail-title').innerHTML = 
                '<i class="fas fa-calendar-day mr-2 text-blue-500"></i>Event Details';
            
            document.getElementById('calendar-detail-content').innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-500 uppercase">Title</label>
                        <p class="text-lg font-medium">${escapeHtml(event.title)}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-gray-500 uppercase">Date</label>
                            <p class="text-gray-300"><i class="fas fa-calendar mr-2 text-blue-500"></i>${dateStr}</p>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 uppercase">Time</label>
                            <p class="text-gray-300"><i class="fas fa-clock mr-2 text-blue-500"></i>${timeStr}${endTimeStr ? ' - ' + endTimeStr : ''}</p>
                        </div>
                    </div>
                    ${event.location ? `
                    <div>
                        <label class="text-xs text-gray-500 uppercase">Location</label>
                        <p class="text-gray-300"><i class="fas fa-map-marker-alt mr-2 text-red-500"></i>${escapeHtml(event.location)}</p>
                    </div>
                    ` : ''}
                    ${event.description ? `
                    <div>
                        <label class="text-xs text-gray-500 uppercase">Description</label>
                        <p class="text-gray-300 whitespace-pre-wrap">${escapeHtml(event.description)}</p>
                    </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('calendar-detail-modal').classList.remove('hidden');
        }
        
        function closeCalendarDetailModal() {
            document.getElementById('calendar-detail-modal').classList.add('hidden');
        }
        
        // Calendar state
        let currentCalendarYear = new Date().getFullYear();
        let currentCalendarMonth = new Date().getMonth() + 1;
        let calendarEvents = [];
        
        function changeCalendarMonth(delta) {
            currentCalendarMonth += delta;
            if (currentCalendarMonth > 12) {
                currentCalendarMonth = 1;
                currentCalendarYear++;
            } else if (currentCalendarMonth < 1) {
                currentCalendarMonth = 12;
                currentCalendarYear--;
            }
            loadCalendarEvents();
        }
        
        async function loadCalendarEvents() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '<div class="col-span-7 text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Loading...</div>';
            
            try {
                const response = await fetch(`/api/calendar/events?year=${currentCalendarYear}&month=${currentCalendarMonth}`);
                const data = await response.json();
                calendarEvents = data.events || [];
                renderCalendarGrid();
            } catch (error) {
                console.error('Error loading calendar events:', error);
                grid.innerHTML = '<div class="col-span-7 text-center py-8 text-red-400">Error loading events</div>';
            }
        }
        
        function renderCalendarGrid() {
            const grid = document.getElementById('calendar-grid');
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Update title
            document.getElementById('calendar-month-title').innerHTML = 
                `<i class="fas fa-calendar-alt mr-2 text-blue-500"></i>${monthNames[currentCalendarMonth - 1]} ${currentCalendarYear}`;
            
            // Get first day and number of days in month
            const firstDay = new Date(currentCalendarYear, currentCalendarMonth - 1, 1).getDay();
            const daysInMonth = new Date(currentCalendarYear, currentCalendarMonth, 0).getDate();
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === currentCalendarYear && today.getMonth() + 1 === currentCalendarMonth;
            
            // Group events by date
            const eventsByDate = {};
            calendarEvents.forEach(event => {
                const eventDate = event.start.split('T')[0];
                if (!eventsByDate[eventDate]) eventsByDate[eventDate] = [];
                eventsByDate[eventDate].push(event);
            });
            
            let html = '';
            
            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="min-h-[80px] bg-gray-800/30 rounded p-1"></div>';
            }
            
            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentCalendarYear}-${String(currentCalendarMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayEvents = eventsByDate[dateStr] || [];
                const isToday = isCurrentMonth && today.getDate() === day;
                
                html += `
                    <div class="min-h-[80px] bg-gray-800 rounded p-1 ${isToday ? 'ring-2 ring-blue-500' : ''}">
                        <div class="text-xs font-semibold ${isToday ? 'text-blue-400' : 'text-gray-400'} mb-1">${day}</div>
                        <div class="space-y-0.5 overflow-y-auto max-h-[60px]">
                            ${dayEvents.slice(0, 3).map(event => {
                                const time = event.start.includes('T') 
                                    ? new Date(event.start).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })
                                    : '';
                                return `
                                    <div class="text-xs bg-blue-600/80 rounded px-1 py-0.5 truncate cursor-pointer hover:bg-blue-500" 
                                         title="${escapeHtml(event.title)}${time ? ' at ' + time : ''}"
                                         onclick="showEventDetail('${event.id}')">
                                        ${time ? `<span class="text-blue-200">${time}</span> ` : ''}${escapeHtml(event.title.substring(0, 15))}
                                    </div>
                                `;
                            }).join('')}
                            ${dayEvents.length > 3 ? `<div class="text-xs text-gray-500">+${dayEvents.length - 3} more</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Empty cells after last day
            const totalCells = firstDay + daysInMonth;
            const remainingCells = (7 - (totalCells % 7)) % 7;
            for (let i = 0; i < remainingCells; i++) {
                html += '<div class="min-h-[80px] bg-gray-800/30 rounded p-1"></div>';
            }
            
            grid.innerHTML = html;
        }
        
        async function refreshCalendar() {
            const tasksContainer = document.getElementById('calendar-tasks');
            tasksContainer.innerHTML = '<p class="text-gray-500 text-sm"><i class="fas fa-spinner fa-spin mr-2"></i>Loading tasks...</p>';
            await loadCalendarData();
        }
        
        // Check for calendar connection on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Check URL params for calendar status
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('calendar_connected') === 'true') {
                // Clean URL and switch to calendar tab
                window.history.replaceState({}, document.title, '/');
                showTab('calendar');
            }
            if (urlParams.get('calendar_error')) {
                alert('Calendar connection error: ' + urlParams.get('calendar_error'));
                window.history.replaceState({}, document.title, '/');
            }
        });

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderMarkdown(text) {
            if (!text) return '';
            
            // Escape HTML first
            let html = escapeHtml(text);
            
            // Code blocks (```code```)
            html = html.replace(/```([\s\S]*?)```/g, '<pre class="bg-gray-800 rounded p-3 my-2 overflow-x-auto"><code class="text-sm text-green-300">$1</code></pre>');
            
            // Inline code (`code`)
            html = html.replace(/`([^`]+)`/g, '<code class="bg-gray-800 px-1.5 py-0.5 rounded text-sm text-green-300">$1</code>');
            
            // Bold (**text** or __text__)
            html = html.replace(/\*\*([^\*]+)\*\*/g, '<strong class="font-bold text-white">$1</strong>');
            html = html.replace(/__([^_]+)__/g, '<strong class="font-bold text-white">$1</strong>');
            
            // Italic (*text* or _text_)
            html = html.replace(/\*([^\*]+)\*/g, '<em class="italic">$1</em>');
            html = html.replace(/_([^_]+)_/g, '<em class="italic">$1</em>');
            
            // Headers (# Header)
            html = html.replace(/^### (.+)$/gm, '<h3 class="text-lg font-bold text-white mt-4 mb-2">$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2 class="text-xl font-bold text-white mt-4 mb-2">$1</h2>');
            html = html.replace(/^# (.+)$/gm, '<h1 class="text-2xl font-bold text-white mt-4 mb-2">$1</h1>');
            
            // Links [text](url)
            html = html.replace(/\[([^\]]+)\]\(([^\)]+)\)/g, '<a href="$2" class="text-blue-400 hover:text-blue-300 underline" target="_blank">$1</a>');
            
            // Unordered lists (- item or * item)
            html = html.replace(/^[\*\-] (.+)$/gm, '<li class="ml-4">â€¢ $1</li>');
            
            // Numbered lists (1. item)
            html = html.replace(/^\d+\. (.+)$/gm, '<li class="ml-4 list-decimal">$1</li>');
            
            // Line breaks
            html = html.replace(/\n\n/g, '</p><p class="mb-2">');
            html = html.replace(/\n/g, '<br>');
            
            return '<div class="markdown-content">' + html + '</div>';
        }

        // Invoice functions
        // Exchange rates (approximate)
        const EUR_TO_RON = 4.97;   // 1 EUR = ~4.97 RON
        const GBP_TO_EUR = 1.17;   // 1 GBP = ~1.17 EUR
        const USD_TO_EUR = 0.95;   // 1 USD = ~0.95 EUR
        
        let dfwInvoices = [];
        let contrastInvoices = [];
        let jtapeInvoices = [];
        let ambaInvoices = [];
        let supplierInvoices = [];
        let proformaInvoices = [];
        let allAttachments = [];
        let currentInvoiceTab = 'all';
        
        function parseEuropeanNumber(numStr) {
            // Convert European format (1.234,56 or 13275,00) to standard number
            // European: period = thousands separator, comma = decimal
            if (typeof numStr === 'number') return numStr;
            if (!numStr) return 0;
            const str = String(numStr);
            // Check if it's European format (has comma as decimal)
            if (str.includes(',')) {
                // Remove thousand separators (periods) and convert decimal comma to period
                return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
            }
            return parseFloat(str) || 0;
        }
        
        function convertToEur(amount, currency) {
            if (!amount) return 0;
            // Handle European number format
            const numAmount = parseEuropeanNumber(amount);
            switch(currency) {
                case 'RON': return numAmount / EUR_TO_RON;
                case 'GBP': return numAmount * GBP_TO_EUR;
                case 'USD': return numAmount * USD_TO_EUR;
                default: return numAmount;
            }
        }
        
        async function loadInvoices() {
            try {
                const response = await fetch('/api/invoices');
                invoicesData = await response.json();
                
                // Load all attachments - this handles rendering the All Attachments tab
                await loadAllAttachments();
                
                renderInvoiceSummary();
                // Note: renderAllAttachments() is called inside loadAllAttachments()
                // so we don't need to call renderInvoiceTable() here
                
                // Also load all invoice categories
                loadDfwInvoices();
                loadJtapeInvoices();
                loadAmbaInvoices();
                loadSupplierInvoices();
                loadContrastInvoices();
                loadProformaInvoices();
            } catch (error) {
                console.error('Error loading invoices:', error);
                document.getElementById('invoice-table-body').innerHTML = `
                    <tr><td colspan="6" class="px-4 py-8 text-center text-red-400">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>Error loading attachments</p>
                    </td></tr>`;
            }
        }
        
        async function loadAllAttachments() {
            try {
                const response = await fetch('/api/attachments/all');
                allAttachments = await response.json();
                console.log('Loaded attachments:', allAttachments.length);
                if (allAttachments.length > 0) {
                    console.log('Sample attachment:', allAttachments[0]);
                }
                renderAllAttachments();
                
                // Update dynamic client tabs with loaded attachments
                if (clientsList.length > 0) {
                    updateDynamicClientTabs();
                }
            } catch (error) {
                console.error('Error loading all attachments:', error);
            }
        }
        
        async function loadDfwInvoices() {
            try {
                const response = await fetch('/api/invoices/dfw');
                dfwInvoices = await response.json();
                renderDfwInvoices();
            } catch (error) {
                console.error('Error loading DFW invoices:', error);
            }
        }
        
        async function loadContrastInvoices() {
            try {
                const response = await fetch('/api/invoices/contrast');
                contrastInvoices = await response.json();
                renderContrastInvoices();
            } catch (error) {
                console.error('Error loading Contrast invoices:', error);
            }
        }
        
        async function loadProformaInvoices() {
            try {
                const response = await fetch('/api/invoices/proforma');
                proformaInvoices = await response.json();
                renderProformaInvoices();
                // Also load saved proformas from database
                await loadSavedProformas();
            } catch (error) {
                console.error('Error loading Proforma invoices:', error);
            }
        }
        
        function renderDfwInvoices() {
            const tbody = document.getElementById('dfw-invoice-table');
            
            if (dfwInvoices.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">No invoices found</td></tr>`;
                document.getElementById('dfw-invoice-count').textContent = '0 invoices';
                return;
            }
            
            // Track seen invoice numbers for duplicate detection
            const seenInvNumbers = {};
            dfwInvoices.forEach(inv => {
                seenInvNumbers[inv.invoice_number] = (seenInvNumbers[inv.invoice_number] || 0) + 1;
            });
            
            const firstSeen = {};
            tbody.innerHTML = dfwInvoices.map(inv => {
                const isDuplicate = firstSeen[inv.invoice_number];
                firstSeen[inv.invoice_number] = true;
                
                const rowClass = isDuplicate ? 'opacity-50 bg-gray-800' : '';
                const currencySymbol = 'â‚¬';
                const amountColor = 'text-blue-400';
                const amount = inv.amount 
                    ? `<span class="${isDuplicate ? 'text-gray-500' : amountColor}">${currencySymbol}${inv.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>`
                    : '<span class="text-gray-500">N/A</span>';
                
                const editAmountBtn = inv.id 
                    ? `<button onclick="editAmount(${inv.id}, ${inv.amount || 0}, '${inv.currency || 'EUR'}')" class="ml-2 text-xs text-gray-400 hover:text-yellow-400" title="Edit amount"><i class="fas fa-edit"></i></button>`
                    : '';
                
                const viewBtn = inv.attachment_id 
                    ? `<button onclick="viewAttachment(${inv.attachment_id})" class="text-green-400 hover:text-green-300 px-2" title="View PDF"><i class="fas fa-file-pdf"></i></button>`
                    : '';
                
                const removeBtn = inv.id 
                    ? `<button onclick="removeFromTab(${inv.id}, 'dfw')" class="text-red-400 hover:text-red-300 px-2" title="Remove"><i class="fas fa-times"></i></button>`
                    : '';
                
                const dupLabel = isDuplicate ? '<span class="ml-2 text-xs text-gray-500">(dup)</span>' : '';
                
                const editInvNoBtn = inv.id 
                    ? `<button onclick="editInvoiceNumber(${inv.id}, '${(inv.invoice_number || '').replace(/'/g, "\\'")}')" class="ml-1 text-xs text-gray-400 hover:text-blue-400" title="Edit invoice number"><i class="fas fa-pen"></i></button>`
                    : '';
                
                return `
                    <tr class="hover:bg-gray-700/50 transition ${rowClass}">
                        <td class="px-4 py-3 font-mono ${isDuplicate ? 'text-gray-500' : 'text-green-400'} font-bold">${escapeHtml(inv.invoice_number)}${dupLabel}${editInvNoBtn}</td>
                        <td class="px-4 py-3 text-gray-300">${inv.invoice_date || inv.email_date || 'N/A'}</td>
                        <td class="px-4 py-3 text-right">${amount}${editAmountBtn}</td>
                        <td class="px-4 py-3 text-gray-300">${escapeHtml(inv.recipient || '')}</td>
                        <td class="px-4 py-3 text-gray-400">${escapeHtml((inv.filename || '').substring(0, 30))}${(inv.filename || '').length > 30 ? '...' : ''}</td>
                        <td class="px-4 py-3 text-center">${viewBtn}${removeBtn}</td>
                    </tr>
                `;
            }).join('');
            
            // Calculate total in EUR - only count unique invoice numbers once
            const uniqueInvoices = {};
            dfwInvoices.forEach(inv => {
                if (!uniqueInvoices[inv.invoice_number] || (inv.amount && !uniqueInvoices[inv.invoice_number].amount)) {
                    uniqueInvoices[inv.invoice_number] = inv;
                }
            });
            const uniqueCount = Object.keys(uniqueInvoices).length;
            const total = Object.values(uniqueInvoices).reduce((sum, inv) => sum + convertToEur(inv.amount, inv.currency), 0);
            document.getElementById('dfw-invoice-count').textContent = `${uniqueCount} unique invoices | Total: â‚¬${total.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
        }
        
        async function loadJtapeInvoices() {
            try {
                const response = await fetch('/api/invoices/jtape');
                jtapeInvoices = await response.json();
                renderJtapeInvoices();
            } catch (error) {
                console.error('Error loading JTape invoices:', error);
            }
        }
        
        function renderJtapeInvoices() {
            const tbody = document.getElementById('jtape-invoice-table');
            
            if (jtapeInvoices.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">No JTape Purchase Orders found</td></tr>`;
                document.getElementById('jtape-invoice-count').textContent = '0 purchase orders';
                return;
            }
            
            // Track duplicates
            const firstSeen = {};
            tbody.innerHTML = jtapeInvoices.map(inv => {
                const isDuplicate = firstSeen[inv.invoice_number];
                firstSeen[inv.invoice_number] = true;
                
                const rowClass = isDuplicate ? 'opacity-50 bg-gray-800' : '';
                const amount = inv.amount 
                    ? `<span class="${isDuplicate ? 'text-gray-500' : 'text-blue-400'}">â‚¬${inv.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>`
                    : '<span class="text-gray-500">N/A</span>';
                
                const editAmountBtn = inv.id 
                    ? `<button onclick="editAmount(${inv.id}, ${inv.amount || 0}, '${inv.currency || 'EUR'}')" class="ml-2 text-xs text-gray-400 hover:text-yellow-400" title="Edit amount"><i class="fas fa-edit"></i></button>`
                    : '';
                
                const viewBtn = inv.attachment_id 
                    ? `<button onclick="viewAttachment(${inv.attachment_id})" class="text-green-400 hover:text-green-300 px-2" title="View PDF"><i class="fas fa-file-pdf"></i></button>`
                    : '';
                
                const removeBtn = inv.id 
                    ? `<button onclick="removeFromTab(${inv.id}, 'jtape')" class="text-red-400 hover:text-red-300 px-2" title="Remove"><i class="fas fa-times"></i></button>`
                    : '';
                
                const dupLabel = isDuplicate ? '<span class="ml-2 text-xs text-gray-500">(dup)</span>' : '';
                
                const dateDisplay = formatDateOnly(inv.invoice_date || inv.email_date);
                const shortFilename = (inv.filename || '').length > 25 ? (inv.filename || '').substring(0, 22) + '...' : (inv.filename || '');
                
                return `
                    <tr class="hover:bg-gray-700/50 transition ${rowClass}">
                        <td class="px-2 py-2 text-xs text-gray-300">${dateDisplay || '-'}</td>
                        <td class="px-2 py-2 font-mono text-xs ${isDuplicate ? 'text-gray-500' : 'text-orange-400'}">${escapeHtml(inv.invoice_number)}${dupLabel}</td>
                        <td class="px-2 py-2 text-right text-xs">${amount}${editAmountBtn}</td>
                        <td class="px-2 py-2 text-xs text-gray-300 truncate max-w-[100px]">JTape Limited</td>
                        <td class="px-2 py-2 text-xs">
                            <a href="/api/attachment/${inv.attachment_id}" target="_blank" class="text-green-400 hover:text-green-300" title="${escapeHtml(inv.filename || '')}">${escapeHtml(shortFilename)}</a>
                        </td>
                        <td class="px-2 py-2 text-center">${viewBtn}${removeBtn}</td>
                    </tr>
                `;
            }).join('');
            
            // Calculate total - deduplicate by invoice number
            const uniqueInvoices = {};
            jtapeInvoices.forEach(inv => {
                if (!uniqueInvoices[inv.invoice_number] || (inv.amount && !uniqueInvoices[inv.invoice_number].amount)) {
                    uniqueInvoices[inv.invoice_number] = inv;
                }
            });
            const uniqueCount = Object.keys(uniqueInvoices).length;
            const total = Object.values(uniqueInvoices).reduce((sum, inv) => sum + (inv.amount || 0), 0);
            document.getElementById('jtape-invoice-count').textContent = `${uniqueCount} unique orders | Total: â‚¬${total.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
        }
        
        async function loadAmbaInvoices() {
            try {
                const response = await fetch('/api/invoices/amba');
                ambaInvoices = await response.json();
                renderAmbaInvoices();
            } catch (error) {
                console.error('Error loading Amba invoices:', error);
            }
        }
        
        function renderAmbaInvoices() {
            const tbody = document.getElementById('amba-invoice-table');
            
            if (ambaInvoices.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">No Amba/BAXT Purchase Orders found</td></tr>`;
                document.getElementById('amba-invoice-count').textContent = '0 purchase orders';
                return;
            }
            
            // Track duplicates
            const firstSeen = {};
            tbody.innerHTML = ambaInvoices.map(inv => {
                const isDuplicate = firstSeen[inv.invoice_number];
                firstSeen[inv.invoice_number] = true;
                
                const rowClass = isDuplicate ? 'opacity-50 bg-gray-800' : '';
                const amount = inv.amount 
                    ? `<span class="${isDuplicate ? 'text-gray-500' : 'text-blue-400'}">â‚¬${inv.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>`
                    : '<span class="text-gray-500">N/A</span>';
                
                const viewBtn = inv.attachment_id 
                    ? `<button onclick="viewAttachment(${inv.attachment_id})" class="text-green-400 hover:text-green-300 px-2" title="View PDF"><i class="fas fa-file-pdf"></i></button>`
                    : '';
                
                const removeBtn = inv.id 
                    ? `<button onclick="removeFromTab(${inv.id}, 'amba')" class="text-red-400 hover:text-red-300 px-2" title="Remove"><i class="fas fa-times"></i></button>`
                    : '';
                
                const dupLabel = isDuplicate ? '<span class="ml-2 text-xs text-gray-500">(dup)</span>' : '';
                
                const dateDisplay = formatDateOnly(inv.invoice_date || inv.email_date);
                const shortFilename = (inv.filename || '').length > 25 ? (inv.filename || '').substring(0, 22) + '...' : (inv.filename || '');
                
                return `
                    <tr class="hover:bg-gray-700/50 transition ${rowClass}">
                        <td class="px-2 py-2 text-xs text-gray-300">${dateDisplay || '-'}</td>
                        <td class="px-2 py-2 font-mono text-xs ${isDuplicate ? 'text-gray-500' : 'text-pink-400'}">${escapeHtml(inv.invoice_number)}${dupLabel}</td>
                        <td class="px-2 py-2 text-right text-xs">${amount}</td>
                        <td class="px-2 py-2 text-xs text-gray-300 truncate max-w-[100px]">${escapeHtml(inv.customer || 'Amba/BAXT')}</td>
                        <td class="px-2 py-2 text-xs">
                            <a href="/api/attachment/${inv.attachment_id}" target="_blank" class="text-green-400 hover:text-green-300" title="${escapeHtml(inv.filename || '')}">${escapeHtml(shortFilename)}</a>
                        </td>
                        <td class="px-2 py-2 text-center">${viewBtn}${removeBtn}</td>
                    </tr>
                `;
            }).join('');
            
            // Calculate total - deduplicate by invoice number
            const uniqueInvoices = {};
            ambaInvoices.forEach(inv => {
                if (!uniqueInvoices[inv.invoice_number] || (inv.amount && !uniqueInvoices[inv.invoice_number].amount)) {
                    uniqueInvoices[inv.invoice_number] = inv;
                }
            });
            const uniqueCount = Object.keys(uniqueInvoices).length;
            const total = Object.values(uniqueInvoices).reduce((sum, inv) => sum + (inv.amount || 0), 0);
            document.getElementById('amba-invoice-count').textContent = `${uniqueCount} unique orders | Total: â‚¬${total.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
        }
        
        async function loadSupplierInvoices() {
            try {
                const response = await fetch('/api/invoices/supplier');
                supplierInvoices = await response.json();
                renderSupplierInvoices();
            } catch (error) {
                console.error('Error loading Supplier invoices:', error);
            }
        }
        
        function renderSupplierInvoices() {
            const tbody = document.getElementById('supplier-invoice-table');
            
            if (supplierInvoices.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">No Rotopak IKE invoices found</td></tr>`;
                document.getElementById('supplier-invoice-count').textContent = '0 invoices';
                return;
            }
            
            // Track duplicates
            const firstSeen = {};
            tbody.innerHTML = supplierInvoices.map(inv => {
                const isDuplicate = firstSeen[inv.invoice_number];
                firstSeen[inv.invoice_number] = true;
                
                const rowClass = isDuplicate ? 'opacity-50 bg-gray-800' : '';
                const amount = inv.amount 
                    ? `<span class="${isDuplicate ? 'text-gray-500' : 'text-blue-400'}">â‚¬${convertToEur(inv.amount, inv.currency).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>`
                    : '<span class="text-gray-500">N/A</span>';
                
                const viewBtn = inv.attachment_id 
                    ? `<button onclick="viewAttachment(${inv.attachment_id})" class="text-green-400 hover:text-green-300 px-2" title="View PDF"><i class="fas fa-file-pdf"></i></button>`
                    : '';
                
                const removeBtn = inv.id 
                    ? `<button onclick="removeFromTab(${inv.id}, 'supplier')" class="text-red-400 hover:text-red-300 px-2" title="Remove"><i class="fas fa-times"></i></button>`
                    : '';
                
                const dupLabel = isDuplicate ? '<span class="ml-2 text-xs text-gray-500">(dup)</span>' : '';
                
                const dateDisplay = formatDateOnly(inv.invoice_date || inv.email_date);
                const shortFilename = (inv.filename || '').length > 25 ? (inv.filename || '').substring(0, 22) + '...' : (inv.filename || '');
                
                return `
                    <tr class="hover:bg-gray-700/50 transition ${rowClass}">
                        <td class="px-2 py-2 text-xs text-gray-300">${dateDisplay || '-'}</td>
                        <td class="px-2 py-2 font-mono text-xs ${isDuplicate ? 'text-gray-500' : 'text-cyan-400'}">${escapeHtml(inv.invoice_number)}${dupLabel}</td>
                        <td class="px-2 py-2 text-right text-xs">${amount}</td>
                        <td class="px-2 py-2 text-xs text-gray-300 truncate max-w-[100px]">${escapeHtml(inv.supplier || 'Rotopak IKE')}</td>
                        <td class="px-2 py-2 text-xs">
                            <a href="/api/attachment/${inv.attachment_id}" target="_blank" class="text-green-400 hover:text-green-300" title="${escapeHtml(inv.filename || '')}">${escapeHtml(shortFilename)}</a>
                        </td>
                        <td class="px-2 py-2 text-center">${viewBtn}${removeBtn}</td>
                    </tr>
                `;
            }).join('');
            
            // Calculate total in EUR - deduplicate
            const uniqueInvoices = {};
            supplierInvoices.forEach(inv => {
                if (!uniqueInvoices[inv.invoice_number] || (inv.amount && !uniqueInvoices[inv.invoice_number].amount)) {
                    uniqueInvoices[inv.invoice_number] = inv;
                }
            });
            const uniqueCount = Object.keys(uniqueInvoices).length;
            const total = Object.values(uniqueInvoices).reduce((sum, inv) => sum + convertToEur(inv.amount, inv.currency), 0);
            document.getElementById('supplier-invoice-count').textContent = `${uniqueCount} unique invoices | Total: â‚¬${total.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
        }
        
        function renderContrastInvoices() {
            const tbody = document.getElementById('contrast-invoice-table');
            
            if (contrastInvoices.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">No Contrast Accounting invoices found</td></tr>`;
                document.getElementById('contrast-invoice-count').textContent = '0 invoices';
                return;
            }
            
            // Track duplicates
            const firstSeen = {};
            tbody.innerHTML = contrastInvoices.map(inv => {
                const isDuplicate = firstSeen[inv.invoice_number];
                firstSeen[inv.invoice_number] = true;
                
                const rowClass = isDuplicate ? 'opacity-50 bg-gray-800' : '';
                const amount = inv.amount 
                    ? `<span class="${isDuplicate ? 'text-gray-500' : 'text-blue-400'}">â‚¬${convertToEur(inv.amount, inv.currency).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>`
                    : '<span class="text-gray-500">N/A</span>';
                
                const viewBtn = inv.attachment_id 
                    ? `<button onclick="viewAttachment(${inv.attachment_id})" class="text-green-400 hover:text-green-300 px-2" title="View PDF"><i class="fas fa-file-pdf"></i></button>`
                    : '';
                
                const removeBtn = inv.id 
                    ? `<button onclick="removeFromTab(${inv.id}, 'contrast')" class="text-red-400 hover:text-red-300 px-2" title="Remove"><i class="fas fa-times"></i></button>`
                    : '';
                
                const dupLabel = isDuplicate ? '<span class="ml-2 text-xs text-gray-500">(dup)</span>' : '';
                
                const dateDisplay = formatDateOnly(inv.invoice_date || inv.email_date);
                const shortFilename = (inv.filename || '').length > 25 ? (inv.filename || '').substring(0, 22) + '...' : (inv.filename || '');
                
                return `
                    <tr class="hover:bg-gray-700/50 transition ${rowClass}">
                        <td class="px-2 py-2 text-xs text-gray-300">${dateDisplay || '-'}</td>
                        <td class="px-2 py-2 font-mono text-xs ${isDuplicate ? 'text-gray-500' : 'text-purple-400'}">${escapeHtml(inv.invoice_number)}${dupLabel}</td>
                        <td class="px-2 py-2 text-right text-xs">${amount}</td>
                        <td class="px-2 py-2 text-xs text-gray-300 truncate max-w-[100px]">${escapeHtml(inv.sender || 'Contrast')}</td>
                        <td class="px-2 py-2 text-xs">
                            <a href="/api/attachment/${inv.attachment_id}" target="_blank" class="text-green-400 hover:text-green-300" title="${escapeHtml(inv.filename || '')}">${escapeHtml(shortFilename)}</a>
                        </td>
                        <td class="px-2 py-2 text-center">${viewBtn}${removeBtn}</td>
                    </tr>
                `;
            }).join('');
            
            // Calculate total in EUR - deduplicate
            const uniqueInvoices = {};
            contrastInvoices.forEach(inv => {
                if (!uniqueInvoices[inv.invoice_number] || (inv.amount && !uniqueInvoices[inv.invoice_number].amount)) {
                    uniqueInvoices[inv.invoice_number] = inv;
                }
            });
            const uniqueCount = Object.keys(uniqueInvoices).length;
            const total = Object.values(uniqueInvoices).reduce((sum, inv) => sum + convertToEur(inv.amount, inv.currency), 0);
            document.getElementById('contrast-invoice-count').textContent = `${uniqueCount} unique invoices | Total: â‚¬${total.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
        }
        
        function renderProformaInvoices() {
            const tbody = document.getElementById('proforma-invoice-table');
            
            if (proformaInvoices.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-8 text-center text-gray-400">No Pro Forma invoices found</td></tr>`;
                document.getElementById('proforma-invoice-count').textContent = '0 proformas';
                return;
            }
            
            // Track duplicates
            const firstSeen = {};
            tbody.innerHTML = proformaInvoices.map(inv => {
                const isDuplicate = firstSeen[inv.invoice_number];
                firstSeen[inv.invoice_number] = true;
                
                const rowClass = isDuplicate ? 'opacity-50 bg-gray-800' : '';
                const amount = inv.amount 
                    ? `<span class="${isDuplicate ? 'text-gray-500' : 'text-blue-400'}">â‚¬${convertToEur(inv.amount, inv.currency).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>`
                    : '<span class="text-gray-500">N/A</span>';
                
                const viewBtn = inv.attachment_id 
                    ? `<button onclick="viewAttachment(${inv.attachment_id})" class="text-green-400 hover:text-green-300 px-2" title="View PDF"><i class="fas fa-file-pdf"></i></button>`
                    : '';
                
                const removeBtn = inv.id 
                    ? `<button onclick="removeFromTab(${inv.id}, 'proforma')" class="text-red-400 hover:text-red-300 px-2" title="Remove from Pro Forma"><i class="fas fa-times"></i></button>`
                    : '';
                
                const dupLabel = isDuplicate ? '<span class="ml-2 text-xs text-gray-500">(dup)</span>' : '';
                
                return `
                    <tr class="hover:bg-gray-700/50 transition ${rowClass}">
                        <td class="px-4 py-3 text-gray-300">${inv.invoice_date || inv.email_date || 'N/A'}</td>
                        <td class="px-4 py-3 font-mono ${isDuplicate ? 'text-gray-500' : 'text-yellow-400'} font-bold">${escapeHtml(inv.invoice_number)}${dupLabel}</td>
                        <td class="px-4 py-3 text-gray-400 max-w-xs truncate" title="${escapeHtml(inv.filename)}">${escapeHtml(inv.filename)}</td>
                        <td class="px-4 py-3 text-right">${amount}</td>
                        <td class="px-4 py-3 text-center">${viewBtn}${removeBtn}</td>
                    </tr>
                `;
            }).join('');
            
            // Calculate total in EUR - deduplicate by invoice number
            const uniqueInvoices = {};
            proformaInvoices.forEach(inv => {
                if (!uniqueInvoices[inv.invoice_number] || (inv.amount && !uniqueInvoices[inv.invoice_number].amount)) {
                    uniqueInvoices[inv.invoice_number] = inv;
                }
            });
            const uniqueCount = Object.keys(uniqueInvoices).length;
            const total = Object.values(uniqueInvoices).reduce((sum, inv) => sum + convertToEur(inv.amount, inv.currency), 0);
            document.getElementById('proforma-invoice-count').textContent = `${uniqueCount} unique proformas | Total: â‚¬${total.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
        }
        
        // Load saved pro forma invoices from database
        let savedProformasLoaded = []; // Track loaded saved proformas to avoid duplicates
        async function loadSavedProformas() {
            try {
                const response = await fetch('/api/proforma/list');
                savedProformasLoaded = await response.json();
                
                // Re-render proformas with saved ones included (avoid duplicates)
                renderProformaInvoicesWithSaved();
            } catch (error) {
                console.error('Error loading saved proformas:', error);
            }
        }
        
        function renderProformaInvoicesWithSaved() {
            const tbody = document.getElementById('proforma-invoice-table');
            
            // First render saved proformas (created in app)
            const savedRows = savedProformasLoaded.map(pf => {
                const statusClass = pf.status === 'PAID' ? 'bg-green-600' : 'bg-red-600';
                const statusText = pf.status || 'UNPAID';
                return `
                <tr class="hover:bg-gray-700/50 transition bg-green-900/20" data-saved-proforma="${pf.id}">
                    <td class="px-4 py-3 text-gray-300">${pf.invoice_date || 'N/A'}</td>
                    <td class="px-4 py-3 font-mono text-green-400 font-bold">
                        ${escapeHtml(pf.invoice_number)}
                    </td>
                    <td class="px-4 py-3 text-gray-400">${escapeHtml((pf.bill_to || '').split('\\n')[0])}</td>
                    <td class="px-4 py-3 text-right text-green-400">â‚¬${(pf.total || 0).toLocaleString('de-DE', {minimumFractionDigits: 2})}</td>
                    <td class="px-4 py-3 text-center">
                        <select onchange="updateProformaStatus(${pf.id}, this.value)" class="text-xs px-2 py-1 rounded ${statusClass} text-white border-0 cursor-pointer">
                            <option value="UNPAID" ${statusText === 'UNPAID' ? 'selected' : ''}>UNPAID</option>
                            <option value="PAID" ${statusText === 'PAID' ? 'selected' : ''}>PAID</option>
                        </select>
                        <button onclick="editProforma(${pf.id})" class="text-blue-400 hover:text-blue-300 px-2 ml-2" title="Edit"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteProforma(${pf.id})" class="text-red-400 hover:text-red-300 px-2" title="Delete"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `}).join('');
            
            // Then render email-extracted proformas
            const emailRows = proformaInvoices.map(inv => `
                <tr class="hover:bg-gray-700/50 transition">
                    <td class="px-4 py-3 text-gray-300">${inv.invoice_date || inv.email_date || 'N/A'}</td>
                    <td class="px-4 py-3 font-mono text-yellow-400">${escapeHtml(inv.invoice_number || 'N/A')}</td>
                    <td class="px-4 py-3 text-gray-400">${escapeHtml(inv.recipient || '')}</td>
                    <td class="px-4 py-3 text-right text-blue-400">${inv.amount ? 'â‚¬' + inv.amount.toLocaleString('de-DE', {minimumFractionDigits: 2}) : '-'}</td>
                    <td class="px-4 py-3 text-center">
                        ${inv.attachment_id ? `<button onclick="viewAttachment(${inv.attachment_id})" class="text-green-400 hover:text-green-300 px-2" title="View PDF"><i class="fas fa-file-pdf"></i></button>` : ''}
                    </td>
                </tr>
            `).join('');
            
            tbody.innerHTML = savedRows + emailRows;
            
            // Update count
            const totalCount = savedProformasLoaded.length + proformaInvoices.length;
            document.getElementById('proforma-invoice-count').textContent = `${totalCount} pro forma invoices`;
        }
        
        function editProforma(id) {
            window.open(`/proforma?id=${id}`, '_blank');
        }
        
        async function updateProformaStatus(id, status) {
            try {
                await fetch(`/api/proforma/status/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                // Reload proformas
                loadProformaInvoices();
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }
        
        async function deleteProforma(id) {
            if (!confirm('Delete this pro forma invoice?')) return;
            try {
                await fetch(`/api/proforma/delete/${id}`, { method: 'DELETE' });
                // Reload proformas
                loadProformaInvoices();
            } catch (error) {
                console.error('Error deleting proforma:', error);
            }
        }
        
        async function removeFromTab(parsedId, tabName) {
            if (!confirm('Remove this attachment from this tab?')) return;
            try {
                await fetch(`/api/attachment/assign/${parsedId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tab: '' })
                });
                // Reload all data
                await loadAllAttachments();
                loadDfwInvoices();
                loadJtapeInvoices();
                loadAmbaInvoices();
                loadSupplierInvoices();
                loadContrastInvoices();
                loadProformaInvoices();
                updateInvoiceSummaryForTab(currentInvoiceTab);
            } catch (error) {
                console.error('Error removing from tab:', error);
                alert('Failed to remove attachment');
            }
        }
        
        function showInvoiceSubTab(tabName) {
            // Update current tab tracker
            currentInvoiceTab = tabName;
            
            // Hide all sub-panels
            document.querySelectorAll('.inv-subpanel').forEach(p => p.classList.add('hidden'));
            // Reset all sub-tabs
            document.querySelectorAll('.inv-subtab').forEach(t => {
                t.classList.remove('bg-green-600', 'text-white');
                t.classList.add('bg-gray-700', 'text-gray-300');
            });
            
            // Show selected panel
            document.getElementById('inv-panel-' + tabName).classList.remove('hidden');
            // Highlight selected tab
            const activeTab = document.getElementById('inv-subtab-' + tabName);
            activeTab.classList.remove('bg-gray-700', 'text-gray-300');
            activeTab.classList.add('bg-green-600', 'text-white');
            
            // Update summary for this tab
            updateInvoiceSummaryForTab(tabName);
        }
        
        function viewAttachment(attachmentId) {
            // Open PDF in new tab
            window.open('/api/attachment/' + attachmentId, '_blank');
        }

        function renderInvoiceSummary() {
            // Calculate totals based on current tab - all amounts converted to EUR
            updateInvoiceSummaryForTab(currentInvoiceTab);
        }
        
        function updateInvoiceSummaryForTab(tabName) {
            let invoices = [];
            let tabLabel = 'All Attachments';
            
            switch(tabName) {
                case 'all':
                    // Use all attachments for 'all' tab
                    if (allAttachments && allAttachments.length > 0) {
                        invoices = allAttachments;
                    } else if (invoicesData && invoicesData.parsed_invoices) {
                        invoices = invoicesData.parsed_invoices;
                    }
                    tabLabel = 'All Attachments';
                    // Count will be updated by renderAllAttachments
                    return;
                case 'dfw':
                    invoices = dfwInvoices;
                    tabLabel = 'DFW Professional SRL';
                    break;
                case 'jtape':
                    invoices = jtapeInvoices;
                    tabLabel = 'JTape';
                    break;
                case 'amba':
                    invoices = ambaInvoices;
                    tabLabel = 'Amba/BAXT';
                    break;
                case 'supplier':
                    invoices = supplierInvoices;
                    tabLabel = 'Supplier';
                    break;
                case 'contrast':
                    invoices = contrastInvoices;
                    tabLabel = 'Accounting';
                    break;
                case 'proforma':
                    invoices = proformaInvoices;
                    tabLabel = 'Pro Forma';
                    break;
            }
            
            // Deduplicate by invoice number for accurate counts
            const uniqueInvoices = {};
            invoices.forEach(inv => {
                const key = inv.invoice_number || inv.id;
                if (!uniqueInvoices[key] || (inv.amount && !uniqueInvoices[key].amount)) {
                    uniqueInvoices[key] = inv;
                }
            });
            
            // Calculate total in EUR (converting any other currencies)
            let totalEur = 0;
            const uniqueList = Object.values(uniqueInvoices);
            const count = uniqueList.length;
            
            uniqueList.forEach(inv => {
                totalEur += convertToEur(inv.amount, inv.currency);
            });
            
            document.getElementById('inv-pdf-count').textContent = count;
            document.getElementById('inv-total-eur').textContent = 'â‚¬' + totalEur.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            // Calculate year total from all attachments
            updateYearTotal();
        }
        
        function updateYearTotal() {
            const currentYear = new Date().getFullYear();
            document.getElementById('current-year').textContent = currentYear;
            
            // Get invoices for current tab
            let invoices = [];
            switch(currentInvoiceTab) {
                case 'all':
                    invoices = allAttachments || [];
                    break;
                case 'dfw':
                    invoices = dfwInvoices || [];
                    break;
                case 'jtape':
                    invoices = jtapeInvoices || [];
                    break;
                case 'amba':
                    invoices = ambaInvoices || [];
                    break;
                case 'supplier':
                    invoices = supplierInvoices || [];
                    break;
                case 'contrast':
                    invoices = contrastInvoices || [];
                    break;
                case 'proforma':
                    invoices = proformaInvoices || [];
                    break;
                default:
                    // Handle dynamic client tabs
                    if (currentInvoiceTab && currentInvoiceTab.startsWith('client-')) {
                        const clientId = currentInvoiceTab.replace('client-', '');
                        invoices = (clientInvoices && clientInvoices[clientId]) || [];
                    } else {
                        invoices = allAttachments || [];
                    }
            }
            
            let yearTotal = 0;
            invoices.forEach(inv => {
                const dateField = inv.email_date || inv.invoice_date || inv.date;
                if (dateField) {
                    const invYear = new Date(dateField).getFullYear();
                    if (invYear === currentYear && inv.amount) {
                        yearTotal += convertToEur(inv.amount, inv.currency);
                    }
                }
            });
            
            document.getElementById('inv-year-total').textContent = 'â‚¬' + yearTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        
        function renderAllAttachments() {
            const searchTerm = document.getElementById('invoice-search')?.value?.toLowerCase() || '';
            const tabFilter = document.getElementById('invoice-tab-filter')?.value || 'all';
            const tbody = document.getElementById('invoice-table-body');
            
            if (!allAttachments || allAttachments.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">
                        <i class="fas fa-paperclip text-2xl mb-2"></i>
                        <p>No attachments found</p>
                    </td></tr>`;
                return;
            }
            
            // Filter by search and tab
            let filtered = allAttachments.filter(att => {
                // Search filter
                if (searchTerm) {
                    const searchFields = [att.filename, att.sender, att.subject, att.email_date].join(' ').toLowerCase();
                    if (!searchFields.includes(searchTerm)) return false;
                }
                
                // Tab filter
                if (tabFilter !== 'all') {
                    const currentTab = att.assigned_tab || att.detected_tab || '';
                    if (tabFilter === 'unassigned') {
                        if (currentTab !== '') return false;
                    } else {
                        if (currentTab !== tabFilter) return false;
                    }
                }
                
                return true;
            });
            
            tbody.innerHTML = filtered.map((att, idx) => {
                // Debug first attachment
                if (idx === 0) {
                    console.log('Rendering first attachment:', {
                        filename: att.filename,
                        assigned_tab: att.assigned_tab,
                        detected_tab: att.detected_tab,
                        parsed_id: att.parsed_id
                    });
                }
                
                // Convert all amounts to EUR for display
                let displayAmount = att.amount;
                if (att.amount && att.currency === 'RON') {
                    displayAmount = att.amount / 4.97;
                }
                
                // Show tab assignment (assigned takes priority, then detected)
                const tabName = att.assigned_tab || att.detected_tab || '';
                const tabLabels = {
                    'dfw': 'My Invoices',
                    'jtape': 'JTape',
                    'amba': 'Amba/BAXT',
                    'supplier': 'Supplier',
                    'contrast': 'Contrast',
                    'proforma': 'Pro Forma'
                };
                const tabColors = {
                    'dfw': 'bg-green-600',
                    'jtape': 'bg-blue-600', 
                    'amba': 'bg-orange-600',
                    'supplier': 'bg-cyan-600',
                    'contrast': 'bg-pink-600',
                    'proforma': 'bg-yellow-600'
                };
                
                // Show which list this is in
                const listBadge = tabName 
                    ? `<span class="px-3 py-1 text-xs font-semibold ${tabColors[tabName]} rounded-full">${tabLabels[tabName]}</span>` 
                    : '<span class="px-3 py-1 text-xs bg-gray-600 rounded-full">Not in any list</span>';
                
                const editAmountBtn = att.parsed_id 
                    ? `<button onclick="editAmount(${att.parsed_id}, ${att.amount || 0}, '${att.currency || 'EUR'}')" class="ml-2 text-xs text-gray-400 hover:text-yellow-400" title="Edit amount"><i class="fas fa-edit"></i></button>`
                    : '';
                
                const aiSuggestBtn = (att.parsed_id && (!att.amount || att.amount == 0)) 
                    ? `<button onclick="suggestAmount(${att.parsed_id})" class="ml-2 text-xs text-purple-400 hover:text-purple-300" title="AI suggest amount"><i class="fas fa-brain"></i></button>`
                    : '';
                
                // Check if this is an app-created invoice (no attachment file)
                const isAppCreated = !att.id || att.is_app_created;
                
                // Truncate filename to 20 chars for better fit
                const shortFilename = (att.filename || '').length > 20 
                    ? (att.filename || '').substring(0, 17) + '...' 
                    : (att.filename || '');
                
                // Mark manually edited amounts with violet color
                const amountClass = att.amount_edited ? 'text-violet-400' : 'text-blue-400';
                const amountDisplay = displayAmount 
                    ? `<span class="${amountClass}">â‚¬${parseFloat(displayAmount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>`
                    : '<span class="text-gray-500">-</span>';
                
                // File column - hide for app-created invoices
                const fileCell = isAppCreated 
                    ? '<span class="text-gray-500 text-xs">-</span>'
                    : `<a href="/api/attachment/${att.id}" target="_blank" class="text-green-400 hover:text-green-300 hover:underline cursor-pointer" title="${escapeHtml(att.filename || '')}">${escapeHtml(shortFilename)}</a>`;
                
                return `
                    <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                        <td class="px-2 py-2 text-xs">${att.email_date ? formatDateOnly(att.email_date) : '-'}</td>
                        <td class="px-2 py-2 font-mono text-xs">${escapeHtml(att.invoice_number || 'N/A')}</td>
                        <td class="px-2 py-2 text-right text-xs">${amountDisplay}${editAmountBtn}${aiSuggestBtn}</td>
                        <td class="px-2 py-2 text-xs truncate max-w-[100px]" title="${escapeHtml(att.sender || '')}">${escapeHtml((att.sender || '-').substring(0, 15))}</td>
                        <td class="px-1 py-2 text-xs max-w-[80px] truncate">
                            ${fileCell}
                        </td>
                        <td class="px-2 py-2">
                            <div class="flex items-center gap-1 justify-center flex-nowrap">
                                ${listBadge}
                                ${att.parsed_id ? `
                                <select onchange="assignAttachmentToTab(${att.parsed_id}, this.value)" class="px-1 py-0.5 text-xs bg-blue-600 hover:bg-blue-700 border-0 rounded text-white cursor-pointer" title="Assign to list">
                                    <option value="">+List</option>
                                    <option value="dfw">My Inv</option>
                                    <option value="jtape">JTape</option>
                                    <option value="amba">Amba</option>
                                    <option value="supplier">Supplier</option>
                                    <option value="contrast">Contrast</option>
                                    <option value="proforma">ProForma</option>
                                </select>` : ''}
                                ${(att.parsed_id && tabName) ? `<button onclick="removeFromList(${att.parsed_id})" class="px-1 py-0.5 text-xs bg-orange-600 hover:bg-orange-700 rounded" title="Remove from list"><i class="fas fa-times"></i></button>` : ''}
                            </div>
                        </td>
                    </tr>`;
            }).join('');
            
            // Update both top count and pagination
            document.getElementById('inv-pdf-count').textContent = filtered.length;
            document.getElementById('inv-total-eur').textContent = '-';
            document.getElementById('invoice-pagination').textContent = `Showing ${filtered.length} of ${allAttachments.length} attachments`;
        }
        
        async function hideAttachment(parsedId) {
            if (!confirm('Hide this attachment from all views?')) return;
            try {
                await fetch(`/api/attachment/hide/${parsedId}`, { method: 'POST' });
                await loadAllAttachments();
                await loadInvoices();
            } catch (error) {
                console.error('Error hiding attachment:', error);
                alert('Failed to hide attachment');
            }
        }
        
        function showAssignModal(parsedId, filename) {
            const tab = prompt(`Assign "${filename}" to which tab?\n\nOptions: dfw, jtape, amba, supplier, contrast\n(Leave empty to unassign)`);
            if (tab === null) return;
            assignAttachmentToTab(parsedId, tab);
        }
        
        async function assignAttachmentToTab(parsedId, tab) {
            if (!tab) return; // Ignore "Assign to..." selection
            try {
                await fetch(`/api/attachment/assign/${parsedId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tab: tab })
                });
                // Reload all data to reflect the change
                await loadAllAttachments();
                loadDfwInvoices();
                loadJtapeInvoices();
                loadAmbaInvoices();
                loadSupplierInvoices();
                loadContrastInvoices();
                loadProformaInvoices();
            } catch (error) {
                console.error('Error assigning attachment:', error);
                alert('Failed to assign attachment');
            }
        }
        
        async function removeFromList(parsedId) {
            // Remove from current list by setting assigned_tab to null
            try {
                await fetch(`/api/attachment/assign/${parsedId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tab: null })
                });
                // Reload all data to reflect the change
                await loadAllAttachments();
                loadDfwInvoices();
                loadJtapeInvoices();
                loadAmbaInvoices();
                loadSupplierInvoices();
                loadContrastInvoices();
                loadProformaInvoices();
            } catch (error) {
                console.error('Error removing from list:', error);
                alert('Failed to remove from list');
            }
        }
        
        async function editAmount(parsedId, currentAmount, currentCurrency) {
            const newAmount = prompt(`Edit amount (current: ${currentCurrency} ${currentAmount || 'N/A'})\n\nEnter new amount in EUR:`, currentAmount || '');
            if (newAmount === null || newAmount === '') return;
            
            try {
                const response = await fetch(`/api/invoice/update_amount/${parsedId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: parseFloat(newAmount), currency: 'EUR' })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update amount');
                }
                
                // Reload all data to reflect the change
                await loadAllAttachments();
                loadDfwInvoices();
                loadJtapeInvoices();
                loadAmbaInvoices();
                loadSupplierInvoices();
                loadContrastInvoices();
                loadProformaInvoices();
                updateInvoiceSummaryForTab(currentInvoiceTab);
            } catch (error) {
                console.error('Error updating amount:', error);
                alert('Failed to update amount');
            }
        }
        
        async function editInvoiceNumber(parsedId, currentInvNo) {
            const newInvNo = prompt(`Edit Invoice Number:\n\nCurrent: ${currentInvNo || 'N/A'}\n\nEnter new invoice number:`, currentInvNo || '');
            if (newInvNo === null || newInvNo === '') return;
            
            try {
                const response = await fetch(`/api/invoice/update_number/${parsedId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice_number: newInvNo })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update invoice number');
                }
                
                // Reload all data to reflect the change
                await loadAllAttachments();
                loadDfwInvoices();
                loadJtapeInvoices();
                loadAmbaInvoices();
                loadSupplierInvoices();
                loadContrastInvoices();
                loadProformaInvoices();
                updateInvoiceSummaryForTab(currentInvoiceTab);
            } catch (error) {
                console.error('Error updating invoice number:', error);
                alert('Failed to update invoice number');
            }
        }

        async function suggestAmount(parsedId) {
            try {
                // Show loading indicator
                const btn = event.target.closest('button');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                btn.disabled = true;
                
                const response = await fetch('/api/invoice/suggest_amount', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ parsed_id: parsedId })
                });
                
                const data = await response.json();
                
                btn.innerHTML = originalHTML;
                btn.disabled = false;
                
                if (data.success) {
                    const similarInfo = data.similar_invoices.map(inv => 
                        `â€¢ â‚¬${inv.amount.toFixed(2)} (${inv.similarity}% similar) - ${inv.invoice_number}`
                    ).join('\\n');
                    
                    const confirmed = confirm(
                        `AI Suggested Amount: â‚¬${data.suggested_amount}\\n` +
                        `Confidence: ${data.confidence}%\\n\\n` +
                        `Based on similar invoices:\\n${similarInfo}\\n\\n` +
                        `Apply this amount?`
                    );
                    
                    if (confirmed) {
                        await editAmount(parsedId, data.suggested_amount, 'EUR');
                    }
                } else {
                    alert(data.message || 'No similar invoices found to suggest amount');
                }
            } catch (error) {
                console.error('Error suggesting amount:', error);
                alert('Failed to suggest amount: ' + error.message);
            }
        }

        function renderInvoiceTable() {
            const searchTerm = document.getElementById('invoice-search').value.toLowerCase();
            
            // Combine and filter invoices - show all sources and currencies
            let allInvoices = [];
            
            // Add PDF parsed invoices
            invoicesData.parsed_invoices.forEach(inv => {
                allInvoices.push({...inv, source: 'pdf'});
            });
            
            // Add email invoices
            invoicesData.email_invoices.forEach(inv => {
                allInvoices.push({...inv, source: 'email'});
            });
            
            // Apply search filter only
            let filtered = allInvoices.filter(inv => {
                // Search filter
                if (searchTerm) {
                    const searchFields = [
                        inv.invoice_number,
                        inv.sender,
                        inv.filename,
                        inv.subject,
                        inv.email_date
                    ].join(' ').toLowerCase();
                    if (!searchFields.includes(searchTerm)) return false;
                }
                
                return true;
            });
            
            // Sort by date (newest first)
            filtered.sort((a, b) => {
                const dateA = a.email_date || '';
                const dateB = b.email_date || '';
                return dateB.localeCompare(dateA);
            });
            
            const tbody = document.getElementById('invoice-table-body');
            
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">
                        <i class="fas fa-file-invoice text-2xl mb-2"></i>
                        <p>No invoices found</p>
                    </td></tr>`;
                document.getElementById('invoice-pagination').textContent = 'No invoices match the filter';
                return;
            }
            
            tbody.innerHTML = filtered.map(inv => {
                const amount = inv.amount 
                    ? `<span class="${inv.currency === 'EUR' ? 'text-blue-400' : 'text-yellow-400'}">${inv.currency} ${inv.amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>`
                    : '<span class="text-gray-500">N/A</span>';
                
                // Build action buttons
                const actions = [];
                const emailId = inv.email_id || (inv.source === 'email' ? inv.id : null);
                if (emailId) {
                    actions.push(`<button onclick="event.stopPropagation(); viewEmail(${emailId})" class="text-blue-400 hover:text-blue-300 px-1" title="View Email"><i class="fas fa-envelope"></i></button>`);
                }
                if (inv.attachment_id) {
                    actions.push(`<button onclick="event.stopPropagation(); viewAttachment(${inv.attachment_id})" class="text-green-400 hover:text-green-300 px-1" title="View PDF"><i class="fas fa-file-pdf"></i></button>`);
                }
                
                const fileOrSubject = inv.filename 
                    ? `<span class="text-gray-300" title="${escapeHtml(inv.filename)}">${escapeHtml(inv.filename.substring(0, 35))}${inv.filename.length > 35 ? '...' : ''}</span>`
                    : `<span class="text-gray-400 italic" title="${escapeHtml(inv.subject)}">${escapeHtml((inv.subject || '').substring(0, 35))}${(inv.subject || '').length > 35 ? '...' : ''}</span>`;
                
                const clickAction = emailId ? `onclick="viewEmail(${emailId})"` : '';
                
                return `
                    <tr class="hover:bg-gray-700/50 transition cursor-pointer" ${clickAction}>
                        <td class="px-4 py-3 text-gray-300">${inv.email_date || 'N/A'}</td>
                        <td class="px-4 py-3 font-mono text-green-400">${escapeHtml(inv.invoice_number)}</td>
                        <td class="px-4 py-3 text-right">${amount}</td>
                        <td class="px-4 py-3 text-gray-300">${escapeHtml(inv.sender)}</td>
                        <td class="px-4 py-3">${fileOrSubject}</td>
                        <td class="px-4 py-3 text-center">${actions.length > 0 ? actions.join('') : '<span class="text-gray-500">-</span>'}</td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('invoice-pagination').textContent = `Showing ${filtered.length} invoices`;
        }

        function filterInvoices() {
            // Use the new All Attachments renderer
            renderAllAttachments();
        }

        // Close modal on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeInvoiceRules();
            }
        });

        // Search on enter
        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchEmails();
        });

        function openInvoiceRules() {
            document.getElementById('invoice-rules-modal').classList.remove('hidden');
        }

        function closeInvoiceRules() {
            document.getElementById('invoice-rules-modal').classList.add('hidden');
        }
        
        // ========== PRODUCTION TAB FUNCTIONS ==========
        let productionFeedback = [];
        let productionRuns = [];
        let latestOrders = [];
        
        async function loadProductionData() {
            try {
                // Load feedback
                const feedbackRes = await fetch('/api/production/feedback');
                productionFeedback = await feedbackRes.json();
                renderProductionFeedback();
                
                // Load production runs
                const runsRes = await fetch('/api/production/runs');
                productionRuns = await runsRes.json();
                renderProductionRuns();
                
                // Load latest orders for timeline
                const ordersRes = await fetch('/api/production/orders');
                latestOrders = await ordersRes.json();
                renderOrdersTimeline();
                
                // Load production files
                loadProductionFiles();
            } catch (error) {
                console.error('Error loading production data:', error);
            }
        }
        
        function renderProductionFeedback() {
            const container = document.getElementById('production-feedback-list');
            if (!productionFeedback || productionFeedback.length === 0) {
                container.innerHTML = `<div class="p-6 text-center text-gray-400">
                    <i class="fas fa-clipboard text-3xl mb-2"></i>
                    <p class="text-sm">No feedback yet</p>
                </div>`;
                return;
            }
            
            container.innerHTML = productionFeedback.map(fb => {
                const files = fb.files || [];
                const images = files.filter(f => /\.(jpg|jpeg|png|gif|webp)$/i.test(f.name || f.filename));
                
                return `
                <div class="p-3 hover:bg-gray-700/50">
                    <div class="flex items-start justify-between gap-2">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 flex-wrap">
                                ${fb.feedback_date ? `<span class="text-xs text-gray-500">${fb.feedback_date}</span>` : ''}
                                <span class="font-medium text-white text-sm truncate">${escapeHtml(fb.title)}</span>
                                <select onchange="updateFeedbackStatus(${fb.id}, this.value)" class="px-2 py-0.5 text-xs rounded bg-gray-700 border-0 cursor-pointer ${fb.status === 'resolved' ? 'text-green-400' : fb.status === 'pending' ? 'text-yellow-400' : 'text-red-400'}">
                                    <option value="pending" ${fb.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="resolved" ${fb.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                                    <option value="issue" ${fb.status === 'issue' ? 'selected' : ''}>Issue</option>
                                </select>
                            </div>
                            <p class="text-xs text-gray-400 mt-1 line-clamp-2">${escapeHtml(fb.description || '')}</p>
                            ${images.length > 0 ? `
                                <div class="flex gap-1 mt-2 flex-wrap">
                                    ${images.map(img => `<img src="${img.path}" class="w-12 h-12 object-cover rounded cursor-pointer hover:opacity-80" onclick="window.open('${img.path}', '_blank')">`).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex flex-col gap-1 flex-shrink-0">
                            <button onclick="openFeedbackImageUpload(${fb.id})" class="text-blue-400 hover:text-blue-300" title="Add Image">
                                <i class="fas fa-camera"></i>
                            </button>
                            <button onclick="deleteFeedback(${fb.id})" class="text-red-400 hover:text-red-300" title="Delete">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }
        
        function renderProductionRuns() {
            const tbody = document.getElementById('production-runs-table');
            if (!productionRuns || productionRuns.length === 0) {
                tbody.innerHTML = `<tr><td colspan="14" class="px-4 py-8 text-center text-gray-400">
                    <i class="fas fa-box-open text-2xl mb-2"></i>
                    <p>No production runs recorded yet</p>
                </td></tr>`;
                return;
            }
            
            const statusColors = {
                'completed': 'bg-green-600',
                'in_progress': 'bg-blue-600',
                'pending': 'bg-yellow-600',
                'failed': 'bg-red-600'
            };
            
            const formatDate = (d) => d ? d.substring(0, 10) : '-';
            
            tbody.innerHTML = productionRuns.map(run => `
                <tr class="hover:bg-gray-700/50 ${run.status === 'completed' ? 'opacity-50' : ''}">
                    <td class="px-2 py-2">${escapeHtml(run.client || '-')}</td>
                    <td class="px-2 py-2 font-mono text-green-400">
                        ${run.order_ref ? `<a href="#" onclick="viewProformaByRef('${escapeHtml(run.order_ref)}'); return false;" class="hover:underline cursor-pointer" title="View Pro Forma Invoice">${escapeHtml(run.order_ref)}</a>` : ''}
                    </td>
                    <td class="px-2 py-2">
                        ${run.product ? `<a href="#" onclick="viewProductDetails('${escapeHtml(run.product)}'); return false;" class="text-blue-400 hover:underline cursor-pointer" title="View Product Details">${escapeHtml(run.product)}</a>` : ''}
                    </td>
                    <td class="px-2 py-2 text-center">${run.quantity || ''}</td>
                    <td class="px-2 py-2 text-right">
                        <input type="number" value="${run.price_per_roll !== null && run.price_per_roll !== undefined ? run.price_per_roll : ''}" 
                            onchange="updateRunField(${run.id}, 'price_per_roll', parseFloat(this.value) || 0)"
                            class="bg-gray-700 border-0 rounded px-1 py-0.5 text-xs w-14 text-right" placeholder="0" step="0.01" title="Client price">
                    </td>
                    <td class="px-2 py-2 text-right">
                        <input type="number" value="${run.cost_per_roll !== null && run.cost_per_roll !== undefined ? run.cost_per_roll : ''}" 
                            onchange="updateRunField(${run.id}, 'cost_per_roll', parseFloat(this.value) || 0)"
                            class="bg-gray-700 border-0 rounded px-1 py-0.5 text-xs w-14 text-right" placeholder="0" step="0.01" title="Our cost">
                    </td>
                    <td class="px-2 py-2">
                        <input type="month" value="${run.eta_month || ''}" 
                            onchange="updateRunField(${run.id}, 'eta_month', this.value)"
                            class="bg-gray-700 border-0 rounded px-1 py-0.5 text-xs w-32">
                    </td>
                    <td class="px-2 py-2">
                        <input type="date" value="${run.date_ordered || ''}" 
                            onchange="updateRunField(${run.id}, 'date_ordered', this.value)"
                            class="bg-gray-700 border-0 rounded px-1 py-0.5 text-xs w-32">
                    </td>
                    <td class="px-2 py-2 text-center">
                        <input type="checkbox" ${run.downpayment_paid ? 'checked' : ''} 
                            onchange="updateRunField(${run.id}, 'downpayment_paid', this.checked ? 1 : 0)"
                            class="rounded">
                    </td>
                    <td class="px-2 py-2">
                        <input type="date" value="${run.date_prod_start || ''}" 
                            onchange="updateRunField(${run.id}, 'date_prod_start', this.value)"
                            class="bg-gray-700 border-0 rounded px-1 py-0.5 text-xs w-32">
                    </td>
                    <td class="px-2 py-2">
                        <input type="date" value="${run.date_prod_end || ''}" 
                            onchange="updateRunField(${run.id}, 'date_prod_end', this.value)"
                            class="bg-gray-700 border-0 rounded px-1 py-0.5 text-xs w-32">
                    </td>
                    <td class="px-2 py-2">
                        <input type="date" value="${run.date_warehouse || ''}" 
                            onchange="updateRunField(${run.id}, 'date_warehouse', this.value)"
                            class="bg-gray-700 border-0 rounded px-1 py-0.5 text-xs w-32">
                    </td>
                    <td class="px-2 py-2 text-center">
                        <input type="checkbox" ${run.paid_off ? 'checked' : ''} 
                            onchange="updateRunField(${run.id}, 'paid_off', this.checked ? 1 : 0)"
                            class="rounded">
                    </td>
                    <td class="px-2 py-2">
                        <input type="date" value="${run.date_delivered || ''}" 
                            onchange="updateRunField(${run.id}, 'date_delivered', this.value)"
                            class="bg-gray-700 border-0 rounded px-1 py-0.5 text-xs w-32">
                    </td>
                    <td class="px-2 py-2">
                        <select onchange="updateRunStatus(${run.id}, this.value)" class="px-1 py-0.5 text-xs rounded ${statusColors[run.status] || 'bg-gray-600'} border-0 cursor-pointer">
                            <option value="pending" ${run.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="in_progress" ${run.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                            <option value="completed" ${run.status === 'completed' ? 'selected' : ''}>Completed</option>
                            <option value="failed" ${run.status === 'failed' ? 'selected' : ''}>Failed</option>
                        </select>
                    </td>
                    <td class="px-2 py-2">
                        <input type="text" value="${escapeHtml(run.notes || '')}" 
                            onchange="updateRunField(${run.id}, 'notes', this.value)"
                            class="bg-gray-700 border-0 rounded px-1 py-0.5 text-xs w-32" placeholder="Notes...">
                    </td>
                    <td class="px-2 py-2 text-center">
                        <button onclick="editProductionRun(${run.id})" class="text-blue-400 hover:text-blue-300 px-1" title="Edit"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteProductionRun(${run.id})" class="text-red-400 hover:text-red-300 px-1" title="Delete"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
            
            // Also update the timeline
            renderOrdersTimeline();
        }
        
        async function updateRunField(id, field, value) {
            try {
                const data = {};
                data[field] = value;
                await fetch(`/api/production/runs/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                // Reload to get updated_at
                const runsRes = await fetch('/api/production/runs');
                productionRuns = await runsRes.json();
                renderOrdersTimeline(); // Refresh timeline
            } catch (error) {
                console.error('Error updating field:', error);
            }
        }
        
        function renderOrdersTimeline() {
            const container = document.getElementById('timeline-months');
            
            // Generate months from current month to 12 months ahead
            const months = [];
            const now = new Date();
            for (let i = 0; i < 13; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
                months.push({
                    key: `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`,
                    label: d.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }),
                    fullLabel: d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })
                });
            }
            
            // Filter out completed and failed runs - only show active orders
            const activeRuns = productionRuns.filter(run => 
                run.status !== 'completed' && run.status !== 'failed'
            );
            
            // Group runs by ETA month (not scheduled_month)
            const runsByMonth = {};
            activeRuns.forEach(run => {
                const month = run.eta_month || months[0].key;
                if (!runsByMonth[month]) runsByMonth[month] = [];
                runsByMonth[month].push(run);
            });
            
            const statusColors = {
                'in_progress': 'bg-blue-500',
                'pending': 'bg-yellow-500'
            };
            
            container.innerHTML = months.map(m => {
                const runs = runsByMonth[m.key] || [];
                const isCurrentMonth = m.key === `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                
                return `
                    <div class="flex-shrink-0 w-28 ${isCurrentMonth ? 'bg-blue-900/30 rounded-lg' : ''}">
                        <div class="text-center py-2 border-b border-gray-700 ${isCurrentMonth ? 'text-blue-400 font-semibold' : 'text-gray-400'}">
                            ${m.label}
                        </div>
                        <div class="p-2 min-h-[120px] flex flex-col gap-2">
                            ${runs.length === 0 ? '<div class="text-center text-gray-600 text-xs mt-4">-</div>' : 
                              runs.map(run => `
                                <div class="group relative">
                                    <div class="w-5 h-5 rounded-full ${statusColors[run.status] || 'bg-gray-500'} cursor-pointer hover:scale-125 transition mx-auto shadow-lg" 
                                         onclick="showOrderDetails(${run.id})">
                                    </div>
                                    <div class="hidden group-hover:block absolute z-20 bg-gray-900 border border-gray-600 rounded-lg p-3 text-xs w-52 left-1/2 -translate-x-1/2 top-7 shadow-xl">
                                        <div class="text-white font-semibold mb-1">${escapeHtml(run.client || 'No client')}</div>
                                        <div class="font-mono text-green-400 mb-1">${escapeHtml(run.order_ref || 'No ref')}</div>
                                        <div class="text-gray-400">${escapeHtml(run.product || '')}</div>
                                        <div class="flex items-center gap-1 mt-2">
                                            <span class="w-2 h-2 rounded-full ${statusColors[run.status] || 'bg-gray-500'}"></span>
                                            <span class="text-gray-500">${run.status === 'in_progress' ? 'In Progress' : 'Pending'}</span>
                                        </div>
                                        ${run.quantity ? `<div class="text-gray-500 mt-1">Qty: ${run.quantity}</div>` : ''}
                                        ${run.price_per_roll ? `<div class="text-gray-500">Price: â‚¬${parseFloat(run.price_per_roll).toFixed(2)}/roll</div>` : ''}
                                        ${run.notes ? `<div class="text-yellow-400 mt-2 border-t border-gray-700 pt-2"><i class="fas fa-sticky-note mr-1"></i>${escapeHtml(run.notes)}</div>` : ''}
                                    </div>
                                </div>
                              `).join('')}
                        </div>
                        <div class="text-center text-xs text-gray-600 pb-1">${runs.length > 0 ? runs.length + ' order' + (runs.length > 1 ? 's' : '') : ''}</div>
                    </div>
                `;
            }).join('');
        }
        
        function showOrderDetails(runId) {
            const run = productionRuns.find(r => r.id === runId);
            if (!run) return;
            
            alert(`ORDER DETAILS\n\nClient: ${run.client || 'N/A'}\nOrder Ref: ${run.order_ref || 'N/A'}\nProduct: ${run.product || 'N/A'}\nQuantity: ${run.quantity || 'N/A'}\nETA: ${run.eta_month || 'N/A'}\nStatus: ${run.status || 'N/A'}`);
        }
        
        async function updateFeedbackStatus(id, status) {
            try {
                await fetch(`/api/production/feedback/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                loadProductionData();
            } catch (error) {
                console.error('Error updating feedback:', error);
            }
        }
        
        async function deleteFeedback(id) {
            if (!confirm('Delete this feedback?')) return;
            try {
                await fetch(`/api/production/feedback/${id}`, { method: 'DELETE' });
                loadProductionData();
            } catch (error) {
                console.error('Error deleting feedback:', error);
            }
        }
        
        async function updateRunStatus(id, status) {
            try {
                await fetch(`/api/production/runs/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                loadProductionData();
            } catch (error) {
                console.error('Error updating run status:', error);
            }
        }
        
        function openAddFeedback() {
            // Clear form
            document.getElementById('feedback-title').value = '';
            document.getElementById('feedback-description').value = '';
            document.getElementById('feedback-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('feedback-status').value = 'pending';
            document.getElementById('feedback-files').value = '';
            document.getElementById('feedback-file-preview').innerHTML = '';
            
            document.getElementById('add-feedback-modal').classList.remove('hidden');
        }
        
        function closeFeedbackModal() {
            document.getElementById('add-feedback-modal').classList.add('hidden');
        }
        
        async function submitFeedback() {
            const title = document.getElementById('feedback-title').value.trim();
            if (!title) {
                alert('Please enter a feedback title');
                return;
            }
            
            const description = document.getElementById('feedback-description').value.trim();
            const feedbackDate = document.getElementById('feedback-date').value || null;
            const status = document.getElementById('feedback-status').value;
            const files = document.getElementById('feedback-files').files;
            
            try {
                // First save the feedback
                const response = await fetch('/api/production/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, description, status, feedback_date: feedbackDate })
                });
                const result = await response.json();
                
                // If there are files, upload them
                if (files.length > 0 && result.id) {
                    for (let i = 0; i < files.length; i++) {
                        const formData = new FormData();
                        formData.append('file', files[i]);
                        await fetch(`/api/production/feedback/${result.id}/file`, {
                            method: 'POST',
                            body: formData
                        });
                    }
                }
                
                closeFeedbackModal();
                loadProductionData();
            } catch (error) {
                console.error('Error saving feedback:', error);
                alert('Failed to save feedback');
            }
        }
        
        async function saveFeedback(data) {
            try {
                await fetch('/api/production/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                loadProductionData();
            } catch (error) {
                console.error('Error saving feedback:', error);
                alert('Failed to save feedback');
            }
        }
        
        // Products and Clients data
        let productsList = [];
        let clientsList = [];
        let proformaList = [];
        
        async function loadProductsAndClients() {
            try {
                const [productsRes, clientsRes, proformaRes] = await Promise.all([
                    fetch('/api/production/products'),
                    fetch('/api/production/clients'),
                    fetch('/api/proforma/list')
                ]);
                productsList = await productsRes.json();
                clientsList = await clientsRes.json();
                proformaList = await proformaRes.json();
                
                // Update dynamic client tabs in invoices
                updateDynamicClientTabs();
            } catch (error) {
                console.error('Error loading products/clients:', error);
            }
        }
        
        // Known static client tabs (these have hardcoded panels)
        const staticClientTabs = ['jtape', 'amba'];
        
        function updateDynamicClientTabs() {
            const tabsContainer = document.getElementById('dynamic-client-tabs');
            const panelsContainer = document.getElementById('dynamic-client-panels');
            
            if (!tabsContainer || !panelsContainer) return;
            
            // Filter out clients that already have static tabs
            const dynamicClients = clientsList.filter(c => {
                const slug = c.name.toLowerCase().replace(/[^a-z0-9]/g, '');
                return !staticClientTabs.includes(slug) && 
                       slug !== 'jtape' && 
                       !slug.includes('amba') && 
                       !slug.includes('baxt');
            });
            
            // Generate tabs
            tabsContainer.innerHTML = dynamicClients.map(client => {
                const slug = 'client-' + client.id;
                return `
                    <button onclick="showInvoiceSubTab('${slug}')" id="inv-subtab-${slug}" 
                        class="inv-subtab px-4 py-2 rounded-lg bg-gray-700 text-gray-300 font-medium transition hover:bg-gray-600">
                        <i class="fas fa-user-tag mr-2"></i>${escapeHtml(client.name)}
                    </button>
                `;
            }).join('');
            
            // Generate panels
            panelsContainer.innerHTML = dynamicClients.map(client => {
                const slug = 'client-' + client.id;
                return `
                    <div id="inv-panel-${slug}" class="inv-subpanel hidden">
                        <div class="p-4 border-b border-gray-700">
                            <p class="text-gray-400 text-sm"><i class="fas fa-info-circle mr-2"></i>Invoices related to ${escapeHtml(client.name)}</p>
                        </div>
                        <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-700 text-gray-300 sticky top-0">
                                    <tr>
                                        <th class="px-2 py-3 text-left">Date</th>
                                        <th class="px-2 py-3 text-left">Invoice #</th>
                                        <th class="px-2 py-3 text-right">Amount</th>
                                        <th class="px-2 py-3 text-left">Sender</th>
                                        <th class="px-2 py-3 text-left">File</th>
                                        <th class="px-2 py-3 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="${slug}-invoice-table" class="divide-y divide-gray-700">
                                    <tr>
                                        <td colspan="6" class="px-4 py-8 text-center text-gray-400">
                                            Loading...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="p-4 border-t border-gray-700 text-sm text-gray-400" id="${slug}-invoice-count">-</div>
                    </div>
                `;
            }).join('');
            
            // Populate invoices for dynamic clients
            dynamicClients.forEach(client => {
                renderClientInvoices(client);
            });
        }
        
        function renderClientInvoices(client) {
            const slug = 'client-' + client.id;
            const tbody = document.getElementById(`${slug}-invoice-table`);
            const countEl = document.getElementById(`${slug}-invoice-count`);
            
            if (!tbody || !allAttachments) return;
            
            // Filter attachments that match client name (case-insensitive)
            // Also check for common abbreviations/variations
            const clientName = client.name.toLowerCase();
            const searchTerms = [clientName];
            
            // Add abbreviations and variations
            if (clientName.includes('bodyshop') || clientName.includes('bsa')) {
                searchTerms.push('bodyshop', 'bsa', 'body shop');
            }
            if (clientName.includes('jtape')) {
                searchTerms.push('jtape', 'j-tape', 'j tape');
            }
            if (clientName.includes('amba') || clientName.includes('baxt')) {
                searchTerms.push('amba', 'baxt');
            }
            if (clientName.includes('gyso')) {
                searchTerms.push('gyso');
            }
            
            const matchingInvoices = allAttachments.filter(att => {
                const subject = (att.subject || '').toLowerCase();
                const from = (att.from_address || '').toLowerCase();
                const to = (att.to_address || '').toLowerCase();
                const filename = (att.filename || '').toLowerCase();
                const searchText = subject + ' ' + from + ' ' + to + ' ' + filename;
                
                return searchTerms.some(term => searchText.includes(term));
            });
            
            if (matchingInvoices.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">No invoices found for ${escapeHtml(client.name)}</td></tr>`;
                countEl.textContent = '0 invoices';
                return;
            }
            
            tbody.innerHTML = matchingInvoices.map(inv => {
                const shortFilename = (inv.filename || '').length > 25 ? (inv.filename || '').substring(0, 22) + '...' : (inv.filename || '');
                const hideBtn = inv.id ? `<button onclick="hideAttachment(${inv.id})" class="text-red-400 hover:text-red-300 px-1" title="Hide from this list"><i class="fas fa-times"></i></button>` : '';
                
                return `
                <tr class="hover:bg-gray-700/50 border-b border-gray-700">
                    <td class="px-2 py-2 text-xs text-gray-400">${inv.email_date ? formatDateOnly(inv.email_date) : '-'}</td>
                    <td class="px-2 py-2 font-mono text-xs text-green-400">${escapeHtml(inv.invoice_number || 'N/A')}</td>
                    <td class="px-2 py-2 text-right text-xs">${inv.amount ? '<span class="text-blue-400">â‚¬' + parseFloat(inv.amount).toFixed(2) + '</span>' : '<span class="text-gray-500">-</span>'}</td>
                    <td class="px-2 py-2 text-xs text-gray-400 truncate max-w-[100px]">${escapeHtml((inv.from_address || '-').substring(0, 20))}</td>
                    <td class="px-2 py-2 text-xs">
                        <a href="/api/attachment/${inv.id}" target="_blank" class="text-green-400 hover:text-green-300" title="${escapeHtml(inv.filename || '')}">${escapeHtml(shortFilename)}</a>
                    </td>
                    <td class="px-2 py-2 text-center">
                        <button onclick="viewAttachment(${inv.id})" class="text-green-400 hover:text-green-300 px-1" title="View PDF"><i class="fas fa-file-pdf"></i></button>
                        ${hideBtn}
                    </td>
                </tr>
            `}).join('');
            
            countEl.textContent = `${matchingInvoices.length} invoice${matchingInvoices.length !== 1 ? 's' : ''}`;
        }
        
        function openAddProductionRun() {
            editingRunId = null; // Reset editing mode
            // Load data and populate dropdowns
            loadProductsAndClients().then(() => {
                populateRunDropdowns();
                // Set default ETA month to current month
                const now = new Date();
                document.getElementById('run-eta-month').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                document.getElementById('run-date-ordered').value = now.toISOString().split('T')[0];
                // Clear other fields
                document.getElementById('run-client-select').value = '';
                document.getElementById('run-client-manual').value = '';
                document.getElementById('run-product-select').value = '';
                document.getElementById('run-product-manual').value = '';
                document.getElementById('run-orderref-select').value = '';
                document.getElementById('run-orderref-manual').value = '';
                document.getElementById('run-quantity').value = '';
                document.getElementById('run-price-per-roll').value = '';
                document.getElementById('run-cost-per-roll').value = '';
                document.getElementById('run-notes').value = '';
                document.getElementById('price-source-hint').textContent = 'Select client and product to auto-fill';
                document.getElementById('price-source-hint').classList.remove('text-green-400');
                document.getElementById('price-source-hint').classList.add('text-gray-500');
            });
            document.getElementById('add-run-modal').classList.remove('hidden');
        }
        
        function closeAddRunModal() {
            document.getElementById('add-run-modal').classList.add('hidden');
        }
        
        function populateRunDropdowns() {
            // Populate clients dropdown
            const clientSelect = document.getElementById('run-client-select');
            clientSelect.innerHTML = '<option value="">-- Select Client --</option>' +
                clientsList.map(c => `<option value="${escapeHtml(c.name)}" data-id="${c.id}">${escapeHtml(c.name)}</option>`).join('');
            
            // Populate products dropdown
            const productSelect = document.getElementById('run-product-select');
            productSelect.innerHTML = '<option value="">-- Select Product --</option>' +
                productsList.map(p => `<option value="${escapeHtml(p.name)}" data-id="${p.id}">${escapeHtml(p.name)}</option>`).join('');
            
            // Populate order reference dropdown from proforma invoices
            const orderRefSelect = document.getElementById('run-orderref-select');
            orderRefSelect.innerHTML = '<option value="">-- Select from Pro Forma Invoices --</option>' +
                proformaList.map(pf => {
                    const client = (pf.bill_to || '').split('\n')[0] || 'Unknown';
                    return `<option value="${escapeHtml(pf.invoice_number)}">${escapeHtml(pf.invoice_number)} - ${escapeHtml(client)} (â‚¬${(pf.total || 0).toLocaleString()})</option>`;
                }).join('');
        }
        
        async function updateRunPriceFromSelection() {
            const clientSelect = document.getElementById('run-client-select');
            const productSelect = document.getElementById('run-product-select');
            const priceInput = document.getElementById('run-price-per-roll');
            const priceHint = document.getElementById('price-source-hint');
            
            const clientName = clientSelect.value;
            const productName = productSelect.value;
            
            if (!clientName || !productName) {
                priceHint.textContent = 'Select client and product to auto-fill';
                return;
            }
            
            // Find client and product IDs
            const client = clientsList.find(c => c.name === clientName);
            const product = productsList.find(p => p.name === productName);
            
            if (!client || !product) {
                priceHint.textContent = 'Client or product not found in database';
                return;
            }
            
            try {
                const response = await fetch(`/api/production/product-price?client_id=${client.id}&product_id=${product.id}`);
                const data = await response.json();
                
                priceInput.value = data.price || 0;
                
                if (data.source === 'client') {
                    priceHint.textContent = `âœ“ Client-specific price for ${clientName}`;
                    priceHint.classList.remove('text-gray-500');
                    priceHint.classList.add('text-green-400');
                } else {
                    priceHint.textContent = `Default product price (no client-specific price set)`;
                    priceHint.classList.remove('text-green-400');
                    priceHint.classList.add('text-gray-500');
                }
            } catch (error) {
                console.error('Error fetching price:', error);
                priceHint.textContent = 'Error fetching price';
            }
        }
        
        function submitProductionRun() {
            // Get values - prefer dropdown, fallback to manual
            const client = document.getElementById('run-client-select').value || 
                          document.getElementById('run-client-manual').value.trim();
            const product = document.getElementById('run-product-select').value || 
                           document.getElementById('run-product-manual').value.trim();
            const orderRef = document.getElementById('run-orderref-select').value || 
                            document.getElementById('run-orderref-manual').value.trim();
            const quantity = parseInt(document.getElementById('run-quantity').value) || 0;
            const pricePerRoll = parseFloat(document.getElementById('run-price-per-roll').value) || 0;
            const costPerRoll = parseFloat(document.getElementById('run-cost-per-roll').value) || 0;
            const etaMonth = document.getElementById('run-eta-month').value;
            const dateOrdered = document.getElementById('run-date-ordered').value;
            const notes = document.getElementById('run-notes').value.trim();
            
            if (!client) {
                alert('Please select or enter a client name');
                return;
            }
            
            const data = {
                client,
                product,
                order_ref: orderRef,
                quantity,
                price_per_roll: pricePerRoll,
                cost_per_roll: costPerRoll,
                eta_month: etaMonth,
                date_ordered: dateOrdered,
                notes
            };
            
            if (editingRunId) {
                // Update existing run
                updateProductionRun(editingRunId, data);
                editingRunId = null;
            } else {
                // Create new run
                data.status = 'pending';
                saveProductionRun(data);
            }
            
            closeAddRunModal();
        }
        
        // Products Management
        let clientPricesList = [];
        
        function openManageProductsModal() {
            document.getElementById('manage-products-modal').classList.remove('hidden');
            renderProductsList();
            loadClientPricesDropdowns();
            loadClientPrices();
        }
        
        function closeManageProductsModal() {
            document.getElementById('manage-products-modal').classList.add('hidden');
            // Refresh dropdowns
            populateRunDropdowns();
        }
        
        async function loadClientPricesDropdowns() {
            // Populate client dropdown
            const clientSelect = document.getElementById('client-price-client');
            clientSelect.innerHTML = '<option value="">Select Client...</option>';
            clientsList.forEach(c => {
                clientSelect.innerHTML += `<option value="${c.id}">${escapeHtml(c.name)}</option>`;
            });
            
            // Populate product dropdown
            const productSelect = document.getElementById('client-price-product');
            productSelect.innerHTML = '<option value="">Select Product...</option>';
            productsList.forEach(p => {
                productSelect.innerHTML += `<option value="${p.id}">${escapeHtml(p.name)}</option>`;
            });
        }
        
        async function loadClientPrices() {
            try {
                const response = await fetch('/api/production/client-prices');
                clientPricesList = await response.json();
                renderClientPricesList();
            } catch (error) {
                console.error('Error loading client prices:', error);
            }
        }
        
        function renderClientPricesList() {
            const container = document.getElementById('client-prices-list');
            if (clientPricesList.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm text-center py-2">No client-specific prices set. Use default product prices.</p>';
                return;
            }
            container.innerHTML = clientPricesList.map(cp => `
                <div class="bg-gray-800 rounded px-3 py-2 flex items-center justify-between">
                    <div class="flex-1 text-sm">
                        <span class="text-blue-400">${escapeHtml(cp.client_name)}</span>
                        <span class="text-gray-500 mx-2">â†’</span>
                        <span class="text-purple-400">${escapeHtml(cp.product_name)}</span>
                        <span class="text-green-400 ml-2">â‚¬${(cp.price || 0).toFixed(2)}</span>
                    </div>
                    <button onclick="deleteClientPrice(${cp.id})" class="text-red-400 hover:text-red-300 px-2" title="Delete">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }
        
        async function addClientPrice() {
            const clientId = document.getElementById('client-price-client').value;
            const productId = document.getElementById('client-price-product').value;
            const price = parseFloat(document.getElementById('client-price-value').value) || 0;
            
            if (!clientId || !productId) {
                alert('Please select both client and product');
                return;
            }
            
            try {
                await fetch('/api/production/client-prices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ client_id: clientId, product_id: productId, price })
                });
                
                document.getElementById('client-price-value').value = '';
                await loadClientPrices();
            } catch (error) {
                console.error('Error adding client price:', error);
            }
        }
        
        async function deleteClientPrice(id) {
            if (!confirm('Delete this client-specific price?')) return;
            try {
                await fetch(`/api/production/client-prices/${id}`, { method: 'DELETE' });
                await loadClientPrices();
            } catch (error) {
                console.error('Error deleting client price:', error);
            }
        }
        
        function renderProductsList() {
            const container = document.getElementById('products-list');
            if (productsList.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No products yet. Add one above.</p>';
                return;
            }
            container.innerHTML = productsList.map(p => `
                <div class="bg-gray-800 rounded-lg px-3 py-2 mb-2">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <span class="text-white font-medium">${escapeHtml(p.name)}</span>
                            <span class="text-gray-500 text-xs ml-2">(Set prices per client below)</span>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="editProduct(${p.id})" class="text-blue-400 hover:text-blue-300 px-2" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteProduct(${p.id})" class="text-red-400 hover:text-red-300 px-2" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    ${p.description ? `<p class="text-gray-400 text-xs mt-1">${escapeHtml(p.description)}</p>` : ''}
                    ${p.notes ? `<p class="text-yellow-400 text-xs mt-1"><i class="fas fa-sticky-note mr-1"></i>${escapeHtml(p.notes)}</p>` : ''}
                </div>
            `).join('');
        }
        
        async function addNewProduct() {
            const name = document.getElementById('new-product-name').value.trim();
            if (!name) {
                alert('Please enter a product name');
                return;
            }
            const description = document.getElementById('new-product-description').value.trim();
            const notes = document.getElementById('new-product-notes').value.trim();
            try {
                const res = await fetch('/api/production/products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description, notes })
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('new-product-name').value = '';
                    document.getElementById('new-product-description').value = '';
                    document.getElementById('new-product-notes').value = '';
                    await loadProductsAndClients();
                    renderProductsList();
                } else {
                    alert(data.error || 'Failed to add product');
                }
            } catch (error) {
                console.error('Error adding product:', error);
                alert('Failed to add product');
            }
        }
        
        let editingProductId = null;
        
        function editProduct(id) {
            const product = productsList.find(p => p.id === id);
            if (!product) return;
            
            editingProductId = id;
            document.getElementById('new-product-name').value = product.name || '';
            document.getElementById('new-product-description').value = product.description || '';
            document.getElementById('new-product-notes').value = product.notes || '';
            
            // Change button to update mode
            const addBtn = document.querySelector('#manage-products-modal button[onclick="addNewProduct()"]');
            addBtn.innerHTML = '<i class="fas fa-save"></i>';
            addBtn.setAttribute('onclick', 'saveProductEdit()');
        }
        
        async function saveProductEdit() {
            if (!editingProductId) return;
            
            const name = document.getElementById('new-product-name').value.trim();
            if (!name) {
                alert('Please enter a product name');
                return;
            }
            const description = document.getElementById('new-product-description').value.trim();
            const notes = document.getElementById('new-product-notes').value.trim();
            
            try {
                await fetch(`/api/production/products/${editingProductId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description, notes })
                });
                
                // Reset form
                document.getElementById('new-product-name').value = '';
                document.getElementById('new-product-description').value = '';
                document.getElementById('new-product-notes').value = '';
                editingProductId = null;
                
                // Reset button
                const addBtn = document.querySelector('#manage-products-modal button[onclick="saveProductEdit()"]');
                addBtn.innerHTML = '<i class="fas fa-plus"></i>';
                addBtn.setAttribute('onclick', 'addNewProduct()');
                
                await loadProductsAndClients();
                renderProductsList();
            } catch (error) {
                console.error('Error updating product:', error);
                alert('Failed to update product');
            }
        }
        
        async function deleteProduct(id) {
            if (!confirm('Delete this product?')) return;
            try {
                await fetch(`/api/production/products/${id}`, { method: 'DELETE' });
                await loadProductsAndClients();
                renderProductsList();
            } catch (error) {
                console.error('Error deleting product:', error);
            }
        }
        
        // Clients Management
        function openManageClientsModal() {
            document.getElementById('manage-clients-modal').classList.remove('hidden');
            renderClientsList();
        }
        
        function closeManageClientsModal() {
            document.getElementById('manage-clients-modal').classList.add('hidden');
            // Refresh dropdowns
            populateRunDropdowns();
        }
        
        function renderClientsList() {
            const container = document.getElementById('clients-list');
            if (clientsList.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No clients yet. Add one above.</p>';
                return;
            }
            container.innerHTML = clientsList.map(c => `
                <div class="flex items-center justify-between bg-gray-800 rounded-lg px-3 py-2">
                    <div class="flex items-center gap-2">
                        <span class="text-white">${escapeHtml(c.name)}</span>
                        ${c.country ? `<span class="text-xs px-1.5 py-0.5 bg-gray-700 rounded text-gray-400">${escapeHtml(c.country)}</span>` : ''}
                    </div>
                    <button onclick="deleteClient(${c.id})" class="text-red-400 hover:text-red-300 px-2" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }
        
        async function addNewClient() {
            const name = document.getElementById('new-client-name').value.trim();
            if (!name) {
                alert('Please enter a client name');
                return;
            }
            const country = document.getElementById('new-client-country').value;
            try {
                const res = await fetch('/api/production/clients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, country })
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('new-client-name').value = '';
                    document.getElementById('new-client-country').value = '';
                    await loadProductsAndClients();
                    renderClientsList();
                } else {
                    alert(data.error || 'Failed to add client');
                }
            } catch (error) {
                console.error('Error adding client:', error);
                alert('Failed to add client');
            }
        }
        
        async function deleteClient(id) {
            if (!confirm('Delete this client?')) return;
            try {
                await fetch(`/api/production/clients/${id}`, { method: 'DELETE' });
                await loadProductsAndClients();
                renderClientsList();
            } catch (error) {
                console.error('Error deleting client:', error);
            }
        }
        
        async function saveProductionRun(data) {
            try {
                await fetch('/api/production/runs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                loadProductionData();
            } catch (error) {
                console.error('Error saving production run:', error);
                alert('Failed to save production run');
            }
        }
        
        async function deleteProductionRun(id) {
            if (!confirm('Delete this production run?')) return;
            try {
                await fetch(`/api/production/runs/${id}`, { method: 'DELETE' });
                loadProductionData();
            } catch (error) {
                console.error('Error deleting run:', error);
            }
        }
        
        // View pro forma invoice by reference number
        async function viewProformaByRef(orderRef) {
            try {
                const response = await fetch('/api/proforma/list');
                const proformas = await response.json();
                
                // Find proforma matching the order reference
                const match = proformas.find(pf => 
                    pf.invoice_number === orderRef || 
                    pf.invoice_number.includes(orderRef) ||
                    orderRef.includes(pf.invoice_number)
                );
                
                if (match) {
                    window.open(`/proforma?id=${match.id}`, '_blank');
                } else {
                    alert(`No pro forma invoice found matching reference: ${orderRef}`);
                }
            } catch (error) {
                console.error('Error finding proforma:', error);
                alert('Error searching for pro forma invoice');
            }
        }
        
        // View product details modal
        function viewProductDetails(productName) {
            const product = productsList.find(p => p.name === productName);
            if (!product) {
                alert(`Product "${productName}" not found in products list.`);
                return;
            }
            
            // Show product details in a modal/alert
            const details = `
Product: ${product.name}
Description: ${product.description || 'N/A'}
Notes: ${product.notes || 'N/A'}
(Pricing is set per client in Manage Products)
            `.trim();
            
            if (confirm(details + '\n\nClick OK to edit this product, Cancel to close.')) {
                openManageProductsModal();
                loadProductsAndClients().then(() => {
                    renderProductsList();
                    editProduct(product.id);
                });
            }
        }
        
        let editingRunId = null;
        
        function editProductionRun(id) {
            const run = productionRuns.find(r => r.id === id);
            if (!run) return;
            
            editingRunId = id;
            
            // Load data and populate dropdowns
            loadProductsAndClients().then(() => {
                populateRunDropdowns();
                
                // Set values from existing run
                document.getElementById('run-client-select').value = run.client || '';
                document.getElementById('run-client-manual').value = '';
                document.getElementById('run-product-select').value = run.product || '';
                document.getElementById('run-product-manual').value = '';
                document.getElementById('run-orderref-select').value = run.order_ref || '';
                document.getElementById('run-orderref-manual').value = '';
                document.getElementById('run-quantity').value = run.quantity || '';
                document.getElementById('run-price-per-roll').value = run.price_per_roll || '';
                document.getElementById('run-cost-per-roll').value = run.cost_per_roll || '';
                document.getElementById('run-eta-month').value = run.eta_month || '';
                document.getElementById('run-date-ordered').value = run.date_ordered || '';
                document.getElementById('run-notes').value = run.notes || '';
                
                // Update price hint
                if (run.price_per_roll) {
                    document.getElementById('price-source-hint').textContent = 'Current saved price';
                    document.getElementById('price-source-hint').classList.remove('text-green-400');
                    document.getElementById('price-source-hint').classList.add('text-gray-500');
                }
                
                // If values not in dropdown, put in manual field
                if (run.client && !clientsList.find(c => c.name === run.client)) {
                    document.getElementById('run-client-manual').value = run.client;
                }
                if (run.product && !productsList.find(p => p.name === run.product)) {
                    document.getElementById('run-product-manual').value = run.product;
                }
                if (run.order_ref && !proformaList.find(pf => pf.invoice_number === run.order_ref)) {
                    document.getElementById('run-orderref-manual').value = run.order_ref;
                }
            });
            
            document.getElementById('add-run-modal').classList.remove('hidden');
        }
        
        async function updateProductionRun(id, data) {
            try {
                await fetch(`/api/production/runs/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                loadProductionData();
            } catch (error) {
                console.error('Error updating run:', error);
            }
        }
        
        // ========== FILE UPLOAD FUNCTIONS ==========
        let currentFeedbackId = null;
        let productionFiles = [];
        
        // Feedback image upload
        function openFeedbackImageUpload(feedbackId) {
            currentFeedbackId = feedbackId;
            document.getElementById('feedback-file-input').click();
        }
        
        async function uploadFeedbackFile(event) {
            const file = event.target.files[0];
            if (!file || !currentFeedbackId) return;
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('feedback_id', currentFeedbackId);
            
            try {
                const response = await fetch('/api/production/feedback/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    loadProductionData();
                } else {
                    alert('Failed to upload image');
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed');
            }
            
            event.target.value = '';
        }
        
        // Production files upload
        function openUploadProductionFile() {
            // Populate client dropdown from existing runs
            const select = document.getElementById('upload-client-select');
            const clients = [...new Set(productionRuns.map(r => r.client).filter(c => c))];
            select.innerHTML = '<option value="">Select client...</option>' +
                clients.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
            
            document.getElementById('upload-file-desc').value = '';
            document.getElementById('production-upload-modal').classList.remove('hidden');
        }
        
        function closeProductionUploadModal() {
            document.getElementById('production-upload-modal').classList.add('hidden');
        }
        
        function triggerProductionFileUpload() {
            const client = document.getElementById('upload-client-select').value;
            if (!client) {
                alert('Please select a client');
                return;
            }
            document.getElementById('production-file-input').click();
        }
        
        async function uploadProductionFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const client = document.getElementById('upload-client-select').value;
            const description = document.getElementById('upload-file-desc').value;
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('client', client);
            formData.append('description', description);
            
            try {
                const response = await fetch('/api/production/files/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    closeProductionUploadModal();
                    loadProductionFiles();
                    alert('File uploaded successfully!');
                } else {
                    alert('Failed to upload file');
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed');
            }
            
            event.target.value = '';
        }
        
        async function loadProductionFiles() {
            const clientFilter = document.getElementById('production-files-client')?.value || '';
            
            try {
                const response = await fetch(`/api/production/files?client=${encodeURIComponent(clientFilter)}`);
                productionFiles = await response.json();
                renderProductionFiles();
                
                // Update client dropdown using clientsList from database
                const select = document.getElementById('production-files-client');
                if (select) {
                    const current = select.value;
                    select.innerHTML = '<option value="">All Clients</option>' +
                        clientsList.map(c => `<option value="${escapeHtml(c.name)}" ${c.name === current ? 'selected' : ''}>${escapeHtml(c.name)}</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading production files:', error);
            }
        }
        
        function renderProductionFiles() {
            const container = document.getElementById('production-files-list');
            if (!productionFiles || productionFiles.length === 0) {
                container.innerHTML = `<div class="p-4 text-center text-gray-400">
                    <i class="fas fa-folder text-3xl mb-2"></i>
                    <p class="text-sm">No production files yet</p>
                </div>`;
                return;
            }
            
            // Sort by client
            const sorted = [...productionFiles].sort((a, b) => (a.client || '').localeCompare(b.client || ''));
            
            // Group by client
            const byClient = {};
            sorted.forEach(f => {
                const client = f.client || 'Uncategorized';
                if (!byClient[client]) byClient[client] = [];
                byClient[client].push(f);
            });
            
            container.innerHTML = Object.entries(byClient).map(([client, files]) => `
                <div class="mb-4">
                    <h4 class="text-sm font-semibold text-gray-300 mb-2 px-2">${escapeHtml(client)}</h4>
                    <div class="space-y-1">
                        ${files.map(f => {
                            const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(f.filename);
                            const isPdf = /\.pdf$/i.test(f.filename);
                            return `
                            <div class="flex items-center gap-3 p-2 bg-gray-700 rounded hover:bg-gray-600 group">
                                <div class="w-8 h-8 flex-shrink-0 flex items-center justify-center rounded ${isImage ? 'bg-blue-900' : isPdf ? 'bg-red-900' : 'bg-gray-800'}">
                                    <i class="fas ${isImage ? 'fa-image text-blue-400' : isPdf ? 'fa-file-pdf text-red-400' : 'fa-file text-gray-400'}"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <a href="#" onclick="openProductionFile('${escapeHtml(f.path)}'); return false;" class="text-sm text-white hover:text-blue-400 truncate block">${escapeHtml(f.filename)}</a>
                                    ${f.description ? `<p class="text-xs text-gray-500 truncate">${escapeHtml(f.description)}</p>` : ''}
                                </div>
                                <button onclick="deleteProductionFile(${f.id})" class="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-300 px-2" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        function viewProductionFile(path) {
            window.open(path, '_blank');
        }
        
        async function openProductionFile(path) {
            // Try to open in Finder via backend API
            try {
                const response = await fetch('/api/open-file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: path })
                });
                const data = await response.json();
                if (!data.success) {
                    // Fallback: open in browser
                    window.open(path, '_blank');
                }
            } catch (error) {
                // Fallback: open in browser
                window.open(path, '_blank');
            }
        }
        
        // Keep this for backwards compatibility
        function oldRenderProductionFiles() {
            const container = document.getElementById('production-files-list');
            container.innerHTML = productionFiles.map(f => {
                const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(f.filename);
                return `
                    <div class="bg-gray-700 rounded-lg p-2 hover:bg-gray-600 cursor-pointer group relative" onclick="viewProductionFile('${f.path}')">
                        ${isImage ? 
                            `<img src="${f.path}" class="w-full h-20 object-cover rounded mb-1">` :
                            `<div class="w-full h-20 bg-gray-800 rounded flex items-center justify-center mb-1"><i class="fas fa-file text-2xl text-gray-500"></i></div>`
                        }
                        <p class="text-xs text-gray-300 truncate">${escapeHtml(f.filename)}</p>
                        <p class="text-xs text-gray-500 truncate">${escapeHtml(f.client || '')}</p>
                        <button onclick="event.stopPropagation(); deleteProductionFile(${f.id})" 
                            class="absolute top-1 right-1 hidden group-hover:block text-red-400 hover:text-red-300 bg-gray-900/80 rounded p-1">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        function viewProductionFile(path) {
            window.open(path, '_blank');
        }
        
        async function deleteProductionFile(id) {
            if (!confirm('Delete this file?')) return;
            try {
                await fetch(`/api/production/files/${id}`, { method: 'DELETE' });
                loadProductionFiles();
            } catch (error) {
                console.error('Error deleting file:', error);
            }
        }
        
        // Organization file upload
        function openOrgFileUpload(domain, name) {
            document.getElementById('upload-org-domain').value = domain;
            document.getElementById('upload-org-name').textContent = `Upload file for: ${name}`;
            document.getElementById('upload-org-file-desc').value = '';
            document.getElementById('org-upload-modal').classList.remove('hidden');
        }
        
        function closeOrgUploadModal() {
            document.getElementById('org-upload-modal').classList.add('hidden');
        }
        
        function triggerOrgFileUpload() {
            document.getElementById('org-file-input').click();
        }
        
        async function uploadOrgFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const domain = document.getElementById('upload-org-domain').value;
            const description = document.getElementById('upload-org-file-desc').value;
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('domain', domain);
            formData.append('description', description);
            
            try {
                const response = await fetch('/api/organization/files/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    closeOrgUploadModal();
                    // Refresh org files view if open
                    if (typeof loadOrgFiles === 'function') {
                        loadOrgFiles(domain);
                    }
                    alert('File uploaded successfully!');
                } else {
                    alert('Failed to upload file');
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed');
            }
            
            event.target.value = '';
        }
    </script>

    <!-- Invoice Rules Modal -->
    <div id="invoice-rules-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeInvoiceRules()"></div>
        <div class="relative max-w-4xl mx-auto my-8 bg-gray-900 border border-gray-700 rounded-2xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-800">
                <div>
                    <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                        <i class="fas fa-info-circle text-blue-400"></i>
                        Invoice Tab Rules
                    </h3>
                    <p class="text-sm text-gray-400">Auto-detection criteria for each tab. Manual assignments override auto-detection.</p>
                </div>
                <button onclick="closeInvoiceRules()" class="text-gray-400 hover:text-white transition">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto flex-1" style="max-height: calc(90vh - 100px);">
                <div class="bg-gray-800 border border-gray-700 rounded-xl p-4">
                    <h4 class="text-white font-semibold mb-2 flex items-center gap-2"><i class="fas fa-paperclip text-green-400"></i>All Attachments</h4>
                    <ul class="text-sm text-gray-300 list-disc pl-5 space-y-1">
                        <li>Shows every non-hidden PDF attachment from the archive.</li>
                        <li>Use the hide/assign controls to manage where a file appears.</li>
                    </ul>
                </div>
                <div class="bg-gray-800 border border-gray-700 rounded-xl p-4">
                    <h4 class="text-white font-semibold mb-2 flex items-center gap-2"><i class="fas fa-file-invoice text-green-300"></i>My Invoices (DFW)</h4>
                    <ul class="text-sm text-gray-300 list-disc pl-5 space-y-1">
                        <li>Invoices issued by DFW Professional SRL with <strong>"INVOICE No"</strong> or <strong>"FACTURA FISCALÄ‚"</strong> format.</li>
                        <li>Both INVOICE and FACTURA represent the same thing - official invoices from DFW.</li>
                        <li><strong>Excludes:</strong> PROFORMA, Rohel Trans transport invoices, payment orders, CMR docs.</li>
                    </ul>
                </div>
                <div class="bg-gray-800 border border-gray-700 rounded-xl p-4">
                    <h4 class="text-white font-semibold mb-2 flex items-center gap-2"><i class="fas fa-tape text-blue-300"></i>JTape</h4>
                    <ul class="text-sm text-gray-300 list-disc pl-5 space-y-1">
                        <li>JTape purchase orders or invoices with "JTape", "J-Tape", or J-prefixed order numbers.</li>
                        <li>Captures large JTape PO batches (J-### or ROREX references).</li>
                    </ul>
                </div>
                <div class="bg-gray-800 border border-gray-700 rounded-xl p-4">
                    <h4 class="text-white font-semibold mb-2 flex items-center gap-2"><i class="fas fa-box text-orange-300"></i>Amba / BAXT</h4>
                    <ul class="text-sm text-gray-300 list-disc pl-5 space-y-1">
                        <li>Documents mentioning Amba Group or BAXT (POs, invoices, proformas).</li>
                        <li>Matches PO formats like <strong>PO-XXXX</strong> or "Order No ######".</li>
                        <li><strong>Excludes:</strong> packing lists, Rohel transport, CMRs, courier labels, DTC5 design files, CDS import summaries, transaction confirmations.</li>
                    </ul>
                </div>
                <div class="bg-gray-800 border border-gray-700 rounded-xl p-4">
                    <h4 class="text-white font-semibold mb-2 flex items-center gap-2"><i class="fas fa-truck-loading text-cyan-300"></i>Supplier (Rotopak IKE)</h4>
                    <ul class="text-sm text-gray-300 list-disc pl-5 space-y-1">
                        <li>Rotopak IKE invoices starting with <strong>"Î¤Î™Îœ"</strong> or <strong>"Î”Î‘"</strong>.</li>
                        <li>Focuses on supplier-issued invoices from the Rotopak mailbox.</li>
                    </ul>
                </div>
                <div class="bg-gray-800 border border-gray-700 rounded-xl p-4">
                    <h4 class="text-white font-semibold mb-2 flex items-center gap-2"><i class="fas fa-calculator text-pink-300"></i>Contrast Accounting</h4>
                    <ul class="text-sm text-gray-300 list-disc pl-5 space-y-1">
                        <li>Romanian <strong>"FACTURA FISCALÄ‚"</strong> from Contrast Accountancy SRL (4-digit invoice numbers).</li>
                        <li>SmartTax/GITS/OSR statements and emails from georgegologan@gmail.com with "DFW ####" filenames.</li>
                        <li><strong>Excludes:</strong> Rohel transport invoices unless manually assigned.</li>
                    </ul>
                </div>
                <div class="bg-gray-800 border border-gray-700 rounded-xl p-4">
                    <h4 class="text-white font-semibold mb-2 flex items-center gap-2"><i class="fas fa-file-alt text-yellow-300"></i>Pro Forma</h4>
                    <ul class="text-sm text-gray-300 list-disc pl-5 space-y-1">
                        <li>All documents labeled "PROFORMA" or "PRO FORMA" in text or filename.</li>
                        <li>Use for quotes or pre-invoice paperwork before official billing.</li>
                    </ul>
                </div>
                <p class="text-xs text-gray-500 pt-2">To override a rule, use the Assign dropdown in All Attachments. Your choice is saved to the database.</p>
            </div>
        </div>
    </div>

    <!-- Organization Files Modal -->
    <div id="org-files-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeOrgFilesModal()"></div>
        <div class="relative max-w-3xl mx-auto my-8 bg-gray-900 border border-gray-700 rounded-2xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-800">
                <div>
                    <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                        <i class="fas fa-folder-open text-blue-400"></i>
                        <span id="org-files-title">Organization Files</span>
                    </h3>
                    <p class="text-sm text-gray-400">Manage files associated with this organization</p>
                </div>
                <button onclick="closeOrgFilesModal()" class="text-gray-400 hover:text-white transition">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="mb-4 flex gap-2 flex-wrap">
                    <button onclick="openOrgFileUpload(currentOrgDomain, document.getElementById('org-files-title').textContent.replace('Files for ', ''))" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-medium flex items-center gap-2">
                        <i class="fas fa-upload"></i>
                        <span>Upload File</span>
                    </button>
                    <button onclick="linkAttachmentToOrg()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium flex items-center gap-2">
                        <i class="fas fa-link"></i>
                        <span>Link Attachment</span>
                    </button>
                </div>
                <div id="org-files-list" class="space-y-3">
                    <!-- Files will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</body>
</html>
